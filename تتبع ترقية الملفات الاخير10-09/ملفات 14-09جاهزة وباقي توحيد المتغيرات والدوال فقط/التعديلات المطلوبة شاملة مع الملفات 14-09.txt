ÙÙŠ ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±ÙÙ‚Ù‡ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ØªÙˆØ§Ù„ ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ù‡ ÙˆØ§Ù„Ù…ØªØ¹Ø§Ø±Ø¶Ù‡ Ù‚Ù…Øª Ø¨Ø§Ù†Ø´Ø§Ø¡ Ù…Ù„Ù
; purchases_alamin5-copy5\src\utils\calculation.ts
Ø¨ØºØ±Ø¶ ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠÙ‡ 

ÙˆØ§Ù„Ù…Ø·Ù„ÙˆØ¨


Ø§Ø±ÙŠØ¯ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆÙØ­Øµ Ø¯Ù‚ÙŠÙ‚ Ù„Ø£ÙƒÙˆØ§Ø¯ ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø§Ø®Ø¨Ø§Ø±ÙŠ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ§Ù„ÙŠØ©

1- Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ù„Ù calculation
 Ø³ÙˆÙ ÙŠØ­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ùˆ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ø§Ùˆ Ù…ØªØ¹Ø§Ø±Ø¶Ø© Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ Ù„Ø§ Ø§Ù„Ø­ØµØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠ
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶(Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶)
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶
(Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨) (Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶)
- Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ(Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©*Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù)
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)(Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶)
- Ø§Ù„Ù…Ø¨Ù„Øº (Ø±Ù‚Ù…Ø§Ù‹ Ø¨Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶)
- Ø§Ù„Ù…Ø¨Ù„Øº (ÙƒØªØ§Ø¨Ø© Ø¨Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶)
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡:
Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ (Ø±Ù‚Ù…Ø§Ù‹)
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡:
Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ (ÙƒØªØ§Ø¨Ø©Ù‹)

- Ø§Ù„Ù…Ø¨Ø§Ù„Øº ÙÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ±Ø³ÙŠØ© 
- Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© (Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©)
- Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© (Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„)
- Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© (Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©)
-  Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ù„ÙˆØ­Ø¯Ø© (Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© )
2 - ÙƒÙŠÙ ÙŠÙ…ÙƒÙ† ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© 
3-ØªØµØ­ÙŠØ­ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±: ÙÙŠ Ø¬Ø¯ÙˆÙ„ "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª" Ù„ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ÙØ§Ø±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…  Ù„Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
3- ØªÙ‚Ø¯ÙŠÙ… Ù…Ù‚ØªØ±Ø­Ø§ØªÙƒ (Ø§Ù† ÙˆØ¬Ø¯Øª) Ø­ÙˆÙ„ ÙƒÙŠÙÙŠØ© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§ÙƒÙˆØ§Ø¯ Ù…Ø¹ Ø´Ø±ÙˆØ­Ø§ØªÙƒ ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ø§ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¶Ø§ÙØ© Ø§Ùˆ Ø­Ø°Ù Ø§Ùˆ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©
4- Ø§Ù„Ù…Ø­Ø§ÙØ¸Ù‡ Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª  Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø¶Ø§ÙØ© Ø§ÙŠ ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØªÙˆØ¶ÙŠØ­ÙŠØ©


Ø£ÙˆÙ„Ø§ Ù…Ù„Ù ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ§Ù„ 
; ===================================
; purchases_alamin5-copy5\src\utils\calculation.ts
; ===================================
// Ù…Ù„Ù Ù…Ø®ØµØµ Ù„Ù„Ø¯ÙˆØ§Ù„ Ø§Ù…ØªÙƒØ±Ø±Ø© Ù„ØªÙˆØ­ÙŠØ¯Ù‡Ø§ 


/**
 * Ù…Ù„Ù util Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
 * ÙŠØ­ÙˆÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª
 */

/////////////////////
// ğŸŸ¢ Ø§Ù„Ø«ÙˆØ§Ø¨Øª
/////////////////////

// Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø³Ø©)
export const TAX_RATE = 0.05; // 5% ÙƒÙ…Ø«Ø§Ù„

/////////////////////
// ğŸŸ¢ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
/////////////////////

/**
 * Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ (Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶)
 */
export function calculateOfferTotal(unitPrice: number, qty: number): number {
  return unitPrice * qty;
}

/**
 * Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¨Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶)
 */
export function calculateOfferTotalAfterTax(unitPrice: number, qty: number, taxRate: number = TAX_RATE): number {
  const subtotal = calculateOfferTotal(unitPrice, qty);
  return subtotal + subtotal * taxRate;
}

/**
 * Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ù…Ø¨Ù„Øº Ù…Ø¹ÙŠÙ† (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ùˆ ÙˆØ­Ø¯Ø©)
 */
export function calculateEquivalentInYR(amount: number, exchangeRate: number): number {
  return amount * exchangeRate;
}

/////////////////////
// ğŸŸ¢ Ø¯ÙˆØ§Ù„ Ù…Ø®ØµØµØ© Ù„Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª
/////////////////////

/**
 * Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)
 */
export function calculateAwardedTotalAfterTax(
  awardedItems: { unitPrice: number; qty: number }[],
  taxRate: number = TAX_RATE
): number {
  const subtotal = awardedItems.reduce((sum, item) => sum + calculateOfferTotal(item.unitPrice, item.qty), 0);
  return subtotal + subtotal * taxRate;
}

/**
 * Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„
 */
export function calculateTotalAwardedInYR(
  awardedItems: { unitPrice: number; qty: number; exchangeRate: number }[],
  taxRate: number = TAX_RATE
): number {
  const total = calculateAwardedTotalAfterTax(awardedItems, taxRate);
  const avgRate = awardedItems.length ? awardedItems[0].exchangeRate : 1;
  return calculateEquivalentInYR(total, avgRate);
}

/////////////////////
// ğŸŸ¢ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©
/////////////////////

/**
 * Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© (Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©)
 */
export function getEstimatedUnitCost(unitPrice: number): number {
  return unitPrice;
}

/**
 * Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„
 */
export function getEstimatedUnitCostInYR(unitPrice: number, exchangeRate: number): number {
  return unitPrice * exchangeRate;
}

/**
 * Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© (Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©)
 */
export function getTotalEstimatedCost(items: { unitPrice: number; qty: number }[]): number {
  return items.reduce((sum, item) => sum + calculateOfferTotal(item.unitPrice, item.qty), 0);
}

/**
 * Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„
 */
export function getTotalEstimatedCostInYR(items: { unitPrice: number; qty: number; exchangeRate: number }[]): number {
  const subtotal = getTotalEstimatedCost(items);
  const avgRate = items.length ? items[0].exchangeRate : 1;
  return calculateEquivalentInYR(subtotal, avgRate);
}

/////////////////////
// ğŸŸ¢ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª
/////////////////////

/**
 * Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
 */
export function calculatePriceDifferencePerUnit(
  estimatedUnitCost: number,
  offeredUnitPrice: number,
  exchangeRate: number
): number {
  return (estimatedUnitCost * exchangeRate) - (offeredUnitPrice * exchangeRate);
}

// ===============================
// Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„
export const formatAmountWithCommas = (amount: number): string => {
  return amount.toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
};

export const convertAmountToWords = (amount: number, currency: string = 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ'): string => {
  // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ Ù‡Ù†Ø§
  return `Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡ ${formatAmountWithCommas(amount)} ${currency}`;
};

; ===========================================================================

Ø«Ø§Ù†ÙŠØ§ ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ 
; ========================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø§ÙˆÙ„ ØµÙØ­Ø© 
// purchases_alamin5-copy5\src\types\index.ts
; ===========================================================================
export interface PurchaseOrderItem {
  poNumber: number;
  // ğŸŸ¢ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  code?: string;
  id: string;
  name: string;
  quantity: number;
  unit: string;
  selected: boolean;
  lineNumber: number; // Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø±

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

  estimatedCost?: {
    amount: number;
    currency: string;
    equivalentInYR?: number;
  };
  specifications?: {
    color?: string;
    type?: string;
    material?: string;
    // [key: string]: string;
    [key: string]: string | undefined;
  };
}

// ğŸŸ¢ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯: ØªØ¹Ø±ÙŠÙ Ø¨Ù†ÙŠØ© Ø£ØµÙ†Ø§Ù Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙƒÙ„ Ù…ÙˆØ±Ø¯
export interface OfferLineItem {
  specifications: any;
  itemId: string;           // Ù…Ø¹Ø±Ù Ø§Ù„ØµÙ†Ù Ø§Ù„Ø£ØµÙ„ÙŠ
  lineNumber: number;       // Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
  name: string;             // Ø¨ÙŠØ§Ù† Ø§Ù„ØµÙ†Ù
  unit: string;             // ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³
  requestedQty: number;     // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
  offeredQty: number;       // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯
  // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  // Ø³Ù†Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡ ÙƒØ³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØ³Ø§Ù‚ Ù…Ø¹ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø§Øª
  unitPrice: number;        // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)
  // Ø­Ù‚ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ø¯Ø¹Ù… Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙÙŠ ÙˆØ¶Ø¹ ØºÙŠØ± Ø´Ø§Ù…Ù„
  unitPriceBeforeTax?: number;   // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ Ø¹Ù†Ø¯ ØºÙŠØ± Ø´Ø§Ù…Ù„)
  unitPriceAfterTax?: number;    // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
  lineTotal: number;        // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø± (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©) = offeredQty * unitPrice
  lineTotalBeforeTax?: number; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
  lineTotalAfterTax?: number;  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
  awarded: boolean;         // Ù‡Ù„ ØªÙ… Ø§Ù„ØªØ±Ø³ÙŠØ© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± (Ù„Ù„ØªØ±Ø³ÙŠØ© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©)
  awardedQty?: number;      // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (Ù„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ØŒ ÙÙ‚Ø· Ø§Ù„ØªÙˆØµÙŠØ©)
  
  // ğŸŸ¢ Ø¬Ø¯ÙŠØ¯: Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø·Ø±
  lineNote?: string;        // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¶Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ±Ø¯
  
  // ğŸŸ¢ Ø¬Ø¯ÙŠØ¯: Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± (Ù†ÙØ³ Ù…ÙØ§ØªÙŠØ­ Ù…ÙˆØ§ØµÙØ§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡)
  // vendorSpecifications?: { [key: string]: string };

  // ğŸŸ¢ Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± (ØªÙØ¹Ø±Ø¶ ÙÙŠ Ø§Ù„ØªÙˆØµÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ±Ø³ÙŠØ©)
  commitment?: string;
  vendorSpecifications?: {
    color?: string;
    type?: string;
    material?: string;
    // [key: string]: string;
    [key: string]: string | undefined;
  };
  commitments?: string[];
}


export interface PriceOffer {
  totalAfterTax: undefined;  // Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
  totalAfterTaxInYR: undefined; // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
  notes: string;
  items: PriceOffer | undefined;
  id: string;
  vendor: string;
  offerNumber: string; // Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶
  amount: number;      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø³Ø·Ø± Ø§Ù„ØªØ±Ø³ÙŠØ©)
  // Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ©
  inputValue?: string;  // Ù„Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹
  currency: Currency;
  exchangeRate?: number;
  totalInYR?: number;  // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ 
  // ğŸŸ¢ ØªØºÙŠÙŠØ±: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø­Ø§Ù„Ø© "Ø§Ø®ØªØ±" Ø¹Ø¨Ø± Ù‚ÙŠÙ…Ø© null
  taxIncluded: boolean | null; // null = Ø§Ø®ØªØ±ØŒ true = Ø´Ø§Ù…Ù„ØŒ false = ØºÙŠØ± Ø´Ø§Ù…Ù„
  total: number; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø³Ø·Ø± Ø§Ù„ØªØ±Ø³ÙŠØ©)
  totalInWords: string;
  result: OfferResult;
  
  // ğŸŸ¢ Ø¬Ø¯ÙŠØ¯: Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
  offerNote?: string;         // Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ®Øµ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ±Ø¯ ÙƒÙƒÙ„

  // ğŸŸ¢ Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ (ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªÙˆØµÙŠØ© ØªØ­Øª Ø¥Ø¬Ù…Ø§Ù„ÙŠÙ‡)
  commitments?: string[];
  
  // ğŸŸ¢ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯: Ø£ØµÙ†Ø§Ù Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙƒÙ„ Ù…ÙˆØ±Ø¯
  lineItems?: OfferLineItem[];
}

export interface ExcludedOffer {
  id: string;
  vendor: string;
  reason: string;
  notes: string;
  // Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯  
  // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯
  // Ù…Ø«Ù„ 'Ù…Ø·Ø§Ø¨Ù‚' Ø£Ùˆ 'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚' Ø£Ùˆ 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ'
  result?: string; // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø·Ø±

}


// export interface RecommendationLineItem {
//   lineNumber: number;
//   name: string;
//   unit: string;
//   awardedQty: number;
//   unitPrice: number;
//   total: number;
//   commitments: string[];
// }


export interface RecommendedOffer {
  lineItems: any;
  totalInYR: number;
  vendor: string;
  amount: number;
  currency: string;
  amountInWords: string;
  manualAmount?: number; // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ø¯Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯
  isManualAmount?: boolean; // Ù‡Ù„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯
  // ğŸŸ¢ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯: Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ ØªÙ…Øª Ø§Ù„ØªØ±Ø³ÙŠØ© Ø¹Ù„ÙŠÙ‡Ø§ (Ù„Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ)
  awardedLineNumbers?: number[];
}

// ØªØ¹Ø±ÙŠÙØ§Øª Ø¬Ø¯ÙŠØ¯Ù‡ 
export interface PurchaseOrder {
  ponumber: string;
  vendorName: string;
  currencyCode: string;
  date?: Date;
  deliveryDate?: Date;
}
// =================

export interface Recommendation {
  selectedOffers: RecommendedOffer[]; // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§
  totalAwardedInYR?: number; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø³Ø§Ø© Ø¹Ù„ÙŠÙ‡ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ (Ø±Ù‚Ù…Ø§Ù‹)
  totalAwardedInYRWords?: string; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø³Ø§Ø© Ø¹Ù„ÙŠÙ‡ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ (ÙƒØªØ§Ø¨Ø©)
}

export type Currency = 'Ø±ÙŠØ§Ù„' | 'Ø¯ÙˆÙ„Ø§Ø±' | 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' | 'ÙŠÙˆØ±Ùˆ';
// export type OfferResult = 'Ù…Ø·Ø§Ø¨Ù‚' | 'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚' | 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ' |  '';
export type OfferResult = 'Ù…Ø·Ø§Ø¨Ù‚' | 'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚' | 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ' |  ''; // ğŸŸ¢ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© (Ø§Ø®ØªØ±)


; ================================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ 
// purchases_alamin5-copy5\src\context\PurchaseOrderContext.tsx
; ===================================================================================
import React, { createContext, ReactNode, useCallback, useContext, useState } from 'react';
import { ExcludedOffer, PriceOffer, PurchaseOrderItem, Recommendation, RecommendedOffer, PurchaseOrder } from '../types';
import { db } from '../utils/db';
import { convertNumberToArabicWords, formatNumberWithCommas } from '../utils/numberToWords';

// ========== Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ù‡0===============
// ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª (Interfaces) Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
interface PurchaseOrderContextType {
  // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  poNumber: string;
  setPoNumber: (poNumber: string) => void;
  transactionNumber: string;
  setTransactionNumber: (number: string) => void;
  // Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
  requesting: string;
  setRequesting: (requesting: string) => void;
  beneficiary: string;
  setBeneficiary: (beneficiary: string) => void;
  // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
  purchaseMethod: string;
  setPurchaseMethod: (purchaseMethod: string) => void;
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  poItems: PurchaseOrderItem[];                                        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù */
  setPoItems: (items: PurchaseOrderItem[]) => void;                    /* Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù */
  priceOffers: PriceOffer[];                                           /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ */
  setPriceOffers: (offers: PriceOffer[]) => void;                     /* Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ */
  excludedOffers: ExcludedOffer[];                                    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© */
  setExcludedOffers: (offers: ExcludedOffer[]) => void;                   /* Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© */
  recommendation: Recommendation | null;                                 /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØµÙŠØ§Øª */
  setRecommendation: (recommendation: Recommendation | null) => void;     /* Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØµÙŠØ§Øª */
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶
  isPreliminaryPrint: boolean;  // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  setIsPreliminaryPrint: (value: boolean) => void;
  offerCount: number; // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚
  setOfferCount: (count: number) => void;
  // Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  hasUnsavedChanges: boolean;  // Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©
  isDataSaved: boolean;  // Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©
  // Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯1 Ù„Ø§Ø¶Ø§ÙØ© PurchaseOrder  ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø®Ø§ØµÙŠØ© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ
  purchaseOrder: PurchaseOrder | null; // ğŸŸ¢ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
  loadPurchaseOrder: (data: any) => Promise<boolean>;  // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
  savePurchaseOrder: () => Promise<boolean>;  // Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
  clearAllFields: () => void;
  handlePoNumberChange: (newPoNumber: string) => void;
  // Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶
  updatePriceOffer: (vendor: string, updates: Partial<PriceOffer>) => void;
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©
  estimatedCosts: {[key: number]: number};
  setEstimatedCosts: (costs: {[key: number]: number}) => void;
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
  itemSpecifications: {[key: number]: string};
  setItemSpecifications: (specs: {[key: number]: string}) => void;
  // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§
  deletePurchaseOrderData: (poNum: string) => Promise<boolean>;
  checkDuplicatePurchaseOrder: (
    poNum: string,
    transNum: string
  ) => Promise<{ isDuplicate: boolean; message: string; dataExists: boolean }>;
  // Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
  calculateMaxOfferAmountInYR: () => number; // Ù„Ø­Ø³Ø§Ø¨ Ø£ÙƒØ¨Ø± Ù‚ÙŠÙ…Ø© Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ù„Ø¹Ø±ÙˆØ¶ (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©)
  calculateTotalAwardedInYR: () => number; // Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)
  getSalutationForPrint: () => string; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø¨ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  getSignatoryForPrint: () => string; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ø¨Øª
  shouldShowPreliminarySignature: () => boolean; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  shouldShowFinalSignature: () => boolean; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  // Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  generateVendorMessages: () => {
    awarded: { vendor: string; message: string }[];
    excluded: { vendor: string; message: string }[];
    financial: string;
  };
}

const PurchaseOrderContext = createContext<PurchaseOrderContextType | undefined>(undefined);

export const PurchaseOrderProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  const [poNumber, setPoNumberState] = useState<string>('');
  const [transactionNumber, setTransactionNumber] = useState<string>('');
  // Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
  const [requesting, setRequesting] = useState<string>('');
  const [beneficiary, setBeneficiary] = useState<string>('');
  // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
  const [purchaseMethod, setPurchaseMethod] = useState<string>('');
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©
  const [estimatedCosts, setEstimatedCosts] = useState<{[key: number]: number}>({});
  
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
  const [itemSpecifications, setItemSpecifications] = useState<{[key: number]: string}>({});
  // Ø­Ø§Ù„Ø© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
  // const [purchaseMethod, setPurchaseMethod] = useState<string>('');
  // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  const [poItems, setPoItems] = useState<PurchaseOrderItem[]>([]);  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù */
  // ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© purchaseOrder Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯2 
  const [purchaseOrder, setPurchaseOrder] = useState<PurchaseOrder | null>(null); // ğŸŸ¢ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
  const [priceOffers, setPriceOffers] = useState<PriceOffer[]>([]);  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ */
  const [excludedOffers, setExcludedOffers] = useState<ExcludedOffer[]>([]);   /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© */
  const [recommendation, setRecommendation] = useState<Recommendation | null>({ selectedOffers: [] });     /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØµÙŠØ§Øª */
  // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  const [isPreliminaryPrint, setIsPreliminaryPrint] = useState(false);
  const [offerCount, setOfferCount] = useState(3);
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [isDataSaved, setIsDataSaved] = useState(false);
  
  // ğŸŸ¢ 1. ØªØ¹Ø±ÙŠÙ clearAllFields Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø£Ù†Ù‡ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰
  const clearAllFields = useCallback(() => {
    setTransactionNumber(''); // Ù…Ø³Ø­ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
    setRequesting('');  // Ù…Ø³Ø­ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©
    setBeneficiary(''); // Ù…Ø³Ø­ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©
    setPurchaseMethod(''); // Ù…Ø³Ø­ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
    setPoItems([]); // Ù…Ø³Ø­ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    // âœ… Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù‡Ù†Ø§ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ ÙÙŠ PriceOffersSection
    setPriceOffers([]); // ØªÙ… ØªØ¹Ù„ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ÙŠÙØªØ­ Ø¹ 3 Ø¹Ø±ÙˆØ¶
    setExcludedOffers([]); // Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
    setRecommendation(null); // Ù…Ø³Ø­ Ø§Ù„ØªÙˆØµÙŠØ§Øª
    setIsPreliminaryPrint(false); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    setOfferCount(3); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    setHasUnsavedChanges(false); // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    setIsDataSaved(false); // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  }, []);
  
  // ğŸŸ¢ 2. ØªØ¹Ø±ÙŠÙ loadPurchaseOrder Ø¨Ø¹Ø¯ clearAllFields Ù„Ø£Ù†Ù‡ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ db ÙˆÙ‚Ø¨Ù„ handlePoNumberChange
  const loadPurchaseOrder = useCallback(
    async (data: any): Promise<boolean> => {
      try {
        setPoNumberState(data.po_number || data['Ø§Ù„Ø±Ù‚Ù…'] || '');
        setRequesting(data.requesting || data['Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©'] || '');  
        setBeneficiary(data.beneficiary || data['Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©'] || '');
        setPurchaseMethod(data.purchaseMethod || data['Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡'] || '');
        setTransactionNumber(data.transaction_number || data['Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©'] || '');
        const items = data.items || data['Ø§Ù„Ø£ØµÙ†Ø§Ù'] || [];
        setPoItems(
          items.map((item: any, index: number) => ({
            id: `item-${index}`,
            name: item.name || item['Ø§Ù„Ø¨ÙŠØ§Ù†'],
            quantity: item.quantity || item['Ø§Ù„ÙƒÙ…ÙŠØ©'],
            unit: item.unit || item['Ø§Ù„ÙˆØ­Ø¯Ø©'],
            lineNumber: item.lineNumber || item['Ø§Ù„Ø³Ø·Ø±'] || item['Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø±'] || index + 1,
            selected: true,
            // ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ù† ÙˆÙØ¬Ø¯Øª
            estimatedCost: item.estimatedCost || item['Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©'] || undefined,
            specifications: item.specifications || item['Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª'] || undefined, 
          }))
        );
        if (Array.isArray(data.price_offers)) {
          setPriceOffers(data.price_offers);
          setOfferCount(data.offer_count || data.price_offers.length || 3);
        } else {
          // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ø±ÙˆØ¶ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          setPriceOffers([]);
          setOfferCount(3);
        }
        if (Array.isArray(data.excluded_offers)) {
          setExcludedOffers(data.excluded_offers);
        } else {
          setExcludedOffers([]);
        }
        if (data.recommendation) {
          setRecommendation(data.recommendation);
        } else {
          setRecommendation({ selectedOffers: [] }); // Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù‚ÙŠÙ…Ø© null
        }
        setHasUnsavedChanges(true);
        setIsDataSaved(false);
        return true;
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
        return false;
      }
    },
    [] // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¥Ù„Ø§ db ÙˆØ§Ù„ØªÙŠ Ù„ÙŠØ³Øª Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø­Ø§Ù„Ø© React
  );
  
  // ğŸŸ¢ 3. ØªØ¹Ø±ÙŠÙ setPoNumberState (Ø¯Ø§Ø®Ù„ÙŠ)
  const setPoNumber = useCallback(
    (newPoNumber: string) => {
      setPoNumberState(newPoNumber);
    },
    []
  );
  
  // ğŸŸ¢ 4. ØªØ¹Ø±ÙŠÙ handlePoNumberChange Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ù‡Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… loadPurchaseOrder Ùˆ clearAllFields Ø¨Ø£Ù…Ø§Ù†
  const handlePoNumberChange = useCallback(
    async (newPoNumber: string) => {
      setPoNumberState(newPoNumber); // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
      if (newPoNumber) {
        const existingData = await db.getPurchaseOrder(newPoNumber);
        if (existingData) {
          await loadPurchaseOrder(existingData); // ğŸŸ¢ Ø§Ù„Ø¢Ù† loadPurchaseOrder Ù…Ø¹Ø±ÙØ©
        } else {
          clearAllFields(); // ğŸŸ¢ ÙˆØ§Ù„Ø¢Ù† clearAllFields Ù…Ø¹Ø±ÙØ©
        }
      } else {
        clearAllFields();
      }
    },
    [clearAllFields, loadPurchaseOrder] // Ø¥Ø¶Ø§ÙØ© loadPurchaseOrder Ø¥Ù„Ù‰ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
  );
  
  // ğŸŸ¢ 8. ØªØ¹Ø±ÙŠÙ updatePriceOffer
  const updatePriceOffer = useCallback(
    (vendor: string, updates: Partial<PriceOffer>) => {
      setPriceOffers(prevOffers => 
        prevOffers.map(offer => 
          offer.vendor === vendor ? { ...offer, ...updates } : offer
        )
      );
      setHasUnsavedChanges(true);
    },
    []
  );
  
  // =============Ø¬Ø¯ÙŠØ¯=============================
  // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ø¢Ù…Ù†Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  // Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù Ø£Ùˆ ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨
  const safeSendMessage = (message: any) => {
    if (typeof chrome !== 'undefined' && chrome.runtime) {
      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù†ÙØ° Ù…ØªØµÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        if (chrome.runtime.id) {
          chrome.runtime.sendMessage(message);
          return true;
        }
      } catch (error) {
        console.error('Error sending message:', error);
        return false;
      }
    }
    return false;
  };
  
  // ========================================
  
  // ğŸŸ¢ 5. ØªØ¹Ø±ÙŠÙ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰
  const calculateMaxOfferAmountInYR = useCallback((): number => {
    // Ù„Ø­Ø³Ø§Ø¨ Ø£ÙƒØ¨Ø± Ù‚ÙŠÙ…Ø© Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ù„Ø¹Ø±ÙˆØ¶ (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©)
    // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø¹Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø­Ø§Ù„ØªÙ‡
    const amounts = priceOffers.map(offer => offer.totalInYR || 0);
    return amounts.length > 0 ? Math.max(...amounts) : 0;
  }, [priceOffers]);
  
  const calculateTotalAwardedInYR = useCallback((): number => {
    // Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)
    if (!recommendation || !recommendation.selectedOffers || recommendation.selectedOffers.length === 0) {
      return 0;
    }
    return recommendation.selectedOffers.reduce((sum, selectedOffer) => {
      const originalOffer = priceOffers.find(po => po.vendor === selectedOffer.vendor);
      if (originalOffer) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø¹Ø¯Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (selectedOffer.isManualAmount && selectedOffer.manualAmount !== undefined) {
          const exchangeRate = originalOffer.exchangeRate || 1;
          return sum + (selectedOffer.manualAmount * exchangeRate);
        } else {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹
          return sum + (originalOffer.totalInYR || 0);
        }
      }
      return sum;
    }, 0);
  }, [recommendation, priceOffers]);
  
  const getSalutationForPrint = useCallback((): string => {
    // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø¨ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
    const total = calculateTotalAwardedInYR();
    return total > 150000 ? 'Ø§Ù„Ø£Ø®/Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ' : 'Ø§Ù„Ø£Ø®/Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†';
  }, [calculateTotalAwardedInYR]);
  
  const getSignatoryForPrint = useCallback((): string => {
    // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ø¨Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
    const total = calculateTotalAwardedInYR();
    return total > 150000 ? 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ' : 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†';
  }, [calculateTotalAwardedInYR]);
  
  const shouldShowPreliminarySignature = useCallback((): boolean => {
    // Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø£ÙƒØ¨Ø± Ù‚ÙŠÙ…Ø© Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ù„Ø¹Ø±ÙˆØ¶
    const maxAmount = calculateMaxOfferAmountInYR();
    return maxAmount > 150000;
  }, [calculateMaxOfferAmountInYR]);
  
  const shouldShowFinalSignature = useCallback((): boolean => {
    // Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
    const total = calculateTotalAwardedInYR();
    return total > 150000;
  }, [calculateTotalAwardedInYR]);
  
  // ğŸŸ¢ 6. ØªØ¹Ø±ÙŠÙ savePurchaseOrder Ø¨Ø¹Ø¯ ØªØ¹Ø±ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§
  const savePurchaseOrder = useCallback(async (): Promise<boolean> => {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      if (!poNumber.trim()) {
        console.error('Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø­ÙØ¸');
        return false;
      }
      
      // âœ… ØªØ³Ø¬ÙŠÙ„ Ù…ÙØµÙ„ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸
      console.log('Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡:', poNumber);
      console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­ÙØ¸Ù‡Ø§:', {
        po_number: poNumber,
        transaction_number: transactionNumber,
        requesting,
        beneficiary,
        purchaseMethod,
        items_count: poItems.length,
        offers_count: priceOffers.length,
        excluded_count: excludedOffers.length
      });
      
      // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
      const validOffers = priceOffers.filter(offer => 
        offer.vendor && offer.vendor.trim() !== '' && offer.amount > 0
      );
      
      console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØµØ§Ù„Ø­Ø© Ù„Ù„Ø­ÙØ¸:', validOffers.length);
      
      // Ø§Ø­Ø³Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
      const awardedTotalYER = calculateTotalAwardedInYR();
      const nowIso = new Date().toISOString();
      
      // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
      const data = {
        po_number: poNumber,
        transaction_number: transactionNumber,
        requesting,
        beneficiary,
        purchaseMethod,
        items: poItems,
        // Ø§Ø­ÙØ¸ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„ÙƒÙ„ Ù…ÙˆØ±Ø¯ Ø¥Ù† ÙˆØ¬Ø¯Øª Ø¹Ø¨Ø± ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙƒÙ…Ø§ Ù‡ÙŠ
        price_offers: priceOffers.map(offer => {
          // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¢Ù…Ù†Ø© Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶
          const safeOffer = {
            ...offer,
            // âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
            amount: isNaN(Number(offer.amount)) ? 0 : Number(offer.amount),
            total: isNaN(Number(offer.total)) ? 0 : Number(offer.total),
            totalInYR: isNaN(Number(offer.totalInYR)) ? 0 : Number(offer.totalInYR),
            exchangeRate: isNaN(Number(offer.exchangeRate)) ? 1 : Number(offer.exchangeRate),
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† lineItems Ù…ØµÙÙˆÙØ© ØµØ§Ù„Ø­Ø©
            lineItems: Array.isArray(offer.lineItems) ? offer.lineItems : [],
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† commitments Ù…ØµÙÙˆÙØ© ØµØ§Ù„Ø­Ø©
            commitments: Array.isArray(offer.commitments) ? offer.commitments : [],
          };
          
          // Ø­Ø°Ù Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„
          delete (safeOffer as any).inputValue;
          
          return safeOffer;
        }),
        excluded_offers: excludedOffers,
        recommendation: recommendation ? { ...recommendation, totalAwardedInYR: awardedTotalYER } : null,
        offer_count: offerCount,
        date: nowIso,
        date_only: nowIso.slice(0, 10),
        time_only: nowIso.slice(11, 19),
        awarded_total_yer: awardedTotalYER,
        awarded_total_yer_words: convertNumberToArabicWords(awardedTotalYER, 'Ø±ÙŠØ§Ù„'),
      };
      
      console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø­ÙØ¸:', data);
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ù„Ø­ÙØ¸
      const saveMessage = {
        type: 'SAVE_PURCHASE_ORDER',
        data: data
      };
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©
      const messageSent = safeSendMessage(saveMessage);
      
      if (!messageSent) {
        console.warn('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©...');
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©: Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ localStorage Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§
        if (typeof localStorage !== 'undefined') {
          try {
            localStorage.setItem(`purchase_order_${poNumber}`, JSON.stringify(data));
            console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
          } catch (storageError) {
            console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage:', storageError);
          }
        }
      }
      
      // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠØ©
      const success = await db.savePurchaseOrder(data);
      
      if (success) {
        console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', poNumber);
        setHasUnsavedChanges(false);
        setIsDataSaved(true);
      } else {
        console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }
      
      return success;
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
      
      // âœ… ØªØ³Ø¬ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
      if (error instanceof Error) {
        console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.message);
        console.error('Stack trace:', error.stack);
      }
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ sessionStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      try {
        if (typeof sessionStorage !== 'undefined') {
          const backupData = {
            poNumber,
            transactionNumber,
            requesting,
            beneficiary,
            purchaseMethod,
            poItems,
            priceOffers,
            excludedOffers,
            recommendation,
            offerCount,
            timestamp: new Date().toISOString()
          };
          sessionStorage.setItem('purchase_order_backup', JSON.stringify(backupData));
          console.log('ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ sessionStorage');
        }
      } catch (backupError) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', backupError);
      }
      
      return false;
    }
  }, [poNumber, transactionNumber, requesting, beneficiary, purchaseMethod, poItems, priceOffers, excludedOffers, recommendation, offerCount, calculateTotalAwardedInYR, convertNumberToArabicWords, db.savePurchaseOrder]);
  
  // =================================================
  
  // ğŸŸ¢ 7. ØªØ¹Ø±ÙŠÙ deletePurchaseOrderData
  const deletePurchaseOrderData = useCallback(async (poNum: string): Promise<boolean> => {
    try {
      const success = await db.deletePurchaseOrder(poNum);
      if (success) {
        clearAllFields(); // ğŸŸ¢ Ø§Ù„Ø¢Ù† clearAllFields Ù…Ø¹Ø±ÙØ©
        setPoNumberState('');
        console.log(`Purchase order ${poNum} deleted successfully.`);
      }
      return success;
    } catch (error) {
      console.error('Error deleting purchase order:', error);
      return false;
    }
  }, [clearAllFields]); // Ø¥Ø¶Ø§ÙØ© clearAllFields Ø¥Ù„Ù‰ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
  
  // ğŸŸ¢ 8. ØªØ¹Ø±ÙŠÙ checkDuplicatePurchaseOrder
  const checkDuplicatePurchaseOrder = useCallback(
    async (
      poNum: string,
      transNum: string
    ): Promise<{ isDuplicate: boolean; message: string; dataExists: boolean }> => {
      const existingPO = await db.getPurchaseOrder(poNum);
      if (existingPO) {
        if (existingPO.transaction_number === transNum) {
          return {
            isDuplicate: true,
            message: 'Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŒ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.',
            dataExists: true,
          };
        } else {
          return {
            isDuplicate: false,
            message:
              'Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø®ØªÙ„Ù. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ ÙƒØ·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ (Ø¨Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯)ØŸ',
            dataExists: true,
          };
        }
      }
      return { isDuplicate: false, message: '', dataExists: false };
    },
    []
  );
  
  /**
   * Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©
   */
  const generateVendorMessages = useCallback(() => {
    const today = new Date().toLocaleDateString('ar-SA');
    const totalAwarded = calculateTotalAwardedInYR();
    
    // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ù…
    const awardedMessages = (recommendation?.selectedOffers || []).map(selectedOffer => {
      const offer = priceOffers.find(o => o.vendor === selectedOffer.vendor);
      let message = `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…\n\n`;
      message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}\n`;
      message += `Ø¥Ù„Ù‰: ${selectedOffer.vendor}\n`;
      message += `Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø³ÙŠØ© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber}\n\n`;
      message += `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒ\n\n`;
      message += `Ù†ØªØ´Ø±Ù Ø¨Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ø¨Ø£Ù†Ù‡ ØªÙ… Ø§Ù„ØªØ±Ø³ÙŠØ© Ø¹Ù„ÙŠÙƒÙ… ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber} `;
      message += `Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${beneficiary} Ø¨Ù…Ø¨Ù„Øº Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¯Ø±Ù‡ `;
      message += `${formatNumberWithCommas(selectedOffer.amount)} ${selectedOffer.currency}\n\n`;
      
      if (selectedOffer.awardedLineNumbers && selectedOffer.awardedLineNumbers.length > 0) {
        message += `Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§: ${selectedOffer.awardedLineNumbers.join(', ')}\n\n`;
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª
      if (offer?.commitments && offer.commitments.length > 0) {
        message += `Ù…Ø¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¢ØªÙŠ:\n`;
        offer.commitments.forEach((commitment, index) => {
          message += `${index + 1}. ${commitment}\n`;
        });
        message += `\n`;
      }
      
      message += `ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.\n\n`;
      message += `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ØŒ\n`;
      message += `Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†`;
      
      return { vendor: selectedOffer.vendor, message };
    });
    
    // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†
    const excludedMessages = priceOffers
      .filter(offer => offer.vendor && offer.result !== 'Ù…Ø·Ø§Ø¨Ù‚')
      .map(offer => {
        let message = `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…\n\n`;
        message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}\n`;
        message += `Ø¥Ù„Ù‰: ${offer.vendor}\n`;
        message += `Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¯Ù… ØªØ±Ø³ÙŠØ© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber}\n\n`;
        message += `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒ\n\n`;
        message += `Ù†Ø´ÙƒØ±ÙƒÙ… Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØªÙƒÙ… ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber} `;
        message += `Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${beneficiary}.\n\n`;
        message += `Ù†Ø£Ø³Ù Ù„Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ø¨Ø£Ù†Ù‡ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ±Ø³ÙŠØ© Ø¹Ù„ÙŠÙƒÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ `;
        message += `Ù„Ø£Ø³Ø¨Ø§Ø¨ ÙÙ†ÙŠØ© ÙˆÙ…Ø§Ù„ÙŠØ©.\n\n`;
        message += `Ù†ØªØ·Ù„Ø¹ Ù„Ù„ØªØ¹Ø§ÙˆÙ† Ù…Ø¹ÙƒÙ… ÙÙŠ Ø§Ù„ÙØ±Øµ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.\n\n`;
        message += `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ØŒ\n`;
        message += `Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†`;
        
        return { vendor: offer.vendor, message };
      });
    
    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©
    let financialMessage = `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…\n\n`;
    financialMessage += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}\n`;
    financialMessage += `Ø¥Ù„Ù‰: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©\n`;
    financialMessage += `Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø³ÙŠØ© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber}\n\n`;
    financialMessage += `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒ\n\n`;
    financialMessage += `Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù†Ù‡ ØªÙ… Ø§Ù„ØªØ±Ø³ÙŠØ© ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber} `;
    financialMessage += `Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ${transactionNumber} Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${beneficiary}\n\n`;
    
    financialMessage += `ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ±Ø³ÙŠØ©:\n`;
    (recommendation?.selectedOffers || []).forEach((offer, index) => {
      financialMessage += `${index + 1}. ${offer.vendor}: `;
      financialMessage += `${formatNumberWithCommas(offer.amount)} ${offer.currency}`;
      if (offer.currency !== 'Ø±ÙŠØ§Ù„') {
        const originalOffer = priceOffers.find(po => po.vendor === offer.vendor);
        const totalInYR = offer.isManualAmount && offer.manualAmount 
          ? offer.manualAmount * (originalOffer?.exchangeRate || 1)
          : offer.totalInYR;
        financialMessage += ` (${formatNumberWithCommas(totalInYR || 0)} Ø±ÙŠØ§Ù„)`;
      }
      financialMessage += `\n`;
    });
    
    financialMessage += `\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatNumberWithCommas(totalAwarded)} Ø±ÙŠØ§Ù„\n`;
    financialMessage += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØªØ§Ø¨Ø©: ${convertNumberToArabicWords(totalAwarded, 'Ø±ÙŠØ§Ù„')}\n\n`;
    financialMessage += `ÙŠØ±Ø¬Ù‰ Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù„Ø§Ø²Ù…Ø©.\n\n`;
    financialMessage += `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ØŒ\n`;
    financialMessage += `Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†`;
    
    return {
      awarded: awardedMessages,
      excluded: excludedMessages,
      financial: financialMessage
    };
  }, [recommendation, priceOffers, poNumber, transactionNumber, beneficiary, purchaseMethod, calculateTotalAwardedInYR]);
  
  return (
    <PurchaseOrderContext.Provider
      value={{
        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        poNumber,
        setPoNumber, // Ù‡Ø°Ø§ Ù‡Ùˆ setPoNumberState
        transactionNumber,
        setTransactionNumber,
        requesting,
        setRequesting,
        beneficiary,
        setBeneficiary,
        purchaseMethod, // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
        setPurchaseMethod,
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
        poItems,  //
        setPoItems, 
        priceOffers, // Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø§Ø³Ø¹Ø§Ø±
        setPriceOffers, 
        excludedOffers,
        setExcludedOffers,
        recommendation, // Ø§Ù„ØªÙˆØµÙŠØ©
        setRecommendation,
        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        isPreliminaryPrint,  // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        setIsPreliminaryPrint, 
        offerCount,  // Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶
        setOfferCount,
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        hasUnsavedChanges,  // Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        isDataSaved,  
        // ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© purchaseOrder Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯3
        purchaseOrder, // ğŸŸ¢ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
        // Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        loadPurchaseOrder,
        savePurchaseOrder,
        clearAllFields,
        handlePoNumberChange,
        updatePriceOffer,
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§ Ø¥Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚
        deletePurchaseOrderData,
        checkDuplicatePurchaseOrder,
        estimatedCosts,
        setEstimatedCosts,
        itemSpecifications,
        setItemSpecifications,
        // Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        calculateMaxOfferAmountInYR,
        calculateTotalAwardedInYR,
        getSalutationForPrint,
        getSignatoryForPrint,
        shouldShowPreliminarySignature,
        shouldShowFinalSignature,
        // Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        generateVendorMessages,
      }}
    >
      {children}
    </PurchaseOrderContext.Provider>
  );
};

/**
 * usePurchaseOrder
 * Ø³ÙŠØ§Ù‚ Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡:
 * - ÙŠØªÙŠØ­ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
 * - ÙŠÙˆÙØ± ÙˆØ¸Ø§Ø¦Ù Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
 * - ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ù…Ù„ÙŠØ§Øª CRUD Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * - ÙŠØ¯Ø¹Ù… Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†
 */
export const usePurchaseOrder = (): PurchaseOrderContextType => {
  const context = useContext(PurchaseOrderContext);
  if (context === undefined) {
    throw new Error('usePurchaseOrder must be used within a PurchaseOrderProvider');
  }
  return context;
};

; =======================================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø« Ø¬Ø¯ÙˆÙ„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø§Ø³Ø¹Ø§Ø±
// // purchases_alamin7-copy5\src\components\PriceOffersSection.tsx
; ==========================================================================================


import React, { useState, useEffect, useRef } from 'react';
import { DollarSign, Plus, Save, Edit, X, FileText, Award, Settings, AlertTriangle, CheckCircle, Calculator } from 'lucide-react';
import { usePurchaseOrder } from '../context/PurchaseOrderContext';
import { PriceOffer, OfferLineItem, Currency, OfferResult } from '../types';
import { convertNumberToArabicWords, formatNumberWithCommas } from '../utils/numberToWords';

export const PriceOffersSection: React.FC = () => {
  const {
    priceOffers, // Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    setPriceOffers,
    poItems,  // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
    offerCount,  // Ø¹Ø¯Ø¯ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    setOfferCount,
    savePurchaseOrder,
    isPreliminaryPrint,
    excludedOffers,
    setExcludedOffers,
    recommendation,
    setRecommendation
  } = usePurchaseOrder();

  // Ø­Ø§Ù„Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
  const [editingOffer, setEditingOffer] = useState<string | null>(null);
  const [showLineItemsModal, setShowLineItemsModal] = useState<string | null>(null);
  const [showAwardedItemsModal, setShowAwardedItemsModal] = useState<string | null>(null);
  const [showSpecificationsModal, setShowSpecificationsModal] = useState<{ offerId: string, lineNumber: number } | null>(null);
  const [showCommitmentsModal, setShowCommitmentsModal] = useState<{ offerId: string, lineNumber?: number } | null>(null);
  const [inputType, setInputType] = useState<'Ø¥Ø¬Ù…Ø§Ù„ÙŠ' | 'ØªÙØµÙŠÙ„ÙŠ'>('Ø¥Ø¬Ù…Ø§Ù„ÙŠ');

  // Ø­Ø§Ù„Ø§Øª Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const [tempOfferData, setTempOfferData] = useState<Partial<PriceOffer>>({});
  const [tempLineItems, setTempLineItems] = useState<OfferLineItem[]>([]);
  const [tempAwardedItems, setTempAwardedItems] = useState<OfferLineItem[]>([]);
  const [tempSpecifications, setTempSpecifications] = useState<{ [key: string]: string }>({});
  const [tempCommitments, setTempCommitments] = useState<string[]>([]);

  // Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº
  const [showAmountMismatchDialog, setShowAmountMismatchDialog] = useState(false);
  const [amountMismatchData, setAmountMismatchData] = useState<{
    offerId: string;  // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø±Ø¶
    offerTotal: number; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶
    lineItemsTotal: number; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù
    difference: number;  // Ø§Ù„ÙØ§Ø±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ÙŠÙ†
  } | null>(null);

  // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ø°ÙŠØ±ÙŠØ©
  const [showQuantityWarning, setShowQuantityWarning] = useState<{
    type: 'offered' | 'awarded';
    offerId: string;  // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø±Ø¶
    lineNumber?: number;  // Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
    requested: number; // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    offered?: number; // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
    awarded?: number; // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø³Ø§Ø©
    message: string;  // Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±
    onConfirm: () => void;
  } | null>(null);

  // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
  const [vendorSuggestions, setVendorSuggestions] = useState<string[]>([]);
  const [showVendorSuggestions, setShowVendorSuggestions] = useState<{ [key: number]: boolean }>({});

  // Ø­Ø§Ù„Ø© Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¤Ù‚ØªØ©
  const [inputValues, setInputValues] = useState<{ [key: string]: string }>({});

  // Ù…Ø±Ø§Ø¬Ø¹ Ù„Ù„Ø­Ù‚ÙˆÙ„
  const vendorInputRefs = useRef<{ [key: number]: HTMLInputElement | null }>({});

  // Flag to save after specs update to avoid stale closures
  const specsSavePendingRef = useRef(false);

  /**
   * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶
   * ÙŠÙ†Ø´Ø¦ Ø¹Ø±ÙˆØ¶ ÙØ§Ø±ØºØ© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ ÙŠØ­Ø°Ù Ø§Ù„Ø²Ø§Ø¦Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
   */
  useEffect(() => {
    if (priceOffers.length < offerCount) {
      const newOffers: PriceOffer[] = [];
      for (let i = priceOffers.length; i < offerCount; i++) {
        newOffers.push({
          id: `offer-${Date.now()}-${i}`,
          vendor: '', // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯
          offerNumber: '', // Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶
          amount: 0, // Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
          currency: 'Ø±ÙŠØ§Ù„' as Currency, // Ø§Ù„Ø¹Ù…Ù„Ø©
          exchangeRate: undefined, // Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (ÙØ§Ø±Øº Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„ØºÙŠØ± Ø§Ù„Ø±ÙŠØ§Ù„)
          taxIncluded: null, // Ù‡Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¶Ø±Ø§Ø¦Ø¨
          total: 0, // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
          totalInWords: '',
          result: '' as OfferResult, // Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ø±Ø¶
          totalInYR: 0, // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
          lineItems: [], // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
          commitments: [], // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
          notes: '' // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
          ,

          // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
          items: undefined,
          totalAfterTax: undefined,
          totalInYR: undefined,
          totalAfterTaxInYR: undefined
        });
      }
      setPriceOffers([...priceOffers, ...newOffers]);
    } else if (priceOffers.length > offerCount) {
      setPriceOffers(priceOffers.slice(0, offerCount));
    }
  }, [offerCount, priceOffers.length]);

  /**
   * ØªÙØ¹ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
   * Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø£ØµÙ†Ø§ÙØŒ ÙŠØµØ¨Ø­ "ØªÙØµÙŠÙ„ÙŠ"
   */
  useEffect(() => {
    if (editingOffer) {
      const offer = priceOffers.find(o => o.id === editingOffer);
      if (offer && offer.lineItems && offer.lineItems.length > 0) {
        setInputType('ØªÙØµÙŠÙ„ÙŠ');
        setTempLineItems([...offer.lineItems]);
      } else {
        setInputType('Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
        setTempLineItems([]);
      }
    }
  }, [editingOffer, priceOffers]);

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ù„Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
   */
  const searchVendors = (inputValue: string, index: number) => {
    if (!inputValue.trim()) {
      setVendorSuggestions([]);
      setShowVendorSuggestions(prev => ({ ...prev, [index]: false }));
      return;
    }
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶
    const allVendors = Array.from(new Set(
      priceOffers.map(offer => offer.vendor).filter(vendor => vendor && vendor.trim())
    ));
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠØªØ·Ø§Ø¨Ù‚ÙˆÙ† Ù…Ø¹ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
    const filtered = allVendors.filter(vendor =>
      vendor.toLowerCase().includes(inputValue.toLowerCase())
    );
    setVendorSuggestions(filtered);
    setShowVendorSuggestions(prev => ({ ...prev, [index]: true }));
  };

  /**
   * Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚
   */
  const handleUpdateOffer = (index: number, updates: Partial<PriceOffer>) => {
    setPriceOffers(priceOffers.map((offer, i) => {
      if (i === index) {
        const updatedOffer = { ...offer, ...updates };
        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„Ø© Ø£Ùˆ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø£Ùˆ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
        if ('amount' in updates || 'currency' in updates || 'exchangeRate' in updates || 'taxIncluded' in updates) {
          const amount = updates.amount !== undefined ? updates.amount : offer.amount;
          const currency = updates.currency || offer.currency;
          const exchangeRate = updates.exchangeRate !== undefined ? updates.exchangeRate : offer.exchangeRate;
          const taxIncluded = updates.taxIncluded !== undefined ? updates.taxIncluded : offer.taxIncluded;

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
          let total = amount;
          if (taxIncluded === false) {
            total = amount * (105 / 98); // Ø¥Ø¶Ø§ÙØ© 15% Ø¶Ø±ÙŠØ¨Ø©
          }

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
          const totalInYR = currency === 'Ø±ÙŠØ§Ù„' ? total : total * (exchangeRate || 1);

          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª
          const totalInWords = convertNumberToArabicWords(total, currency);

          updatedOffer.total = total;  // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
          updatedOffer.totalAfterTax = total; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
          updatedOffer.totalInYR = totalInYR; // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
          updatedOffer.totalInWords = totalInWords; // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª
        }
        return updatedOffer;
      }
      return offer;
    }));
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø³Ø·Ø± Ø§Ù„Ù…ÙˆØ±Ø¯
   */
  const handleStartEdit = (index: number) => {
    const offer = priceOffers[index];
    setEditingOffer(offer.id);
    setTempOfferData({ ...offer });
    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
    if (offer.lineItems && offer.lineItems.length > 0) {
      setInputType('ØªÙØµÙŠÙ„ÙŠ');
      setTempLineItems([...offer.lineItems]);
    } else {
      setInputType('Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
      setTempLineItems([]);
    }
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù
   */
  const checkAmountConsistency = (index: number): boolean => {
    const offer = priceOffers[index];
    if (!offer || !offer.lineItems || offer.lineItems.length === 0) return true;

    const lineItemsTotal = offer.lineItems.reduce((sum, item) => {
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ ØºÙŠØ± Ø´Ø§Ù…Ù„Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
      return sum + (offer.taxIncluded === false ? (item.lineTotalBeforeTax || 0) : (item.lineTotal || 0));
    }, 0);

    const offerTotal = offer.amount || 0;
    const difference = Math.abs(lineItemsTotal - offerTotal);

    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØ§Ø±Ù‚ ØµØºÙŠØ± (Ø£Ù‚Ù„ Ù…Ù† 1 Ø±ÙŠØ§Ù„) Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨
    return difference < 1;
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº
   */
  const handleSaveOffer = async (index: number) => {
    const offer = priceOffers[index];

    if (!tempOfferData.vendor) {
      alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const requiredFields = ['vendor', 'offerNumber', 'amount', 'currency'];
    const missingFields = requiredFields.filter(field => !tempOfferData[field as keyof PriceOffer]);

    if (missingFields.length > 0) {
      alert(`Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©: ${missingFields.join(', ')}`);
      return;
    }

    if (tempOfferData.currency !== 'Ø±ÙŠØ§Ù„' && (!tempOfferData.exchangeRate || tempOfferData.exchangeRate <= 0)) {
      alert('Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©');
      return;
    }

    if (tempOfferData.taxIncluded === null) {
      alert('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨');
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªÙØ§ØµÙŠÙ„ Ø£ØµÙ†Ø§Ù
    if (inputType === 'ØªÙØµÙŠÙ„ÙŠ' && tempLineItems.length > 0) {
      const lineItemsTotal = tempLineItems.reduce((sum, item) => {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ ØºÙŠØ± Ø´Ø§Ù…Ù„Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
        return sum + (tempOfferData.taxIncluded === false ? (item.lineTotalBeforeTax || 0) : (item.lineTotal || 0));
      }, 0);

      const offerTotal = tempOfferData.amount || 0;
      const difference = Math.abs(lineItemsTotal - offerTotal);

      if (difference >= 1) {
        setAmountMismatchData({
          offerId: offer.id,
          offerTotal,
          lineItemsTotal,
          difference
        });
        setShowAmountMismatchDialog(true);
        return;
      }
    }

    // Ø¯Ù…Ø¬ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ØªÙØ§Ø¯ÙŠ ÙÙ‚Ø¯Ø§Ù†Ù‡Ø§
    let finalLineItems = inputType === 'ØªÙØµÙŠÙ„ÙŠ' ? tempLineItems : [];
    if (offer.lineItems && finalLineItems.length > 0) {
      finalLineItems = finalLineItems.map(li => {
        const prev = offer.lineItems!.find(p => p.lineNumber === li.lineNumber || p.itemId === li.itemId);
        return prev ? { ...li, vendorSpecifications: li.vendorSpecifications ?? prev.vendorSpecifications } : li;
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const updates: Partial<PriceOffer> = {
      ...tempOfferData,
      lineItems: finalLineItems,
      result: tempOfferData.result || '' as OfferResult
    };

    handleUpdateOffer(index, updates);
    setEditingOffer(null);
    setTempOfferData({});
    setTempLineItems([]);
    await savePurchaseOrder();
  };

  /**
   * Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ù„
   */
  const handleAmountMismatch = async (action: 'updateOffer' | 'saveWithNote') => {
    if (!amountMismatchData) return;
    const { offerId, lineItemsTotal } = amountMismatchData;

    if (action === 'updateOffer') {
      // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø­Ø³Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù
      setTempOfferData(prev => ({
        ...prev,
        amount: lineItemsTotal,
        total: lineItemsTotal,
        totalAfterTax: lineItemsTotal
      }));
    } else if (action === 'saveWithNote') {
      // Ø§Ù„Ø­ÙØ¸ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† Ø§Ù„Ø®Ø·Ø£
      setTempOfferData(prev => ({
        ...prev,
        notes: (prev.notes || '') + '\nâš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙ„Ø§Ù Ø¨ÙŠÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù'
      }));
    }

    setShowAmountMismatchDialog(false);
    setAmountMismatchData(null);

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸
    setTimeout(() => {
      const offerIndex = priceOffers.findIndex(o => o.id === amountMismatchData?.offerId);
      if (offerIndex !== -1) {
        handleSaveOffer(offerIndex);
      }
    }, 100);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
   */
  const handleCancelEdit = () => {
    setEditingOffer(null);
    setTempOfferData({});
    setTempLineItems([]);
    setTempAwardedItems([]);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ø°ÙŠØ±ÙŠØ©
   */
  const validateQuantities = (
    type: 'offered' | 'awarded',
    lineNumber: number,
    offeredQty: number,
    awardedQty?: number,
    onConfirm?: () => void
  ) => {
    const poItem = poItems.find(item => item.lineNumber === lineNumber);
    if (!poItem) return true;

    const requestedQty = poItem.quantity;

    if (type === 'offered' && offeredQty > requestedQty) {
      setShowQuantityWarning({
        type: 'offered',
        offerId: editingOffer || '',
        lineNumber,
        requested: requestedQty,
        offered: offeredQty,
        message: `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (${offeredQty}) ØªØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${requestedQty})`,
        onConfirm: onConfirm || (() => { })
      });
      return false;
    }

    if (type === 'awarded' && awardedQty !== undefined) {
      if (awardedQty > offeredQty) {
        setShowQuantityWarning({
          type: 'awarded',
          offerId: editingOffer || '',
          lineNumber,
          requested: requestedQty,
          offered: offeredQty,
          awarded: awardedQty,
          message: `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (${awardedQty}) ØªØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (${offeredQty})`,
          onConfirm: onConfirm || (() => { })
        });
        return false;
      }

      if (awardedQty > requestedQty) {
        setShowQuantityWarning({
          type: 'awarded',
          offerId: editingOffer || '',
          lineNumber,
          requested: requestedQty,
          offered: offeredQty,
          awarded: awardedQty,
          message: `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (${awardedQty}) ØªØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${requestedQty})`,
          onConfirm: onConfirm || (() => { })
        });
        return false;
      }
    }

    return true;
  };

  /**
   * Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø³Ø·Ø± ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
   */
  const handleUpdateLineItem = (index: number, updates: Partial<OfferLineItem>) => {
    const updatedLineItems = tempLineItems.map((item, i) => {
      if (i === index) {
        // Preserve existing vendorSpecifications if not explicitly provided in updates
        const merged: OfferLineItem = {
          ...item,
          ...updates,
          vendorSpecifications: updates.vendorSpecifications ?? item.vendorSpecifications,
        } as OfferLineItem;

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±
        if ('offeredQty' in updates || 'unitPrice' in updates) {
          const qty = merged.offeredQty || 0;
          const price = merged.unitPrice || 0;

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
          merged.lineTotalBeforeTax = qty * price;

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
          if (tempOfferData.taxIncluded === false) {
            merged.lineTotalAfterTax = qty * (price * (105 / 98));
            merged.unitPriceAfterTax = Math.round((price * (105 / 98)) * 100) / 100;
          } else {
            merged.lineTotalAfterTax = qty * price;
            merged.unitPriceAfterTax = price;
          }

          merged.lineTotal = merged.lineTotalAfterTax;
        }

        return merged;
      }
      return item;
    });

    setTempLineItems(updatedLineItems);

    // ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
    updateOfferResultBasedOnAwarded(updatedLineItems);
  };

  /**
   * Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
   */
  const updateOfferResultBasedOnAwarded = (lineItems: OfferLineItem[]) => {
    if (!editingOffer) return;

    const hasAwardedItems = lineItems.some(item => (item.awardedQty || 0) > 0);
    if (!hasAwardedItems) return;

    const allFullyAwarded = lineItems.every(item => {
      const awardedQty = item.awardedQty || 0;
      const offeredQty = item.offeredQty || 0;
      return awardedQty > 0 && awardedQty === offeredQty;
    });

    const newResult = allFullyAwarded ? 'Ù…Ø·Ø§Ø¨Ù‚' : 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ';

    setTempOfferData(prev => ({
      ...prev,
      result: newResult
    }));
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
   */
  const handleAddLineItem = () => {
    if (!showLineItemsModal) return;

    const newLineItem: OfferLineItem = {
      itemId: `line-${Date.now()}`,
      lineNumber: tempLineItems.length + 1, // Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø±
      name: '',  // Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
      unit: '', // ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³
      requestedQty: 0, // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      offeredQty: 0, // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
      unitPrice: 0, // Ø§Ù„Ø³Ø¹Ø±UNT
      lineTotal: 0, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø±
      awarded: false, // Ù‡Ù„ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ù
      specifications: {}, // Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
      commitments: [] // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ØµÙ†Ù
    };

    setTempLineItems([...tempLineItems, newLineItem]);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø³Ø·Ø± Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
   */
  const handleRemoveLineItem = (index: number) => {
    setTempLineItems(tempLineItems.filter((_, i) => i !== index));
  };

  /**
   * Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
   */
  // const handleOpenSpecifications = (offerId: string, lineNumber: number) => {
  //   const offer = priceOffers.find(o => o.id === offerId);
  //   const lineItem = offer?.lineItems?.find(li => li.lineNumber === lineNumber);

  //   // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙƒØ­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ©
  //   const poItem = poItems.find(item => item.lineNumber === lineNumber);
  //   const initialSpecs: { [key: string]: string } = {};

  //   if (poItem?.specifications) {
  //     // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  //     Object.keys(poItem.specifications).forEach(key => {
  //       initialSpecs[key] = lineItem?.vendorSpecifications?.[key] ?? '';
  //     });
  //   }

  //   // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯
  //   if (lineItem?.vendorSpecifications) {
  //     Object.entries(lineItem.vendorSpecifications).forEach(([key, value]) => {
  //       if (!(key in initialSpecs)) {
  //         // Ensure string type; if vendor spec value is undefined, default to empty string
  //         initialSpecs[key] = value ?? '';
  //       }
  //     });
  //   }

  //   setTempSpecifications(initialSpecs);
  //   setShowSpecificationsModal({ offerId, lineNumber });
  // };

  // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  const handleOpenSpecifications = (offerId: string, lineNumber: number) => {
    const offer = priceOffers.find(o => o.id === offerId);
    const lineItem = offer?.lineItems?.find(li => li.lineNumber === lineNumber);

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙƒØ­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ©
    const poItem = poItems.find(item => item.lineNumber === lineNumber);
    const initialSpecs: { [key: string]: string } = {};

    if (poItem?.specifications) {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
      Object.keys(poItem.specifications).forEach(key => {
        initialSpecs[key] = lineItem?.vendorSpecifications?.[key] ?? '';
      });
    }

    // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯
    if (lineItem?.vendorSpecifications) {
      Object.entries(lineItem.vendorSpecifications).forEach(([key, value]) => {
        if (!(key in initialSpecs)) {
          // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø³Ù„Ø³Ù„Ø© Ù†ØµÙŠØ©
          initialSpecs[key] = typeof value === 'string' ? value : String(value || '');
        }
      });
    }

    setTempSpecifications(initialSpecs);
    setShowSpecificationsModal({ offerId, lineNumber });
  };

  // Ø§Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
  const isValidSpecification = (specs: any): specs is { [key: string]: string } => {
    return typeof specs === 'object' &&
      specs !== null &&
      !Array.isArray(specs) &&
      Object.keys(specs).length > 0;
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚
   */
  // const handleSaveSpecifications = () => {
  //   if (!showSpecificationsModal) return;
  //   const { offerId, lineNumber } = showSpecificationsModal;

  //   specsSavePendingRef.current = true;

  //   // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶
  //   setPriceOffers(priceOffers.map(offer => {
  //     if (offer.id === offerId && offer.lineItems) {
  //       const updatedLineItems = offer.lineItems.map(li => {
  //         if (li.lineNumber === lineNumber) {
  //           return {
  //             ...li,
  //             vendorSpecifications: { ...tempSpecifications }
  //           };
  //         }
  //         return li;
  //       });
  //       return { ...offer, lineItems: updatedLineItems };
  //     }
  //     return offer;
  //   }));

  //   setShowSpecificationsModal(null);
  //   setTempSpecifications({});

  //   // Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ useEffect Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
  // };

  //  ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙÙŠ ØµÙØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±

  // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚
  const handleSaveSpecifications = async () => {
    if (!showSpecificationsModal) return;
    const { offerId, lineNumber } = showSpecificationsModal;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶
    setPriceOffers(prevOffers => {
      return prevOffers.map(offer => {
        if (offer.id === offerId) {
          const updatedLineItems = [...(offer.lineItems || [])];
          const lineItemIndex = updatedLineItems.findIndex(li => li.lineNumber === lineNumber);

          if (lineItemIndex !== -1) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù„Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
            updatedLineItems[lineItemIndex] = {
              ...updatedLineItems[lineItemIndex],
              vendorSpecifications: { ...tempSpecifications }
            };
          } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø³Ø·Ø± Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ Ø£Ø¶Ù Ø³Ø·Ø±Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§
            const poItem = poItems.find(item => item.lineNumber === lineNumber);
            if (poItem) {
              updatedLineItems.push({
                itemId: poItem.id,
                lineNumber: poItem.lineNumber,
                name: poItem.name,
                unit: poItem.unit,
                requestedQty: poItem.quantity,
                offeredQty: poItem.quantity,
                unitPrice: 0,
                lineTotal: 0,
                awarded: false,
                specifications: {},
                vendorSpecifications: { ...tempSpecifications },
                commitments: []
              });
            }
          }

          return {
            ...offer,
            lineItems: updatedLineItems
          };
        }
        return offer;
      });
    });

    setShowSpecificationsModal(null);
    setTempSpecifications({});

    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹
    try {
      await savePurchaseOrder();
      console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª:", error);
    }
  };

  /**
   * Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø± Ø£Ùˆ Ø§Ù„Ù…ÙˆØ±Ø¯)
   */
  const handleOpenCommitments = (offerId: string, lineNumber?: number) => {
    const offer = priceOffers.find(o => o.id === offerId);

    if (lineNumber !== undefined) {
      // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø±
      const lineItem = offer?.lineItems?.find(li => li.lineNumber === lineNumber);
      setTempCommitments(lineItem?.commitments || []);
    } else {
      // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ±Ø¯
      setTempCommitments(offer?.commitments || []);
    }

    setShowCommitmentsModal({ offerId, lineNumber });
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø³Ø·Ø± Ø£Ùˆ Ù…ÙˆØ±Ø¯)
   */
  // const handleSaveCommitments = () => {
  //   if (!showCommitmentsModal) return;
  //   const { offerId, lineNumber } = showCommitmentsModal;

  //   setPriceOffers(priceOffers.map(offer => {
  //     if (offer.id === offerId) {
  //       if (lineNumber !== undefined && offer.lineItems) {
  //         // Ø­ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø±
  //         const updatedLineItems = offer.lineItems.map(li => {
  //           if (li.lineNumber === lineNumber) {
  //             return { ...li, commitments: [...tempCommitments.filter(c => c.trim())] };
  //           }
  //           return li;
  //         });
  //         return { ...offer, lineItems: updatedLineItems };
  //       } else {
  //         // Ø­ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ±Ø¯
  //         return { ...offer, commitments: [...tempCommitments.filter(c => c.trim())] };
  //       }
  //     }
  //     return offer;
  //   }));

  //   setShowCommitmentsModal(null);
  //   setTempCommitments([]);
  //   savePurchaseOrder();
  // };

  // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
  // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø³Ø·Ø± Ø£Ùˆ Ù…ÙˆØ±Ø¯)
const handleSaveCommitments = () => {
  if (!showCommitmentsModal) return;
  const { offerId, lineNumber } = showCommitmentsModal;
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†
  setTimeout(() => {
    setPriceOffers(prevOffers => {
      return prevOffers.map(offer => {
        if (offer.id === offerId) {
          if (lineNumber !== undefined && offer.lineItems) {
            // Ø­ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø±
            const updatedLineItems = offer.lineItems.map(li => {
              if (li.lineNumber === lineNumber) {
                return { 
                  ...li, 
                  commitments: [...tempCommitments.filter(c => c && c.trim())] 
                };
              }
              return li;
            });
            return { ...offer, lineItems: updatedLineItems };
          } else {
            // Ø­ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ±Ø¯
            return { 
              ...offer, 
              commitments: [...tempCommitments.filter(c => c && c.trim())] 
            };
          }
        }
        return offer;
      });
    });
    
    setShowCommitmentsModal(null);
    setTempCommitments([]);
    
    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    savePurchaseOrder();
  }, 0);
};


  /**
   * Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ²Ø§Ù… Ø¬Ø¯ÙŠØ¯
   */
  const handleAddCommitment = () => {
    setTempCommitments([...tempCommitments, '']);
  };

  /**
   * Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ²Ø§Ù… Ù…Ø­Ø¯Ø¯
   */
  const handleUpdateCommitment = (index: number, value: string) => {
    const updatedCommitments = tempCommitments.map((commitment, i) =>
      i === index ? value : commitment
    );
    setTempCommitments(updatedCommitments);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„ØªØ²Ø§Ù… Ù…Ø­Ø¯Ø¯
   */
  const handleRemoveCommitment = (index: number) => {
    setTempCommitments(tempCommitments.filter((_, i) => i !== index));
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶
   */
  const isOfferComplete = (offer: PriceOffer): boolean => {
    return !!(
      offer.vendor &&
      offer.offerNumber &&
      offer.amount > 0 &&
      offer.currency &&
      offer.taxIncluded !== null &&
      (offer.currency === 'Ø±ÙŠØ§Ù„' || (offer.exchangeRate && offer.exchangeRate > 0))
    );
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù…Ù† Ø¹Ø±ÙˆØ¶ Ø£Ø®Ø±Ù‰
   */
  const getReuseableExchangeRate = (currency: string): number | undefined => {
    const existingOffer = priceOffers.find(offer =>
      offer.currency === currency && offer.exchangeRate && offer.exchangeRate > 0
    );
    return existingOffer?.exchangeRate;
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
   */
  const calculateLineItemsTotal = (lineItems: OfferLineItem[]): number => {
    return lineItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
   */
  const calculateAwardedTotal = (lineItems: OfferLineItem[]): number => {
    return lineItems.reduce((sum, item) => {
      const awardedQty = item.awardedQty || 0;
      const price = item.unitPriceAfterTax || item.unitPrice || 0;
      return sum + (awardedQty * price);
    }, 0);
  };

  /**
   * Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
   */
  const handleOpenAwardedItems = (offerId: string) => {
    const offer = priceOffers.find(o => o.id === offerId);
    if (offer && offer.lineItems) {
      setTempAwardedItems([...offer.lineItems]);
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ±Ø³ÙŠØ©
      const awardedItems = poItems.map(item => ({
        itemId: item.id,
        lineNumber: item.lineNumber,
        name: item.name,
        unit: item.unit,
        requestedQty: item.quantity,
        offeredQty: item.quantity,
        unitPrice: 0,
        lineTotal: 0,
        awarded: false,
        awardedQty: 0,
        specifications: {}, // Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        commitments: []
      }));
      setTempAwardedItems(awardedItems);
    }
    setShowAwardedItemsModal(offerId);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ±Ø³ÙŠØ©
   */
  const handleSaveAwardedItems = () => {
    if (!showAwardedItemsModal) return;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ±Ø³ÙŠØ© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ vendorSpecifications Ø¥Ù† ÙˆÙØ¬Ø¯Øª
    const offerIndex = priceOffers.findIndex(o => o.id === showAwardedItemsModal);
    if (offerIndex !== -1) {
      const existing = priceOffers[offerIndex].lineItems || [];
      const mergedItems = tempAwardedItems.map(t => {
        const prev = existing.find(p => p.lineNumber === t.lineNumber || p.itemId === t.itemId);
        return prev ? { ...t, vendorSpecifications: prev.vendorSpecifications ?? t.vendorSpecifications } : t;
      });

      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
      const hasAnyAwarded = mergedItems.some(li => (li.awardedQty || 0) > 0 || li.awarded);
      let newResult: OfferResult = '' as OfferResult;

      if (hasAnyAwarded) {
        const fullyAwarded = mergedItems.every(li => {
          const awardedQty = li.awardedQty || 0;
          const offeredQty = li.offeredQty || 0;
          return awardedQty > 0 && awardedQty === offeredQty;
        });
        newResult = fullyAwarded ? 'Ù…Ø·Ø§Ø¨Ù‚' : 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ';
      }

      handleUpdateOffer(offerIndex, { lineItems: mergedItems, result: newResult });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØµÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… ØªØ±Ø³ÙŠØ© ÙÙ‚Ø·
      const vendorName = priceOffers[offerIndex].vendor;
      if (vendorName && hasAnyAwarded) {
        setRecommendation((prev: any) => {
          const existingRec = prev?.selectedOffers || [];
          const already = existingRec.some((o: any) => o.vendor === vendorName);

          if (already) return prev || null;

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙ‚Ø·
          const awardedTotal = mergedItems.reduce((sum, li) => {
            if (li.awarded || (li.awardedQty || 0) > 0) {
              const awardedQty = li.awardedQty || li.offeredQty || 0;
              const unitPrice = li.unitPriceAfterTax || li.unitPrice || 0;
              return sum + (awardedQty * unitPrice);
            }
            return sum;
          }, 0);

            
          const currency = priceOffers[offerIndex].currency;
          const totalInYR = awardedTotal * (priceOffers[offerIndex].exchangeRate || 1);
          const awardedLineNumbers = mergedItems
            .filter(li => li.awarded || (li.awardedQty || 0) > 0)
            .map(li => li.lineNumber);
          const amountInWords = convertNumberToArabicWords(awardedTotal, currency);
          // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙ‚Ø·
          const newOffer = {
            vendor: vendorName,
            amount: awardedTotal,
            currency, // Ø§Ù„Ø¹Ù…Ù„Ø© 
            amountInWords,
            totalInYR,  // Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø±ÙŠØ§Ù„
            awardedLineNumbers,
            lineItems: mergedItems.filter(li => li.awarded || (li.awardedQty || 0) > 0).map(li => ({
              lineNumber: li.lineNumber,
              name: li.name,
              unit: li.unit,
              awardedQty: li.awardedQty || li.offeredQty || 0,
              unitPrice: li.unitPriceAfterTax || li.unitPrice || 0,
              total: (li.awardedQty || li.offeredQty || 0) * (li.unitPriceAfterTax || li.unitPrice || 0),
              commitments: li.commitments || []
            }))
          } as any;

          return { selectedOffers: [...existingRec, newOffer] } as any;
        });
      }
    }

    setShowAwardedItemsModal(null);
    savePurchaseOrder();
  };

  /**
   * Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   */
  const handleOpenLineItemsModal = (offerId: string) => {
    const offer = priceOffers.find(o => o.id === offerId);

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
    if (offer && offer.lineItems) {
      setTempLineItems([...offer.lineItems]);
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      const lineItems = poItems.map(item => ({
        itemId: item.id,
        lineNumber: item.lineNumber,
        name: item.name,
        unit: item.unit,
        requestedQty: item.quantity,
        offeredQty: item.quantity,
        unitPrice: 0,
        lineTotal: 0,
        awarded: false,
        specifications: {},
        vendorSpecifications: {},
        commitments: []
      }));
      setTempLineItems(lineItems);
    }

    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    if (offer) {
      setTempOfferData({ ...offer });
    }

    setShowLineItemsModal(offerId);
  };

  /**
   * Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
   */
  const handleInputChange = (offerId: string, field: string, value: string) => {
    setInputValues(prev => ({
      ...prev,
      [`${offerId}-${field}`]: value
    }));
  };

  // Save after specs update to avoid losing changes due to async state batching
  useEffect(() => {
    if (specsSavePendingRef.current) {
      specsSavePendingRef.current = false;
      savePurchaseOrder();
    }
  }, [priceOffers]);

  /**
   * Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Enter Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
   */
  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>, fieldIndex: number, totalFields: number, offerIndex: number) => {
    if (e.key === 'Enter' || e.key === 'Tab') {
      e.preventDefault();

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
      const currentField = e.currentTarget;
      const fieldName = currentField.getAttribute('data-field-name');
      const offer = priceOffers[offerIndex];

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù‹
      if (fieldName && !isCurrentFieldValid(fieldName, offer)) {
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ¹Ø¯Ù… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
        showFieldRequiredAlert(fieldName);
        return;
      }

      // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¹Ø±Ø¶
      const nextFieldIndex = (fieldIndex + 1) % totalFields;
      const nextFields = document.querySelectorAll(`[data-field-index="${nextFieldIndex}"]`);

      if (nextFields.length > offerIndex) {
        const nextField = nextFields[offerIndex] as HTMLInputElement;
        if (nextField) {
          nextField.focus();
        }
      }
    }
  };

  /**
   * Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
   */
  const isCurrentFieldValid = (fieldName: string, offer: PriceOffer): boolean => {
    switch (fieldName) {
      case 'vendor':
        return !!offer.vendor && offer.vendor.trim() !== '';
      case 'offerNumber':
        return !!offer.offerNumber && offer.offerNumber.trim() !== '';
      case 'currency':
        return !!offer.currency;
      case 'exchangeRate':
        return offer.currency === 'Ø±ÙŠØ§Ù„' || (offer.exchangeRate && offer.exchangeRate > 0);
      case 'taxIncluded':
        return offer.taxIncluded !== null;
      case 'amount':
        return offer.amount > 0;
      default:
        return true;
    }
  };

  /**
   * Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
   */
  const showFieldRequiredAlert = (fieldName: string) => {
    let message = '';
    switch (fieldName) {
      case 'vendor':
        message = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶';
        break;
      case 'offerNumber':
        message = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶';
        break;
      case 'currency':
        message = 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©';
        break;
      case 'exchangeRate':
        message = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©';
        break;
      case 'taxIncluded':
        message = 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨';
        break;
      case 'amount':
        message = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶';
        break;
      default:
        message = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„';
    }

    alert(message);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ
   */
  const validateRequiredFields = (offerIndex: number): boolean => {
    const offer = priceOffers[offerIndex];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    if (!offer.vendor || offer.vendor.trim() === '') {
      alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ');
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶
      const vendorField = document.querySelector(`[data-field-name="vendor"][data-offer-index="${offerIndex}"]`) as HTMLInputElement;
      if (vendorField) vendorField.focus();
      return false;
    }

    if (!offer.offerNumber || offer.offerNumber.trim() === '') {
      alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ');
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶
      const offerNumberField = document.querySelector(`[data-field-name="offerNumber"][data-offer-index="${offerIndex}"]`) as HTMLInputElement;
      if (offerNumberField) offerNumberField.focus();
      return false;
    }

    if (!offer.currency) {
      alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ');
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù…Ù„Ø©
      const currencyField = document.querySelector(`[data-field-name="currency"][data-offer-index="${offerIndex}"]`) as HTMLInputElement;
      if (currencyField) currencyField.focus();
      return false;
    }

    if (offer.currency !== 'Ø±ÙŠØ§Ù„' && (!offer.exchangeRate || offer.exchangeRate <= 0)) {
      alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ');
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
      const exchangeRateField = document.querySelector(`[data-field-name="exchangeRate"][data-offer-index="${offerIndex}"]`) as HTMLInputElement;
      if (exchangeRateField) exchangeRateField.focus();
      return false;
    }

    if (offer.taxIncluded === null) {
      alert('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ');
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
      const taxField = document.querySelector(`[data-field-name="taxIncluded"][data-offer-index="${offerIndex}"]`) as HTMLInputElement;
      if (taxField) taxField.focus();
      return false;
    }

    if (offer.amount <= 0) {
      alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ');
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº
      const amountField = document.querySelector(`[data-field-name="amount"][data-offer-index="${offerIndex}"]`) as HTMLInputElement;
      if (amountField) amountField.focus();
      return false;
    }

    return true;
  };

  return (
    <div className="bg-white rounded-lg shadow-lg p-4 mb-4 border border-gray-200 print:mb-0 print-container">
      {/* Ø±Ø£Ø³ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø³Ù† */}
      <div className="flex items-center justify-between mb-4 print:mb-2">
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-semibold flex items-center text-gray-800">
            <DollarSign className="ml-2 icon" size={20} />
            Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
          </h2>
          {/* Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶ */}
          <div className="flex items-center gap-4 text-sm text-gray-600 print:hidden">
            <span>Ø§Ù„Ø¹Ø¯Ø¯: {priceOffers.length}</span>
            <span>Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: {priceOffers.filter(offer => isOfferComplete(offer)).length}</span>
            <span>Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: {priceOffers.filter(offer => offer.result === 'Ù…Ø·Ø§Ø¨Ù‚').length}</span>
          </div>
        </div>
        {/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */}
        <div className="flex items-center gap-4 print:hidden">
          <div className="flex items-center gap-2">
            <label className="text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶:</label>
            <select
              value={offerCount}
              onChange={(e) => setOfferCount(parseInt(e.target.value))}
              className="border border-gray-300 rounded px-2 py-1 text-sm"
            >
              {[1, 2, 3, 4, 5, 6, 7, 8].map(num => (
                <option key={num} value={num}>{num}</option>
              ))}
            </select>
          </div>
          <div className="flex items-center gap-2">
            <label className="text-sm font-medium">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:</label>
            <select
              value={inputType}
              onChange={(e) => setInputType(e.target.value as 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ' | 'ØªÙØµÙŠÙ„ÙŠ')}
              className="border border-gray-300 rounded px-2 py-1 text-sm"
            >
              <option value="Ø¥Ø¬Ù…Ø§Ù„ÙŠ">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</option>
              <option value="ØªÙØµÙŠÙ„ÙŠ">ØªÙØµÙŠÙ„ÙŠ</option>
            </select>
          </div>
        </div>
      </div>

      {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ù…Ø­Ø³Ù† - Ø¹Ù…ÙˆØ¯ Ù„ÙƒÙ„ Ù…ÙˆØ±Ø¯ */}
      <div className="overflow-x-auto print:overflow-visible">
        <table className="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
          <thead>
            <tr className="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
              <th className="border border-gray-300 p-3 text-center font-semibold" style={{ width: '20%' }}>
                Ø§Ù„Ø¨ÙŠØ§Ù†
              </th>
              {priceOffers.map((_, index) => (
                <th
                  key={index}
                  className="border border-gray-300 p-3 text-center font-medium"
                  style={{ width: `${80 / priceOffers.length}%` }}
                >
                  Ø§Ù„Ø¹Ø±Ø¶ {index + 1}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {/* Ø³Ø·Ø± Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶ */}
            <tr>
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2">
                  <div className="relative">
                    <input
                      ref={(el) => vendorInputRefs.current[index] = el}
                      type="text"
                      value={offer.vendor || ''}
                      onChange={(e) => {
                        handleUpdateOffer(index, { vendor: e.target.value });
                        searchVendors(e.target.value, index);
                      }}
                      onFocus={() => {
                        if (offer.vendor) {
                          searchVendors(offer.vendor, index);
                        }
                      }}
                      onBlur={(e) => {
                        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©
                        setTimeout(() => {
                          setShowVendorSuggestions(prev => ({ ...prev, [index]: false }));
                        }, 200);
                      }}
                      onKeyDown={(e) => handleKeyDown(e, 0, 6, index)}
                      data-field-index={0}
                      data-field-name="vendor"
                      data-offer-index={index}
                      className="w-full border-0 focus:outline-none print:bg-transparent p-1 text-center"
                      placeholder="Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶"
                      required
                    />
                    {showVendorSuggestions[index] && vendorSuggestions.length > 0 && (
                      <div className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-40 overflow-y-auto print:hidden">
                        {vendorSuggestions.map((suggestion, i) => (
                          <div
                            key={i}
                            className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-right"
                            onMouseDown={() => {
                              handleUpdateOffer(index, { vendor: suggestion });
                              setShowVendorSuggestions(prev => ({ ...prev, [index]: false }));
                            }}
                          >
                            {suggestion}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ */}
            <tr className={`${!isPreliminaryPrint ? 'print:hidden' : ''}`}>
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2">
                  <input
                    type="text"
                    value={offer.offerNumber || ''}
                    onChange={(e) => handleUpdateOffer(index, { offerNumber: e.target.value })}
                    onBlur={(e) => {
                      // Ù„Ø§ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø²Ø¹Ø¬Ø©
                    }}
                    onKeyDown={(e) => handleKeyDown(e, 1, 6, index)}
                    data-field-index={1}
                    data-field-name="offerNumber"
                    data-offer-index={index}
                    className="w-full border-0 focus:outline-none print:bg-transparent p-1 text-center"
                    placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶"
                    style={{ fontFamily: 'Arial, sans-serif' }}
                    required
                  />
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø§Ù„Ø¹Ù…Ù„Ø© */}
            <tr>
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ø§Ù„Ø¹Ù…Ù„Ø©</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2">
                  <select
                    value={offer.currency || 'Ø±ÙŠØ§Ù„'}
                    onChange={(e) => {
                      const newCurrency = e.target.value as Currency;

                      // Ø¬Ù„Ø¨ Ø³Ø¹Ø± ØµØ±Ù Ø³Ø§Ø¨Ù‚ Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù† ÙˆÙØ¬Ø¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ­ÙŠØ¯ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±ÙˆØ¶
                      const existingRate = newCurrency !== 'Ø±ÙŠØ§Ù„' ? getReuseableExchangeRate(newCurrency) : undefined;

                      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù…Ø¹Ø§Ù‹
                      // - ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ù„: ØªÙØ±ÙŠØº Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
                      // - ÙÙŠ Ø­Ø§Ù„ Ø¹Ù…Ù„Ø© Ø£Ø¬Ù†Ø¨ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆÙØ¬Ø¯ ÙˆØ¥Ù„Ø§ Ø§Ø¬Ø¹Ù„Ù‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¥Ù„Ø²Ø§Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹
                      handleUpdateOffer(index, {
                        currency: newCurrency,
                        exchangeRate: newCurrency === 'Ø±ÙŠØ§Ù„' ? undefined : existingRate
                      });
                    }}
                    onBlur={(e) => {
                      // Ù„Ø§ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø²Ø¹Ø¬Ø©
                    }}
                    onKeyDown={(e) => handleKeyDown(e, 2, 6, index)}
                    data-field-index={2}
                    data-field-name="currency"
                    data-offer-index={index}
                    className="w-full border rounded p-1 text-center print:hidden"
                    required
                  >
                    <option value="Ø±ÙŠØ§Ù„">Ø±ÙŠØ§Ù„</option>
                    <option value="Ø¯ÙˆÙ„Ø§Ø±">Ø¯ÙˆÙ„Ø§Ø±</option>
                    <option value="Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</option>
                    <option value="ÙŠÙˆØ±Ùˆ">ÙŠÙˆØ±Ùˆ</option>
                  </select>
                  <div className="hidden print:block text-center">
                    {offer.currency || 'Ø±ÙŠØ§Ù„'}
                  </div>
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù */}
            <tr className="exchange-rate-row">
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2 print:p-0.5 print:text-xs">
                  {offer.currency !== 'Ø±ÙŠØ§Ù„' && (
                    <input
                      type="number"
                      value={offer.exchangeRate ?? ''}
                      onChange={(e) => {
                        const raw = e.target.value;
                        // Ø§Ø³Ù…Ø­ Ø¨Ø¥ÙØ±Ø§Øº Ø§Ù„Ø­Ù‚Ù„ Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡ ÙƒØ¥Ù„Ø²Ø§Ù…ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
                        if (raw === '') {
                          handleUpdateOffer(index, { exchangeRate: undefined });
                          return;
                        }
                        const value = parseFloat(raw);
                        if (!isNaN(value) && value > 0) {
                          handleUpdateOffer(index, { exchangeRate: value });
                        } else {
                          // Ù‚ÙŠÙ… ØºÙŠØ± ØµØ§Ù„Ø­Ø© -> Ø§ØªØ±ÙƒÙ‡ undefined Ù„ÙŠØ¸Ù„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ§Ù‹
                          handleUpdateOffer(index, { exchangeRate: undefined });
                        }
                      }}
                      onBlur={(e) => {
                        // Ù„Ø§ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø²Ø¹Ø¬Ø©
                      }}
                      onKeyDown={(e) => handleKeyDown(e, 3, 6, index)}
                      data-field-index={3}
                      data-field-name="exchangeRate"
                      data-offer-index={index}
                      className="w-full border-0 focus:outline-none [appearance:textfield] print:bg-transparent bg-yellow-50 p-1 text-center"
                      style={{ fontFamily: 'Arial, sans-serif' }}
                      placeholder="Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù"
                      required
                    />
                  )}
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ */}
            <tr>
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2">
                  <select
                    value={offer.taxIncluded === null ? '' : (offer.taxIncluded ? 'Ø´Ø§Ù…Ù„' : 'ØºÙŠØ± Ø´Ø§Ù…Ù„')}
                    onChange={(e) => {
                      const val = e.target.value as '' | 'Ø´Ø§Ù…Ù„' | 'ØºÙŠØ± Ø´Ø§Ù…Ù„';
                      handleUpdateOffer(index, {
                        taxIncluded: val === '' ? null : (val === 'Ø´Ø§Ù…Ù„'),
                        result: offer.result // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                      });
                    }}
                    onKeyDown={(e) => handleKeyDown(e, 4, 6, index)}
                    data-field-index={4}
                    data-field-name="taxIncluded"
                    data-offer-index={index}
                    className="w-full border-0 focus:outline-none print:hidden p-1 text-center"
                    required
                  >
                    <option value="">Ø§Ø®ØªØ±</option>
                    <option value="Ø´Ø§Ù…Ù„">Ø´Ø§Ù…Ù„</option>
                    <option value="ØºÙŠØ± Ø´Ø§Ù…Ù„">ØºÙŠØ± Ø´Ø§Ù…Ù„</option>
                  </select>
                  <div className="hidden print:block">
                    {offer.taxIncluded === null ? 'Ø§Ø®ØªØ±' : (offer.taxIncluded ? 'Ø´Ø§Ù…Ù„' : 'ØºÙŠØ± Ø´Ø§Ù…Ù„')}
                  </div>
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ */}
            <tr>
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2">
                  <input
                    type="text"
                    inputMode="decimal"
                    value={inputValues[`${offer.id}-amount`] || (offer.amount ? formatNumberWithCommas(offer.amount) : '')}
                    onChange={(e) => {
                      const raw = e.target.value;
                      if (/^\d*\.?\d*$/.test(raw)) {
                        handleInputChange(offer.id, 'amount', raw);
                        handleUpdateOffer(index, {
                          inputValue: raw,
                          amount: parseFloat(raw) || 0
                        });
                      }
                    }}
                    onBlur={(e) => {
                      const raw = e.target.value.replace(/,/g, '');
                      const parsed = parseFloat(raw);
                      if (!isNaN(parsed)) {
                        handleUpdateOffer(index, {
                          amount: parsed,
                          inputValue: parsed.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                          })
                        });
                      } else {
                        handleUpdateOffer(index, { inputValue: '', amount: 0 });
                      }

                      // Ù„Ø§ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø²Ø¹Ø¬Ø©
                    }}
                    onFocus={(e) => {
                      if (offer.amount !== undefined && offer.amount !== 0) {
                        handleInputChange(offer.id, 'amount', offer.amount.toString());
                      } else {
                        handleInputChange(offer.id, 'amount', '');
                      }
                    }}
                    onKeyDown={(e) => handleKeyDown(e, 5, 6, index)}
                    data-field-index={5}
                    data-field-name="amount"
                    data-offer-index={index}
                    className="no-spin w-full border-0 focus:outline-none [appearance:textfield] print:bg-transparent p-1 text-center text-black-700 font-semibold"
                    style={{ fontFamily: 'Arial, sans-serif' }}
                    placeholder="0.00"
                    required
                  />
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ */}
            <tr>
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶
                <br />
                <span style={{ fontSize: '0.8em', fontWeight: 'normal' }}>(Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨)</span>
              </td>
              {priceOffers.map((offer) => (
                <td key={offer.id} className="text-blue-600 font-bold border border-gray-300 p-2">
                  <input
                    type="text"
                    value={formatNumberWithCommas(offer.total || offer.totalAfterTax || 0)}
                    readOnly
                    className="w-full bg-gray-100 border-0 print:bg-transparent p-1 text-center"
                    style={{ fontFamily: 'Arial, sans-serif' }}
                  />
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ - Ù…Ù†ÙØµÙ„ */}
            <tr className="bg-gray-50">
              <td className="border border-gray-300 p-3 font-medium text-center">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ</td>
              {priceOffers.map((offer) => (
                <td key={offer.id} className="text-green-600 font-bold border border-gray-300 p-2">
                  <input
                    type="text"
                    value={offer.totalInYR ? formatNumberWithCommas(offer.totalInYR) : ''}
                    readOnly
                    className="w-full bg-gray-100 border-0 print:bg-transparent p-1 text-center"
                    style={{ fontFamily: 'Arial, sans-serif' }}
                  />
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© */}
            <tr>
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ø§Ù„Ù†ØªÙŠØ¬Ø©</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2">
                  <select
                    value={offer.result || ''}
                    onChange={(e) => {
                      const value = e.target.value as PriceOffer['result'];
                      handleUpdateOffer(index, { result: value });
                      if (value === 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ') {
                        handleOpenAwardedItems(offer.id);
                      }
                    }}
                    className="border rounded p-1"
                  >
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ØªÙŠØ¬Ø©</option>
                    <option value="Ù…Ø·Ø§Ø¨Ù‚">Ù…Ø·Ø§Ø¨Ù‚</option>
                    <option value="ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚">ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚</option>
                    <option value="Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ">Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ</option>
                  </select>
                </td>
              ))}
            </tr>

            {/* Ø³Ø·Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± - Ù…Ù†ÙØµÙ„ */}
            <tr className="print:hidden">
              <td className="border border-gray-300 p-3 font-medium bg-gray-50 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</td>
              {priceOffers.map((offer, index) => (
                <td key={offer.id} className="border border-gray-300 p-2">
                  <div className="flex flex-col gap-2">
                    <button
                      onClick={() => handleOpenLineItemsModal(offer.id)}
                      disabled={!isOfferComplete(offer)}
                      className="w-full px-2 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 disabled:bg-gray-300"
                    >
                      Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù
                    </button>
                    <button
                      onClick={() => handleOpenAwardedItems(offer.id)}
                      disabled={!isOfferComplete(offer)}
                      className="w-full px-2 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 disabled:bg-gray-300"
                    >
                      Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
                    </button>
                  </div>
                </td>
              ))}
            </tr>
          </tbody>
        </table>
      </div>

      {/* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù†Ø© */}
      <div className="mt-4 print:hidden space-y-2">
        {priceOffers.some((offer, index) => !isOfferComplete(offer)) && (
          <div className="bg-yellow-50 border border-yellow-200 rounded-md p-3">
            <div className="flex items-center gap-2">
              <AlertTriangle className="w-5 h-5 text-yellow-600" />
              <p className="text-yellow-800 text-sm font-medium">
                ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©. Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø§Ù„Ø¹Ù…Ù„Ø©ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
                {priceOffers.some(offer => offer.currency !== 'Ø±ÙŠØ§Ù„' && (!offer.exchangeRate || offer.exchangeRate <= 0)) &&
                  'ØŒ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©'
                }
              </p>
            </div>
          </div>
        )}
        {priceOffers.some((offer, index) => !checkAmountConsistency(index)) && (
          <div className="bg-red-50 border border-red-200 rounded-md p-3">
            <div className="flex items-start gap-2">
              <AlertTriangle className="w-5 h-5 text-red-600 mt-0.5" />
              <div className="text-red-800 text-sm">
                <p className="font-medium mb-1">ÙŠÙˆØ¬Ø¯ Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø¨ÙŠÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                <ul className="list-disc pr-5 space-y-0.5">
                  {priceOffers.map((offer, idx) => {
                    if (!offer || !offer.lineItems || offer.lineItems.length === 0) return null;
                    const lineItemsTotal = offer.lineItems.reduce((sum, item) => {
                      return sum + (offer.taxIncluded === false ? (item.lineTotalBeforeTax || 0) : (item.lineTotal || 0));
                    }, 0);
                    const offerTotal = offer.amount || 0;
                    const difference = Math.abs(lineItemsTotal - offerTotal);
                    if (difference < 1) return null;
                    const name = offer.vendor?.trim() ? offer.vendor : `Ø§Ù„Ø¹Ø±Ø¶ ${idx + 1}`;
                    return (
                      <li key={offer.id}>
                        {name}: Ø§Ù„ÙØ±Ù‚ {formatNumberWithCommas(difference)} ({formatNumberWithCommas(lineItemsTotal)} Ù…Ù‚Ø§Ø¨Ù„ {formatNumberWithCommas(offerTotal)})
                      </li>
                    );
                  }).filter(Boolean)}
                </ul>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù */}
      {showLineItemsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-7xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold flex items-center">
                  <FileText className="ml-2" size={20} />
                  Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù - {priceOffers.find(o => o.id === showLineItemsModal)?.vendor}
                </h3>
                <button
                  onClick={() => setShowLineItemsModal(null)}
                  className="text-gray-500 hover:text-gray-700"
                >
                  <X size={24} />
                </button>
              </div>

              {/* Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ */}
              {(() => {
                const offer = priceOffers.find(o => o.id === showLineItemsModal);
                const isNonTax = (tempOfferData.taxIncluded === false) || (offer?.taxIncluded === false);
                const lineItemsTotal = isNonTax
                  ? tempLineItems.reduce((sum, li) => sum + (li.lineTotalBeforeTax || 0), 0)
                  : calculateLineItemsTotal(tempLineItems);
                const offerTotal = isNonTax ? (offer?.amount || 0) : ((offer?.total ?? offer?.amount) || 0);
                const remaining = offerTotal - lineItemsTotal;

                return (
                  <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <div className="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶</div>
                        <div className="text-lg font-semibold text-blue-800">
                          {formatNumberWithCommas(offerTotal)} {offer?.currency}
                        </div>
                      </div>
                      <div>
                        <div className="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
                        <div className="text-lg font-semibold text-purple-800">
                          {formatNumberWithCommas(lineItemsTotal)} {offer?.currency}
                        </div>
                      </div>
                      <div>
                        <div className="text-sm text-gray-600">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                        <div className={`text-lg font-semibold ${Math.abs(remaining) < 1 ? 'text-green-600' : 'text-red-600'
                          }`}>
                          {formatNumberWithCommas(remaining)} {offer?.currency}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}

              {/* Ø¬Ø¯ÙˆÙ„ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù */}
              <div className="mb-6">
                <h4 className="font-medium mb-3">Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse border border-gray-300">
                    <thead>
                      <tr className="bg-gray-100">
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„Ø³Ø·Ø±</th>
                        <th className="border border-gray-300 p-2 text-center">Ø¨ÙŠØ§Ù† Ø§Ù„ØµÙ†Ù</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</th>
                        {tempOfferData.taxIncluded === false && (
                          <>
                            <th className="border border-gray-300 p-2 text-center">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th>
                            <th className="border border-gray-300 p-2 text-center">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th>
                          </>
                        )}
                        <th className="border border-gray-300 p-2 text-center">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th className="border border-gray-300 p-2 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø±</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</th>
                      </tr>
                    </thead>
                    <tbody>
                      {poItems.map((poItem, itemIndex) => {
                        const lineItem = tempLineItems.find(li => li.lineNumber === poItem.lineNumber) || {
                          itemId: poItem.id,
                          lineNumber: poItem.lineNumber,
                          name: poItem.name,
                          unit: poItem.unit,
                          requestedQty: poItem.quantity,
                          offeredQty: 0,
                          unitPrice: 0,
                          lineTotal: 0,
                          awarded: false,
                          specifications: {},
                          commitments: []
                        };

                        return (
                          <tr key={`line-${poItem.lineNumber}`} className="hover:bg-gray-50">
                            <td className="border border-gray-300 p-2 text-center">{poItem.lineNumber}</td>
                            <td className="border border-gray-300 p-2">{poItem.name}</td>
                            <td className="border border-gray-300 p-2 text-center">{poItem.unit}</td>
                            <td className="border border-gray-300 p-2 text-center">{poItem.quantity}</td>
                            <td className="border border-gray-300 p-2">
                              <input
                                type="number"
                                value={lineItem.offeredQty}
                                onChange={(e) => {
                                  const newQty = parseFloat(e.target.value) || 0;
                                  const existingIndex = tempLineItems.findIndex(li => li.lineNumber === poItem.lineNumber);

                                  if (existingIndex >= 0) {
                                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
                                    if (newQty > poItem.quantity) {
                                      if (!validateQuantities('offered', poItem.lineNumber, newQty, undefined, () => {
                                        handleUpdateLineItem(existingIndex, { offeredQty: newQty });
                                      })) {
                                        return;
                                      }
                                    }
                                    handleUpdateLineItem(existingIndex, { offeredQty: newQty });
                                  } else {
                                    if (newQty > poItem.quantity) {
                                      if (!validateQuantities('offered', poItem.lineNumber, newQty, undefined, () => {
                                        setTempLineItems([...tempLineItems, { ...lineItem, offeredQty: newQty }]);
                                      })) {
                                        return;
                                      }
                                    }
                                    setTempLineItems([...tempLineItems, { ...lineItem, offeredQty: newQty }]);
                                  }
                                }}
                                className="w-full text-center border border-gray-300 rounded px-2 py-1 text-sm"
                                min="0"
                                step="0.01"
                              />
                            </td>
                            {tempOfferData.taxIncluded === false && (
                              <>
                                <td className="border border-gray-300 p-2">
                                  <input
                                    type="number"
                                    value={lineItem.unitPrice || 0}
                                    onChange={(e) => {
                                      const newPrice = parseFloat(e.target.value) || 0;
                                      const existingIndex = tempLineItems.findIndex(li => li.lineNumber === poItem.lineNumber);

                                      if (existingIndex >= 0) {
                                        handleUpdateLineItem(existingIndex, { unitPrice: newPrice });
                                      } else {
                                        setTempLineItems([...tempLineItems, { ...lineItem, unitPrice: newPrice }]);
                                      }
                                    }}
                                    className="w-full text-center border border-gray-300 rounded px-2 py-1 text-sm"
                                    min="0"
                                    step="0.01"
                                  />
                                </td>
                                <td className="border border-gray-300 p-2 text-center">
                                  {lineItem.unitPriceAfterTax ? formatNumberWithCommas(lineItem.unitPriceAfterTax) : '-'}
                                </td>
                              </>
                            )}
                            <td className="border border-gray-300 p-2">
                              <input
                                type="number"
                                value={lineItem.unitPrice || 0}
                                onChange={(e) => {
                                  const newPrice = parseFloat(e.target.value) || 0;
                                  const existingIndex = tempLineItems.findIndex(li => li.lineNumber === poItem.lineNumber);

                                  if (existingIndex >= 0) {
                                    handleUpdateLineItem(existingIndex, { unitPrice: newPrice });
                                  } else {
                                    setTempLineItems([...tempLineItems, { ...lineItem, unitPrice: newPrice }]);
                                  }
                                }}
                                className="w-full text-center border border-gray-300 rounded px-2 py-1 text-sm"
                                min="0"
                                step="0.01"
                              />
                            </td>
                            <td className="border border-gray-300 p-2 text-center">
                              <span className="font-medium">
                                {formatNumberWithCommas(lineItem.lineTotal)}
                              </span>
                            </td>
                            <td className="border border-gray-300 p-2 text-center">
                              <button
                                onClick={() => handleOpenSpecifications(showLineItemsModal, poItem.lineNumber)}
                                className="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                              >
                                Ù…ÙˆØ§ØµÙØ§Øª
                              </button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */}
              <div className="flex justify-between">
                <button
                  onClick={() => handleOpenCommitments(showLineItemsModal)}
                  className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                >
                  Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
                </button>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowLineItemsModal(null)}
                    className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                  >
                    Ø¥ØºÙ„Ø§Ù‚
                  </button>
                  <button
                    onClick={() => {
                      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
                      const offer = priceOffers.find(o => o.id === showLineItemsModal);
                      const lineItemsTotal = calculateLineItemsTotal(tempLineItems);
                      const offerTotal = offer?.total || offer?.amount || 0;
                      const difference = Math.abs(lineItemsTotal - offerTotal);

                      if (difference >= 1) {
                        setAmountMismatchData({
                          offerId: showLineItemsModal,
                          offerTotal,
                          lineItemsTotal,
                          difference
                        });
                        setShowAmountMismatchDialog(true);
                        return;
                      }

                      // Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶
                      const offerIndex = priceOffers.findIndex(o => o.id === showLineItemsModal);
                      if (offerIndex !== -1) {
                        handleUpdateOffer(offerIndex, { lineItems: tempLineItems });
                      }

                      setShowLineItemsModal(null);
                      savePurchaseOrder();
                    }}
                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                  >
                    Ø­ÙØ¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ±Ø³ÙŠØ© (Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§) */}
      {showAwardedItemsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold flex items-center">
                  <Award className="ml-2" size={20} />
                  ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ±Ø³ÙŠØ© - {priceOffers.find(o => o.id === showAwardedItemsModal)?.vendor}
                </h3>
                <button
                  onClick={() => setShowAwardedItemsModal(null)}
                  className="text-gray-500 hover:text-gray-700"
                >
                  <X size={24} />
                </button>
              </div>

              {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ */}
              <div className="mb-6">
                <h4 className="font-medium mb-3">Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§</h4>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse border border-gray-300">
                    <thead>
                      <tr className="bg-green-100">
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„Ø³Ø·Ø±</th>
                        <th className="border border-gray-300 p-2 text-center">Ø¨ÙŠØ§Ù† Ø§Ù„ØµÙ†Ù</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§</th>
                        <th className="border border-gray-300 p-2 text-center">Ù…Ø±Ø³Ù‰ØŸ</th>
                        <th className="border border-gray-300 p-2 text-center">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø·Ø±</th>
                      </tr>
                    </thead>
                    <tbody>
                      {tempAwardedItems.map((item, index) => (
                        <tr key={`awarded-${item.lineNumber}`} className="hover:bg-gray-50">
                          <td className="border border-gray-300 p-2 text-center">{item.lineNumber}</td>
                          <td className="border border-gray-300 p-2">{item.name}</td>
                          <td className="border border-gray-300 p-2 text-center">{item.requestedQty}</td>
                          <td className="border border-gray-300 p-2 text-center">{item.offeredQty}</td>
                          <td className="border border-gray-300 p-2">
                            <input
                              type="number"
                              value={item.awardedQty || 0}
                              onChange={(e) => {
                                const newQty = parseFloat(e.target.value) || 0;
                                const updatedItems = tempAwardedItems.map((aItem, i) =>
                                  i === index ? { ...aItem, awardedQty: newQty, awarded: newQty > 0 } : aItem
                                );
                                setTempAwardedItems(updatedItems);
                              }}
                              className="w-full text-center border border-gray-300 rounded px-2 py-1 text-sm"
                              min="0"
                              step="0.01"
                            />
                          </td>
                          <td className="border border-gray-300 p-2 text-center">
                            <input
                              type="checkbox"
                              checked={item.awarded || (item.awardedQty || 0) > 0}
                              onChange={(e) => {
                                const updatedItems = tempAwardedItems.map((aItem, i) =>
                                  i === index ? { ...aItem, awarded: e.target.checked } : aItem
                                );
                                setTempAwardedItems(updatedItems);
                              }}
                              className="w-4 h-4"
                            />
                          </td>
                          <td className="border border-gray-300 p-2 text-center">
                            <button
                              onClick={() => handleOpenCommitments(showAwardedItemsModal!, item.lineNumber)}
                              className="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                            >
                              Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ */}
              <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                <div className="text-center">
                  <div className="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
                  <div className="text-lg font-semibold text-green-800">
                    {formatNumberWithCommas(calculateAwardedTotal(tempAwardedItems))} {tempOfferData.currency}
                  </div>
                </div>
              </div>

              {/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */}
              <div className="flex justify-between">
                <button
                  onClick={() => handleOpenCommitments(showAwardedItemsModal!)}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ ÙƒÙƒÙ„
                </button>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowAwardedItemsModal(null)}
                    className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                  >
                    Ø¥ØºÙ„Ø§Ù‚
                  </button>
                  <button
                    onClick={handleSaveAwardedItems}
                    className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                  >
                    Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ±Ø³ÙŠØ©
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© */}
      {showSpecificationsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold">Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù</h3>
                <button
                  onClick={() => setShowSpecificationsModal(null)}
                  className="text-gray-500 hover:text-gray-700"
                >
                  <X size={20} />
                </button>
              </div>

              {/* Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙƒÙ…Ø±Ø¬Ø¹ */}
              {(() => {
                const poItem = poItems.find(item => item.lineNumber === showSpecificationsModal.lineNumber);
                return poItem?.specifications && Object.keys(poItem.specifications).length > 0 && (
                  <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 className="font-medium text-blue-800 mb-2">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h4>
                    {Object.entries(poItem.specifications).map(([key, value]) => (
                      <div key={key} className="text-sm text-blue-700">
                        <strong>{key}:</strong> {value}
                      </div>
                    ))}
                  </div>
                );
              })()}

              {/* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ */}
              <div className="space-y-3">
                <h4 className="font-medium text-gray-800">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯:</h4>
                {Object.entries(tempSpecifications).map(([key, value]) => (
                  <div key={key} className="flex gap-2 items-center">
                    <label className="w-24 text-sm font-medium">{key}:</label>
                    <input
                      type="text"
                      value={value}
                      onChange={(e) => setTempSpecifications(prev => ({
                        ...prev,
                        [key]: e.target.value
                      }))}
                      className="flex-1 border border-gray-300 rounded px-2 py-1 text-sm"
                      placeholder={`Ø£Ø¯Ø®Ù„ ${key} Ø§Ù„Ù…Ù‚Ø¯Ù…`}
                    />
                  </div>
                ))}

                {/* Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ© Ø¬Ø¯ÙŠØ¯Ø© */}
                <button
                  onClick={() => {
                    const newKey = prompt('Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§ØµÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
                    if (newKey) {
                      setTempSpecifications(prev => ({
                        ...prev,
                        [newKey]: ''
                      }));
                    }
                  }}
                  className="w-full px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                >
                  Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
              </div>

              <div className="flex justify-end gap-2 mt-6">
                <button
                  onClick={() => setShowSpecificationsModal(null)}
                  className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                >
                  Ø¥Ù„ØºØ§Ø¡
                </button>
                <button
                  onClick={handleSaveSpecifications}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  Ø­ÙØ¸
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© */}
      {showCommitmentsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold">
                  {showCommitmentsModal.lineNumber !== undefined
                    ? `Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø·Ø± ${showCommitmentsModal.lineNumber}`
                    : 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ ÙƒÙƒÙ„'
                  }
                </h3>
                <button
                  onClick={() => setShowCommitmentsModal(null)}
                  className="text-gray-500 hover:text-gray-700"
                >
                  <X size={20} />
                </button>
              </div>

              <div className="space-y-2 mb-4">
                {tempCommitments.map((commitment, index) => (
                  <div key={index} className="flex gap-2">
                    <input
                      type="text"
                      value={commitment}
                      onChange={(e) => handleUpdateCommitment(index, e.target.value)}
                      className="flex-1 border border-gray-300 rounded px-2 py-1 text-sm"
                      placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…"
                    />
                    <button
                      onClick={() => handleRemoveCommitment(index)}
                      className="text-red-600 hover:text-red-800 p-1"
                    >
                      <X size={16} />
                    </button>
                  </div>
                ))}
              </div>

              <button
                onClick={handleAddCommitment}
                className="w-full px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 mb-4"
              >
                Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ²Ø§Ù… Ø¬Ø¯ÙŠØ¯
              </button>

              <div className="flex justify-end gap-2">
                <button
                  onClick={() => setShowCommitmentsModal(null)}
                  className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                >
                  Ø¥Ù„ØºØ§Ø¡
                </button>
                <button
                  onClick={handleSaveCommitments}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  Ø­ÙØ¸
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Ù†Ø§ÙØ°Ø© Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ù„ */}
      {showAmountMismatchDialog && amountMismatchData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div className="p-6">
              <div className="flex items-center gap-3 mb-4">
                <AlertTriangle className="w-8 h-8 text-red-600" />
                <h3 className="text-lg font-semibold text-red-800">Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h3>
              </div>

              <div className="mb-6 space-y-3">
                <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="font-medium">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶:</span>
                      <div className="text-lg font-semibold text-red-700">
                        {formatNumberWithCommas(amountMismatchData.offerTotal)}
                      </div>
                    </div>
                    <div>
                      <span className="font-medium">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù:</span>
                      <div className="text-lg font-semibold text-blue-700">
                        {formatNumberWithCommas(amountMismatchData.lineItemsTotal)}
                      </div>
                    </div>
                  </div>
                  <div className="mt-3 pt-3 border-t border-red-300">
                    <span className="font-medium">Ø§Ù„ÙØ§Ø±Ù‚:</span>
                    <div className="text-lg font-semibold text-red-800">
                      {formatNumberWithCommas(amountMismatchData.difference)}
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-3">
                <p className="text-gray-700 font-medium">Ø§Ø®ØªØ± Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>

                <button
                  onClick={() => handleAmountMismatch('updateOffer')}
                  className="w-full p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors text-right"
                >
                  <div className="font-medium text-blue-800">Ø£- ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶</div>
                  <div className="text-sm text-blue-600 mt-1">
                    Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù
                  </div>
                </button>

                <button
                  onClick={() => handleAmountMismatch('saveWithNote')}
                  className="w-full p-4 bg-yellow-50 border border-yellow-200 rounded-lg hover:bg-yellow-100 transition-colors text-right"
                >
                  <div className="font-medium text-yellow-800">Ø¨- Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØµØ­ÙŠØ­ Ù…Ø¹ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø®Ø·Ø£</div>
                  <div className="text-sm text-yellow-600 mt-1">
                    Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØµØ­ÙŠØ­ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© ØªØ´ÙŠØ± Ø¥Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº
                  </div>
                </button>
              </div>

              <div className="flex justify-end gap-2 mt-6">
                <button
                  onClick={() => {
                    setShowAmountMismatchDialog(false);
                    setAmountMismatchData(null);
                  }}
                  className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                >
                  Ø¥Ù„ØºØ§Ø¡
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ø°ÙŠØ±ÙŠØ© Ù„Ù„ÙƒÙ…ÙŠØ§Øª */}
      {showQuantityWarning && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div className="p-6">
              <div className="flex items-center gap-3 mb-4">
                <AlertTriangle className="w-8 h-8 text-yellow-600" />
                <h3 className="text-lg font-semibold text-yellow-800">ØªØ­Ø°ÙŠØ±</h3>
              </div>

              <div className="mb-6">
                <p className="text-gray-700 mb-4">{showQuantityWarning.message}</p>
                <p className="text-gray-600">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø±ØºÙ… Ø§Ù„ØªØ­Ø°ÙŠØ±ØŸ</p>
              </div>

              <div className="flex justify-end gap-2">
                <button
                  onClick={() => setShowQuantityWarning(null)}
                  className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                >
                  Ø¥Ù„ØºØ§Ø¡
                </button>
                <button
                  onClick={() => {
                    // ØªÙ†ÙÙŠØ° Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø«Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
                    showQuantityWarning.onConfirm();
                    setShowQuantityWarning(null);
                  }}
                  className="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700"
                >
                  ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};


; =========================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØµÙŠØ©
// purchases_alamin7-copy5\src\components\RecommendationSection.tsx
; =============================================================================


// purchases_alamin7-final\src\components\RecommendationSection.tsx
import React, { useEffect, useState } from 'react';
import { Award, Printer, Mail, X } from 'lucide-react';
import { usePurchaseOrder } from '../context/PurchaseOrderContext';
import { convertNumberToArabicWords, formatNumberWithCommas, toFixed2Raw } from '../utils/numberToWords';
import { OfferLineItem, RecommendedOffer } from '../types';

export const RecommendationSection: React.FC = () => {
  const {
    poNumber,
    transactionNumber,
    priceOffers,
    recommendation,
    setRecommendation,
    excludedOffers,
    setExcludedOffers,
    savePurchaseOrder,
    isPreliminaryPrint,
    setIsPreliminaryPrint,
    offerCount,
    clearAllFields,
    setPoNumber,
    checkDuplicatePurchaseOrder,
    getSignatoryForPrint,
    calculateMaxOfferAmountInYR,
    shouldShowFinalSignature,
    calculateTotalAwardedInYR,
    poItems,
    shouldShowPreliminarySignature,
    requesting,
    beneficiary,
    purchaseMethod
  } = usePurchaseOrder();

  const [printStatus, setPrintStatus] = useState<'idle' | 'processing' | 'success' | 'error'>('idle');
  const [manualAmounts, setManualAmounts] = useState<{ [vendor: string]: string }>({});
  const [showMessagesModal, setShowMessagesModal] = useState(false);
  const [messageType, setMessageType] = useState<'awarded' | 'excluded' | 'financial'>('awarded');
  const [printType, setPrintType] = useState<'preliminary' | 'final'>('preliminary');

  // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  useEffect(() => {
    const handleBeforePrint = () => {
      console.log('Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...');
    };

    const handleAfterPrint = () => {
      console.log('Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...');
      if (isPreliminaryPrint) {
        setIsPreliminaryPrint(false);
      }
      
      // Ø¨Ø¹Ø¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŒ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
      if (printType === 'final') {
        setTimeout(() => {
          try {
            handleAdditionalPrinting();
          } catch (e) {
            console.error('Failed to print additional letters after final report:', e);
          }
        }, 200);
      }
      
      setPrintStatus('idle');
    };

    window.addEventListener('beforeprint', handleBeforePrint);
    window.addEventListener('afterprint', handleAfterPrint);
    
    return () => {
      window.removeEventListener('beforeprint', handleBeforePrint);
      window.removeEventListener('afterprint', handleAfterPrint);
    };
  }, [isPreliminaryPrint, setIsPreliminaryPrint, printType]);

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©
  const updateAmountInWords = (offer: RecommendedOffer): RecommendedOffer => {
    const amount = offer.isManualAmount ? offer.manualAmount || 0 : offer.amount || 0;
    return {
      ...offer,
      amountInWords: convertNumberToArabicWords(amount, offer.currency)
    };
  };

  // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„
  const updateTotalAwardedInYR = (selectedOffers: RecommendedOffer[]) => {
    const totalInYR = selectedOffers.reduce((sum, offer) => {
      const originalOffer = priceOffers.find(po => po.vendor === offer.vendor);
      if (originalOffer) {
        if (offer.isManualAmount && offer.manualAmount !== undefined) {
          const exchangeRate = originalOffer.exchangeRate || 1;
          return sum + (offer.manualAmount * exchangeRate);
        } else {
          return sum + (originalOffer.totalInYR || 0);
        }
      }
      return sum;
    }, 0);
    
    const totalInYRWords = convertNumberToArabicWords(totalInYR, 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ');
    return {
      totalAwardedInYR: totalInYR,
      totalAwardedInYRWords: totalInYRWords
    };
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
   * Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ­Ø³Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù„Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ø¡ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙ‚Ø·ØŒ ÙˆÙ„ÙŠØ³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶
   */
  const calculateAwardedAmount = (lineItems: OfferLineItem[], exchangeRate: number = 1) => {
    return lineItems.reduce((total, lineItem) => {
      if (lineItem.awarded || (lineItem.awardedQty && lineItem.awardedQty > 0)) {
        const awardedQty = lineItem.awardedQty || lineItem.offeredQty || 0;
        const unitPrice = lineItem.unitPriceAfterTax || lineItem.unitPrice || 0;
        return total + (awardedQty * unitPrice);
      }
      return total;
    }, 0) * exchangeRate;
  };

  // Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…ÙˆØ±Ø¯ Ù…Ù† Ø§Ù„ØªÙˆØµÙŠØ©
  const toggleVendorSelection = (vendor: string) => {
    const selectedOffer = priceOffers.find(offer => offer.vendor === vendor);
    if (!selectedOffer) return;

    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù„Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙ‚Ø·
    let awardedTotal = 0;
    const awardedLineNumbers: number[] = [];
    const awardedLineItems: any[] = [];
    // const awardedLineItems: OfferLineItem[] = [];

    if (selectedOffer.lineItems && selectedOffer.lineItems.length > 0) {
      selectedOffer.lineItems.forEach(lineItem => {
        if (lineItem.awarded || (lineItem.awardedQty && lineItem.awardedQty > 0)) {
          const awardedQty = lineItem.awardedQty || lineItem.offeredQty || 0;
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ
          const unitPrice = lineItem.unitPriceAfterTax || lineItem.unitPrice || 0;
          const lineTotal = awardedQty * unitPrice;
          
          awardedTotal += lineTotal;
          awardedLineNumbers.push(lineItem.lineNumber);
          
          // Ù†Ù‚Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø±
          awardedLineItems.push({
            lineNumber: lineItem.lineNumber,
            name: lineItem.name,
            unit: lineItem.unit,
            awardedQty: awardedQty,
            unitPrice: unitPrice,
            total: lineTotal,
            commitments: lineItem.commitments || [] // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø±
          });
        }
      });
    }

    // ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªÙØ§ØµÙŠÙ„ Ø£ØµÙ†Ø§ÙØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶
    if (awardedTotal === 0 && (!selectedOffer.lineItems || selectedOffer.lineItems.length === 0)) {
      awardedTotal = selectedOffer.total || 0;
    }

    const newOffer: RecommendedOffer = {
      vendor: selectedOffer.vendor,
      amount: awardedTotal, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ Ù„Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙ‚Ø·
      currency: selectedOffer.currency,
      amount: awardedTotal,
      currency: selectedOffer.currency, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ Ù„Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙ‚Ø·
      amountInWords: convertNumberToArabicWords(awardedTotal, selectedOffer.currency),
      isManualAmount: false,
      totalInYR: awardedTotal * (selectedOffer.exchangeRate || 1),
      awardedLineNumbers: awardedLineNumbers,
      lineItems: awardedLineItems
    };

    if (!recommendation) {
      const newSelectedOffers = [newOffer];
      const totals = updateTotalAwardedInYR(newSelectedOffers);
      setRecommendation({
        selectedOffers: newSelectedOffers,
        ...totals
      });
      return;
    }

    const existingOfferIndex = recommendation.selectedOffers.findIndex(
      offer => offer.vendor === vendor
    );
    
    let newSelectedOffers: RecommendedOffer[];
    if (existingOfferIndex >= 0) {
      newSelectedOffers = recommendation.selectedOffers.filter(
        offer => offer.vendor !== vendor
      );
    } else {
      newSelectedOffers = [...recommendation.selectedOffers, newOffer];
    }
    
    const totals = updateTotalAwardedInYR(newSelectedOffers);
    setRecommendation({
      selectedOffers: newSelectedOffers,
      ...totals
    });
  };

  // ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ù„Øº Ù…ÙˆØ±Ø¯
  const updateOfferAmount = (vendor: string, newAmount: number | undefined, isManual: boolean = true) => {
    if (!recommendation) return;
    
    const updatedOffers = recommendation.selectedOffers.map(offer => {
      if (offer.vendor === vendor) {
        const nextAmount = newAmount ?? offer.amount; // ensure number
        const updatedOffer: RecommendedOffer = {
          ...offer,
          amount: nextAmount,
          manualAmount: isManual ? newAmount : undefined,
          isManualAmount: isManual
        };
        return updateAmountInWords(updatedOffer);
      }
      return offer;
    });
    
    const totals = updateTotalAwardedInYR(updatedOffers);
    setRecommendation({
      selectedOffers: updatedOffers,
      ...totals
    });
  };

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  const resetOfferAmount = (vendor: string) => {
    const originalOffer = priceOffers.find(offer => offer.vendor === vendor);
    if (originalOffer) {
      updateOfferAmount(vendor, originalOffer.total, false);
      setManualAmounts(prev => ({ ...prev, [vendor]: formatNumberWithCommas(originalOffer.total) }));
    }
  };

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
  const matchingOffers = priceOffers.filter(offer =>
    (offer.result === 'Ù…Ø·Ø§Ø¨Ù‚' || offer.result === 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ') && offer.vendor
  );

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  const validatePreliminaryPrint = (): string | null => {
    const errors = [] as string[];
    if (!poNumber.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡');
    if (!transactionNumber.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
    if (!requesting?.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©');
    if (!beneficiary?.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©');
    
    const hasValidOffers = priceOffers.some(
      offer => offer.vendor && ((offer.total ?? 0) > 0) && offer.currency
    );
    if (!hasValidOffers) {
      errors.push('ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø§Ø³Ø¹Ø§Ø±');
    }
    
    return errors.length > 0 ? `ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ${errors.join(' - ')}` : null;
  };

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  const validateFinalPrint = (): string | null => {
    const errors = [] as string[];
    if (!poNumber.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡');
    if (!transactionNumber.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
    if (!requesting?.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©');
    if (!beneficiary?.trim()) errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©');
    if (!purchaseMethod?.trim()) errors.push('ØªØ­Ø¯ÙŠØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡');
    
    if (!recommendation || !recommendation.selectedOffers || recommendation.selectedOffers.length === 0) {
      errors.push('Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØµÙŠØ©');
    }
    
    const hasResults = priceOffers.every(offer => offer.vendor ? !!offer.result : true);
    if (!hasResults) {
      errors.push('Ø§Ø¯Ø®Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†');
    }
    
    // const hasExclusionReasons = excludedOffers.every(offer => offer.reason.trim());
    // if (excludedOffers.length > 0 && !hasExclusionReasons) {
    //   errors.push('Ø§Ø¯Ø®Ø§Ù„ Ø§Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯');
    // }
    
    return errors.length > 0 ? `ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ${errors.join(' - ')}` : null;
  };

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ØµÙ†ÙØ©
  const getCategorizedCommitments = (vendor: string) => {
    const offer = priceOffers.find(o => o.vendor === vendor);
    if (!offer) return { vendorLevel: [], lineLevel: [] };
    
    const vendorLevel = offer.commitments || [];
    const lineLevel = offer.lineItems
      ?.filter(item => (item.awarded || (item.awardedQty || 0) > 0) && item.commitments && item.commitments.length > 0)
      .map(item => ({
        lineNumber: item.lineNumber,
        commitments: item.commitments
      })) || [];
      
    return { vendorLevel, lineLevel };
  };

  // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
  const getDynamicSignatures = () => {
    const isPreliminaryMode = printType === 'preliminary';
    const amount = isPreliminaryMode ? calculateMaxOfferAmountInYR() : calculateTotalAwardedInYR();

    if (isPreliminaryMode) {
      if (amount <= 150000) {
        return [
          { title: "Ø§Ù„Ù…Ø®ØªØµ", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" }
        ];
      } else {
        return [
          { title: "Ø§Ù„Ù…Ø®ØªØµ", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" }
        ];
      }
    } else {
      if (amount <= 150000) {
        return [
          { title: "Ø§Ù„Ù…Ø®ØªØµ", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ù…Ø¯ÙŠØ± Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" }
        ];
      } else {
        return [
          { title: "Ø§Ù„Ù…Ø®ØªØµ", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ù…Ø¯ÙŠØ± Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" },
          { title: "Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†", name: "Ø§Ù„Ø§Ø³Ù…", role: "---------------------" }
        ];
      }
    }
  };

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø¨ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº
  const getRecipient = () => {
    const totalAwarded = calculateTotalAwardedInYR();
    return totalAwarded <= 150000 ? "Ø§Ù„Ø£Ø®/Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†" : "Ø§Ù„Ø£Ø®/Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ";
  };

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  const handlePreliminaryPrint = async () => {
    const validationError = validatePreliminaryPrint();
    if (validationError) {
      alert(validationError);
      return;
    }
    
    setPrintStatus('processing');
    setPrintType('preliminary');
    
    try {
      const saveSuccess = await savePurchaseOrder();
      if (!saveSuccess) {
        alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        setPrintStatus('error');
        setTimeout(() => setPrintStatus('idle'), 3000);
        return;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
      let newExcludedOffers = excludedOffers.filter(ex => {
        const offer = priceOffers.find(o => o.vendor === ex.vendor);
        return !(offer && offer.result === 'Ù…Ø·Ø§Ø¨Ù‚');
      });
      
      let addedCount = 0;
      priceOffers.forEach((offer) => {
        if (offer.vendor && offer.vendor.trim() !== '' && (offer.amount || 0) > 0) {
          if (offer.result !== 'Ù…Ø·Ø§Ø¨Ù‚') {
            if (!newExcludedOffers.some(excluded => excluded.vendor === offer.vendor)) {
              newExcludedOffers.push({
                id: `excluded-preliminary-${Date.now()}-${offer.vendor}`,
                vendor: offer.vendor,
                reason: '',
                notes: '',
              });
              addedCount++;
            }
          }
        }
      });
      
      if (addedCount > 0) {
        setExcludedOffers(newExcludedOffers);
        setTimeout(async () => {
          await savePurchaseOrder();
        }, 100);
      }
      
      setIsPreliminaryPrint(true);
      setPrintStatus('success');
      
      setTimeout(() => {
        window.print();
      }, 100);
    } catch (error) {
      console.error('Error during preliminary print:', error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©.');
      setPrintStatus('error');
      setTimeout(() => setPrintStatus('idle'), 3000);
    }
  };

  // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
  const generateVendorMessage = (vendor: string, type: 'awarded' | 'excluded'): string => {
    const offer = priceOffers.find(o => o.vendor === vendor);
    const selectedOffer = recommendation?.selectedOffers.find(s => s.vendor === vendor);
    const today = new Date().toLocaleDateString('ar-SA');
    
    if (type === 'awarded' && offer && selectedOffer) {
      const commitments = getCategorizedCommitments(vendor);
      
      let message = `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…\n\n`;
      message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}\n`;
      message += `Ø¥Ù„Ù‰: ${vendor}\n`;
      message += `Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø³ÙŠØ© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber}\n\n`;
      message += `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒ\n\n`;
      message += `Ù†ØªØ´Ø±Ù Ø¨Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ø¨Ø£Ù†Ù‡ ØªÙ… Ø§Ù„ØªØ±Ø³ÙŠØ© Ø¹Ù„ÙŠÙƒÙ… ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber} `;
      message += `Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${beneficiary} Ø¨Ù…Ø¨Ù„Øº Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¯Ø±Ù‡ `;
      message += `${formatNumberWithCommas(selectedOffer.isManualAmount ? selectedOffer.manualAmount || 0 : selectedOffer.amount || 0)} ${selectedOffer.currency}\n\n`;
      
      if (selectedOffer.awardedLineNumbers && selectedOffer.awardedLineNumbers.length > 0) {
        message += `Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§: ${selectedOffer.awardedLineNumbers.join(', ')}\n\n`;
      }
      
      // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
      if (selectedOffer.lineItems && selectedOffer.lineItems.length > 0) {
        message += `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§:\n\n`;
        selectedOffer.lineItems.forEach(item => {
          message += `- Ø§Ù„ØµÙ†Ù: ${item.name}\n`;
          message += `  Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.awardedQty} ${item.unit}\n`;
          message += `  Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: ${formatNumberWithCommas(item.unitPrice)} ${offer.currency}\n`;
          message += `  Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatNumberWithCommas(item.total)} ${offer.currency}\n`;
          
          if (item.commitments && item.commitments.length > 0) {
            message += `  Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: ${item.commitments.join(', ')}\n`;
          }
          
          message += `\n`;
        });
      }
      
      if (commitments.vendorLevel.length > 0) {
        message += `Ù…Ø¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¢ØªÙŠ:\n`;
        commitments.vendorLevel.forEach((commitment, index) => {
          message += `${index + 1}. ${commitment}\n`;
        });
        message += `\n`;
      }
      
      if (commitments.lineLevel.length > 0) {
        message += `Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø³Ø·Ø±:\n`;
        commitments.lineLevel.forEach(lineCommitment => {
          message += `Ø§Ù„Ø³Ø·Ø± ${lineCommitment.lineNumber}:\n`;
          (lineCommitment.commitments || []).forEach((commitment, index) => {
            message += `  ${index + 1}. ${commitment}\n`;
          });
        });
        message += `\n`;
      }
      
      message += `ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.\n\n`;
      message += `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ØŒ\n`;
      message += `Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†`;
      
      return message;
    } else if (type === 'excluded') {
      let message = `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…\n\n`;
      message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}\n`;
      message += `Ø¥Ù„Ù‰: ${vendor}\n`;
      message += `Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¯Ù… ØªØ±Ø³ÙŠØ© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber}\n\n`;
      message += `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒ\n\n`;
      message += `Ù†Ø´ÙƒØ±ÙƒÙ… Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØªÙƒÙ… ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber} `;
      message += `Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${beneficiary}.\n\n`;
      message += `Ù†Ø£Ø³Ù Ù„Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ø¨Ø£Ù†Ù‡ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ±Ø³ÙŠØ© Ø¹Ù„ÙŠÙƒÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ `;
      message += `Ù„Ø£Ø³Ø¨Ø§Ø¨ ÙÙ†ÙŠØ© ÙˆÙ…Ø§Ù„ÙŠØ©.\n\n`;
      message += `Ù†ØªØ·Ù„Ø¹ Ù„Ù„ØªØ¹Ø§ÙˆÙ† Ù…Ø¹ÙƒÙ… ÙÙŠ Ø§Ù„ÙØ±Øµ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.\n\n`;
      message += `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ØŒ\n`;
      message += `Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†`;
      
      return message;
    }
    
    return '';
  };

  // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©
  const generateFinancialMessage = (): string => {
    const today = new Date().toLocaleDateString('ar-SA');
    const totalAwarded = calculateTotalAwardedInYR();
    
    let message = `Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…\n\n`;
    message += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}\n`;
    message += `Ø¥Ù„Ù‰: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©\n`;
    message += `Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø³ÙŠØ© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber}\n\n`;
    message += `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒ\n\n`;
    message += `Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù†Ù‡ ØªÙ… Ø§Ù„ØªØ±Ø³ÙŠØ© ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø±Ù‚Ù… ${poNumber} `;
    message += `Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ${transactionNumber} Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${beneficiary}\n\n`;
    
    message += `ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ±Ø³ÙŠØ©:\n`;
    recommendation?.selectedOffers.forEach((offer, index) => {
      message += `${index + 1}. ${offer.vendor}: `;
      message += `${formatNumberWithCommas(offer.isManualAmount ? offer.manualAmount || 0 : offer.amount || 0)} ${offer.currency}`;
      
      const originalOffer = priceOffers.find(po => po.vendor === offer.vendor);
      if (offer.currency !== 'Ø±ÙŠØ§Ù„' && originalOffer) {
        const totalInYR = offer.isManualAmount && offer.manualAmount 
          ? offer.manualAmount * (originalOffer.exchangeRate || 1)
          : originalOffer.totalInYR || 0;
        message += ` (${formatNumberWithCommas(totalInYR)} Ø±ÙŠØ§Ù„)`;
      }
      message += `\n`;
      
      // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
      if (offer.lineItems && offer.lineItems.length > 0) {
        message += `   ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù:\n`;
        offer.lineItems.forEach(item => {
          message += `   - ${item.name}: ${item.awardedQty} ${item.unit} Ã— ${formatNumberWithCommas(item.unitPrice)} = ${formatNumberWithCommas(item.total)} ${offer.currency}\n`;
        });
      }
    });
    
    message += `\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatNumberWithCommas(totalAwarded)} Ø±ÙŠØ§Ù„\n`;
    message += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØªØ§Ø¨Ø©: ${convertNumberToArabicWords(totalAwarded, 'Ø±ÙŠØ§Ù„')}\n\n`;
    message += `ÙŠØ±Ø¬Ù‰ Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù„Ø§Ø²Ù…Ø©.\n\n`;
    message += `Ù…Ø¹ ØªØ­ÙŠØ§ØªÙ†Ø§ØŒ\n`;
    message += `Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†`;
    
    return message;
  };

  // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
  const copyMessageToClipboard = (message: string) => {
    navigator.clipboard.writeText(message).then(() => {
      alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
    }).catch(() => {
      const textArea = document.createElement('textarea');
      textArea.value = message;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
    });
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙŠ ØªÙ…Ù†Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
   * Ø§Ù„Ø¢Ù† Ø³ØªØ¹Ù…Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨Ø¹Ø¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£
   */
  const handleFinalPrint = async () => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const validationError = validateFinalPrint();
    if (validationError) {
      alert(validationError);
      return;
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    setPrintStatus('processing');
    setPrintType('final');
    
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØ±Ø±Ø©
      const duplicateCheck = await checkDuplicatePurchaseOrder(poNumber, transactionNumber);
      if (duplicateCheck.dataExists && !duplicateCheck.isDuplicate) {
        if (!window.confirm(duplicateCheck.message)) {
          setPrintStatus('idle');
          return;
        }
      } else if (duplicateCheck.isDuplicate) {
        alert(duplicateCheck.message);
        setPrintStatus('idle');
        return;
      }
      
      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      const saveSuccess = await savePurchaseOrder();
      if (!saveSuccess) {
        alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        setPrintStatus('error');
        setTimeout(() => setPrintStatus('idle'), 3000);
        return;
      }
      
      // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      setIsPreliminaryPrint(false);
      
      // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¶Ù…Ø§Ù† "user activation" Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      const proceedToPrint = window.confirm('Ø³ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ø¢Ù†. Ø§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.');
      if (!proceedToPrint) {
        setPrintStatus('idle');
        return;
      }
      
      // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¥Ø·Ø§Ø± Ø±Ø³Ù… ÙˆØ§Ø­Ø¯ (Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù…Ù†Ø¹ Ø£ÙŠ Ø­Ø¸Ø±)
      if (typeof window.requestAnimationFrame === 'function') {
        requestAnimationFrame(() => {
          setPrintStatus('success');
          window.print();
          // Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ afterprint Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† printType === 'final'
          // Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ `afterprint` Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† `printType === 'final'`
        });
      } else {
        setPrintStatus('success');
        window.print();
      }
    } catch (error) {
      console.error('Error during final print:', error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.');
      setPrintStatus('error');
      setTimeout(() => setPrintStatus('idle'), 3000);
    }
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„
   * Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ·Ø¨Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ù…Ø¹ Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§
   */
  const handleAdditionalPrinting = () => {
    if (!recommendation?.selectedOffers?.length) return;
    
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
    hours = hours % 12 || 12;
    const dateTimeStr = `${year}/${month}/${day} ${hours}:${minutes} ${ampm}`;
    
    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©
    const financialLetterContent = `
      <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right; padding: 6px; line-height: 1.2;">
        <div style="display: flex; justify-content: flex-start; align-items: center; font-size: 11px; margin: 2px 0 4px 0;">
          <div style="text-align: left;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateTimeStr}</div>
        </div>
        <div style="display: grid; grid-template-columns: 20% 55% 25%; align-items: center; text-align: center; margin-bottom: 2px;">
          <div style="border: 1px solid #000; padding: 2px 4px; font-size: 12px; text-align: right;">
            Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡: ${poNumber}
          </div>
          <h2 style="margin: 0; font-size: 18px; text-align: center;">Ø®Ù„Ø§ØµØ© ØµØ±Ù Ù…Ø³ØªØ­Ù‚Ø§Øª</h2>
          <div style="border: 1px solid #000; padding: 2px 4px; font-size: 12px; text-align: left;">
            Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${transactionNumber}
          </div>
        </div>
        <hr style="border: 1px solid #000; margin: 5px 0;">
        <p style="font-weight: bold; margin: 5px 0; display: flex; justify-content: space-between;">
        <p style="font-weight: bold; margin: 5px 0; display: flex; justify-content: space-between;" class="print:hidden">
          <span>Ø§Ù„Ø£Ø®/ Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span>
          <span style="margin-left: 35px;">Ø§Ù„Ù…Ø­ØªØ±Ù…</span>
        </p>
        <p style="margin: 5px 0; padding-right: 35px; font-size: 10px;">ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒØŒØŒ</p>
        <p style="margin: 5px 0;">Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚Ø© ${getRecipient()} Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù…ÙˆØ¬Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø¯Ø§Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:</p>
        <div style="margin: 10px 0; padding: 10px; border: 1px solid #000;">
          ${(recommendation?.selectedOffers ?? []).map(offer => {
            const originalOffer = priceOffers.find(po => po.vendor === offer.vendor);
            const totalInYR = offer.isManualAmount && offer.manualAmount 
              ? offer.manualAmount * (originalOffer?.exchangeRate || 1)
              : originalOffer?.totalInYR || 0;
              
            return `
              <p style="margin: 2px 0;"><strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${offer.vendor}</p>
              <p style="margin: 2px 0;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatNumberWithCommas(offer.isManualAmount ? offer.manualAmount || 0 : offer.amount || 0)} ${offer.currency} Ø´Ø§Ù…Ù„Ø§Ù‹ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£Ø®Ø±Ù‰</p>
              <p style="margin: 2px 0;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ:</strong> ${formatNumberWithCommas(totalInYR)} Ø±ÙŠØ§Ù„</p>
              
              ${offer.lineItems && offer.lineItems.length > 0 ? `
                <div style="margin: 5px 0;">
                  <p style="margin: 2px 0; font-weight: bold;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù:</p>
                  <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc; margin-top: 5px;">
                    <thead>
                      <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid #ccc; padding: 3px; text-align: right;">Ø§Ù„ØµÙ†Ù</th>
                        <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø·Ø±</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${offer.lineItems.map(item => {
                        const commitmentsText = (item.commitments && item.commitments.length > 0)
                          ? item.commitments.join('ØŒ ')
                          : 'â€”';
                        return `
                        <tr>
                          <td style="border: 1px solid #ccc; padding: 3px; text-align: right;">${item.name}</td>
                          <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${item.awardedQty} ${item.unit}</td>
                          <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${formatNumberWithCommas(item.unitPrice)} ${offer.currency}</td>
                          <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${formatNumberWithCommas(item.total)} ${offer.currency}</td>
                          <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${commitmentsText}</td>
                        </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              ` : ''}
              
              <hr style="border: 1px solid #ccc; margin: 5px 0;">
            `;
          }).join('')}
        </div>
        <p style="margin: 10px 0; text-align: right;">Ù…Ø¹ Ø®Ø§Ù„Øµ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§Ù…ØŒØŒØŒ</p>
        
        <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª -->
        <div style="margin-top: 20px;">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; gap: 10px;">
            <div>
              <div style="height: 3px; margin-bottom: 5px;"></div>
              <span>Ø§Ù„Ù…Ø®ØªØµ</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
            </div>
            <div>
              <div style="height: 3px; margin-bottom: 5px;"></div>
              <span>Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
            </div>
            <div>
              <div style="height: 3px; margin-bottom: 5px;"></div>
              <span>Ù…Ø¯ÙŠØ± Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
            </div>
            <div>
              <div style="height: 3px; margin-bottom: 5px;"></div>
              <span>Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    const selectedOffersForLetters = recommendation?.selectedOffers ?? [];
    const vendorLettersContent = selectedOffersForLetters.map(offer => {
      const originalOffer = priceOffers.find(po => po.vendor === offer.vendor);
      const commitments = getCategorizedCommitments(offer.vendor);
      
      return `
        <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right; padding: 6px; line-height: 1.2;">
          <div style="display: flex; justify-content: flex-start; align-items: center; font-size: 11px; margin: 2px 0 4px 0;">
            <div style="text-align: left;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateTimeStr}</div>
          </div>
          <div style="display: grid; grid-template-columns: 20% 55% 25%; align-items: center; text-align: center; margin-bottom: 2px;">
            <div style="border: 1px solid #000; padding: 2px 4px; font-size: 12px; text-align: right;">
              Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡: ${poNumber}
            </div>
            <h2 style="margin: 0; font-size: 18px; text-align: center;">Ø±Ø³Ø§Ù„Ø© ØªØ±Ø³ÙŠØ©</h2>
            <div style="border: 1px solid #000; padding: 2px 4px; font-size: 12px; text-align: left;">
              Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${transactionNumber}
            </div>
          </div>
          <hr style="border: 1px solid #000; margin: 5px 0;">
          <p style="font-weight: bold; margin: 5px 0; display: flex; justify-content: space-between;">
          <p style="font-weight: bold; margin: 5px 0; display: flex; justify-content: space-between;" class="print:hidden">
            <span>Ø§Ù„Ø£Ø®ÙˆÙ‡/ ${offer.vendor}</span>
            <span style="margin-left: 35px;">Ø§Ù„Ù…Ø­ØªØ±Ù…ÙˆÙ†</span>
          </p>
          <p style="margin: 5px 0; padding-right: 35px; font-size: 10px;">ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ØŒØŒØŒ</p>
          <p style="margin: 5px 0;">Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø£Ø¹Ù„Ø§Ù‡ØŒ Ù†ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù…ÙƒÙ… Ø¨ØªØ±Ø³ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠ:</p>
          <div style="margin: 10px 0; padding: 10px; border: 1px solid #000;">
            <p style="margin: 2px 0;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatNumberWithCommas(offer.isManualAmount ? offer.manualAmount || 0 : offer.amount || 0)} ${offer.currency} (Ø¨Ø§Ù„Ø£Ø­Ø±Ù: ${(offer.amountInWords || convertNumberToArabicWords((offer.isManualAmount ? (offer.manualAmount || 0) : (offer.amount || 0)), offer.currency))}) Ø´Ø§Ù…Ù„Ø§Ù‹ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£Ø®Ø±Ù‰</p>
            ${originalOffer?.currency !== 'Ø±ÙŠØ§Ù„' ? `
            ` : ''}
            ${offer.awardedLineNumbers && offer.awardedLineNumbers.length > 0 ? `
              <p style="margin: 10px 0 5px 0; font-weight: bold;">Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§: ${offer.awardedLineNumbers.join(', ')}</p>
            ` : ''}
            
            ${offer.lineItems && offer.lineItems.length > 0 ? `
              <div style="margin: 10px 0;">
                <p style="margin: 2px 0; font-weight: bold;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù:</p>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc; margin-top: 5px;">
                  <thead>
                    <tr style="background-color: #f0f0f0;">
                      <th style="border: 1px solid #ccc; padding: 3px; text-align: right;">Ø§Ù„ØµÙ†Ù</th>
                      <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                      <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                      <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                      <th style="border: 1px solid #ccc; padding: 3px; text-align: center;">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø·Ø±</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${offer.lineItems.map(item => `
                      <tr>
                        <td style="border: 1px solid #ccc; padding: 3px; text-align: right;">${item.name}</td>
                        <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${item.awardedQty} ${item.unit}</td>
                        <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${formatNumberWithCommas(item.unitPrice)} ${offer.currency}</td>
                        <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${formatNumberWithCommas(item.total)} ${offer.currency}</td>
                        <td style="border: 1px solid #ccc; padding: 3px; text-align: center;">${(item.commitments || []).join(', ') || 'â€”'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            ` : ''}
          </div>
          
          ${commitments.vendorLevel.length > 0 ? `
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
              <p style="margin: 2px 0; font-weight: bold;">Ù…Ø¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¢ØªÙŠ:</p>
              <ul style="margin: 2px 0; padding-right: 20px;">
                ${commitments.vendorLevel.map((commitment, idx) => `<li>${commitment}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          
          ${commitments.lineLevel.length > 0 ? `
            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
              <p style="margin: 2px 0; font-weight: bold;">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø³Ø·Ø±:</p>
              ${commitments.lineLevel.map(lineCommitment => `
                <div style="margin: 5px 0;">
                  <p style="margin: 2px 0; font-weight: bold;">Ø§Ù„Ø³Ø·Ø± ${lineCommitment.lineNumber}:</p>
                  <ul style="margin: 2px 0; padding-right: 20px;">
                    ${(lineCommitment.commitments || []).map((commitment, cidx) => `<li>${commitment}</li>`).join('')}
                  </ul>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <p style="margin: 10px 0; text-align: right;">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.</p>
          <p style="text-align: center; margin: 5px 0;">Ù…Ø¹ Ø®Ø§Ù„Øµ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§Ù…</p>
          
          <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª -->
          <div style="margin-top: 20px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; gap: 10px;">
              <div>
                <div style="height: 3px; margin-bottom: 5px;"></div>
                <span>Ø§Ù„Ù…Ø®ØªØµ</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
              </div>
              <div>
                <div style="height: 3px; margin-bottom: 5px;"></div>
                <span>Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
              </div>
              <div>
                <div style="height: 3px; margin-bottom: 5px;"></div>
                <span>Ù…Ø¯ÙŠØ± Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
              </div>
              <div>
                <div style="height: 3px; margin-bottom: 5px;"></div>
                <span>Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†</span><br><span>Ø§Ù„Ø§Ø³Ù…</span>
              </div>
            </div>
          </div>
        </div>
        ${selectedOffersForLetters.indexOf(offer) < selectedOffersForLetters.length - 1 ? '<div style="page-break-before: always;"></div>' : ''}
      `;
    }).join('');
    
    const printWindow = window.open('', '_blank');
    if (printWindow) {
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø¶Ø§ÙÙŠØ©</title>
          <style>
            @media print {
              @page { size: A4; margin: 5mm; }
              body { margin: 0; padding: 0; }
              body * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
              table { border-collapse: collapse; width: 100%; }
              th, td { padding: 3px; font-size: 10.5px; }
              h1, h2, h3 { margin: 4px 0; }
              p { margin: 2px 0; }
              hr { margin: 4px 0; }
              .page-break { page-break-before: always; }
            }
          </style>
        </head>
        <body>
          ${financialLetterContent}
          <div class="page-break"></div>
          ${vendorLettersContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }
  };

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
  const signatures = getDynamicSignatures();

  return (
    <div className="bg-white rounded-lg shadow-lg p-4 print:shadow-none print:p-2 border border-gray-200 print-container">
      <div className="flex items-center justify-between mb-4 print:hidden">
        <h2 className="text-xl font-semibold flex items-center text-gray-800">
          <Award className="ml-2" size={20} />
          Ø§Ù„ØªÙˆØµÙŠØ©
        </h2>
        <button
          onClick={() => setShowMessagesModal(true)}
          className="px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center text-sm"
        >
          <Mail size={16} className="ml-1" />
          Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        </button>
      </div>
      
      <div className="hidden print:block mb-4">
        <h2 className="text-xl font-bold text-center">Ø§Ù„ØªÙˆØµÙŠØ©:</h2>
      </div>
      
      <div className="border-2 border-gray-400 rounded-lg pt-2 print:border-2 print:border-black print:rounded-none">
        <div className="p-4 print:p-2 space-y-3 bg-gray-50 print:bg-white">
          <div className="flex items-center gap-2 print:block">
            <span className="font-medium">ØªÙˆØµÙŠ Ù„Ø¬Ù†Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø£Ù† ÙŠØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­Ø³Ø¨ Ø§ÙØ¶Ù„ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙˆØ§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹ Ù…Ù†:</span>
            <span className="font-medium">
              {recommendation?.selectedOffers?.length > 0
                ? recommendation.selectedOffers.map(o => o.vendor).join(' ÙˆÙ…Ù† ')
                : '__________________________________________________'}
            </span>
          </div>
          
          {recommendation?.selectedOffers?.some(o => (o.awardedLineNumbers || []).length > 0) && (
            <div className="text-sm text-gray-700 print:text-black space-y-1">
            <div className="text-sm text-gray-700 print:text-black space-y-1 print:hidden">
              {(recommendation?.selectedOffers ?? []).map((o: RecommendedOffer) => {
                const lines = (o.awardedLineNumbers || []).join('ØŒ ');
                if (!lines) return null;
                return (
                  <div key={o.vendor}>... ({o.vendor}) ÙˆØ°Ù„Ùƒ Ù„Ù„Ø³Ø·ÙˆØ± Ø±Ù‚Ù… {lines}</div>
                );
              })}
            </div>
            </div>
          )}
          
          <div className="space-y-4">
            <div className="space-y-3 print:hidden">
              {matchingOffers.map(offer => {
                const selectedOffer = recommendation?.selectedOffers?.find(s => s.vendor === offer.vendor);
                const isPartiallyMatched = offer.result === 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ';
                const commitments = getCategorizedCommitments(offer.vendor);
                
                return (
                  <div key={offer.id} className="border border-gray-200 rounded-lg p-3 bg-white">
                    <label className="flex items-center gap-3 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={!!selectedOffer}
                        onChange={() => toggleVendorSelection(offer.vendor)}
                        className="form-checkbox h-4 w-4 text-blue-600 rounded"
                      />
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="font-medium">{offer.vendor}</span>
                          <span className={`px-2 py-1 rounded text-sm ${offer.result === 'Ù…Ø·Ø§Ø¨Ù‚'
                            ? 'bg-green-100 text-green-800'
                            : 'bg-yellow-100 text-yellow-800'
                            }`}>
                            {offer.result}
                          </span>
                        </div>
                        
                        {!!selectedOffer && (
                          <div className="mt-2 p-2 bg-gray-50 rounded border">
                            <div className="grid grid-cols-1 md:grid-cols-[20%_15%_65%] gap-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                                {isPartiallyMatched ? (
                                  <div className="flex items-center gap-2">
                                    <input
                                      type="text"
                                      value={manualAmounts[offer.vendor] !== undefined ? manualAmounts[offer.vendor] : ''}
                                      onChange={(e) => {
                                        const rawValue = e.target.value.replace(/,/g, '');
                                        if (/^\d*(?:\.\d{0,2})?$/.test(rawValue) || rawValue === '') {
                                          setManualAmounts(prev => ({ ...prev, [offer.vendor]: rawValue }));
                                        }
                                      }}
                                      onBlur={() => {
                                        const rawValue = manualAmounts[offer.vendor] ?? '';
                                        const fixedRaw = toFixed2Raw(rawValue);
                                        if (fixedRaw !== '') {
                                          const parsedAmount = parseFloat(fixedRaw);
                                          updateOfferAmount(offer.vendor, parsedAmount, true);
                                          setManualAmounts(prev => ({ ...prev, [offer.vendor]: formatNumberWithCommas(parsedAmount) }));
                                        } else {
                                          updateOfferAmount(offer.vendor, undefined, true);
                                          setManualAmounts(prev => ({ ...prev, [offer.vendor]: '' }));
                                        }
                                      }}
                                      onFocus={() => {
                                        const amountValue = selectedOffer.isManualAmount ? selectedOffer.manualAmount : selectedOffer.amount;
                                        if (amountValue !== undefined && amountValue !== null) {
                                          setManualAmounts(prev => ({ ...prev, [offer.vendor]: toFixed2Raw(amountValue) }));
                                        }
                                      }}
                                      className="flex-1 border border-gray-300 rounded-md py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      style={{ fontFamily: 'Arial, sans-serif' }}
                                    />
                                  </div>
                                ) : (
                                  <input
                                    type="text"
                                    value={formatNumberWithCommas(offer.total)}
                                    readOnly
                                    className="w-full bg-gray-100 border border-gray-300 rounded-md py-1 px-2 text-sm"
                                    style={{ fontFamily: 'Arial, sans-serif' }}
                                  />
                                )}
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                                <input
                                  type="text"
                                  value={offer.currency}
                                  readOnly
                                  className="w-full bg-gray-100 border border-gray-300 rounded-md py-1 px-2 text-sm"
                                />
                              </div>
                              <div className="md:col-span-1">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©</label>
                                <input
                                  value={selectedOffer.amountInWords || ''}
                                  readOnly
                                  className={`w-full bg-gray-100 border border-gray-300 rounded-md py-1 px-2 text-sm amount-in-words ${(selectedOffer.amountInWords || '').length > 50 ? 'long-text' : ''}`}
                                />
                              </div>
                            </div>
                            
                            {/* Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª */}
                            {(commitments.vendorLevel.length > 0 || commitments.lineLevel.length > 0) && (
                              <div className="mt-3">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
                                <div className="bg-gray-100 p-2 rounded border text-sm">
                                  {commitments.vendorLevel.length > 0 && (
                                    <div className="mb-2">
                                      <strong>Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ø§Ù…Ø©:</strong>
                                      <ul className="list-disc pr-5 space-y-1 mt-1">
                                        {commitments.vendorLevel.map((commitment, idx) => (
                                          <li key={idx}>{commitment}</li>
                                        ))}
                                      </ul>
                                    </div>
                                  )}
                                  
                                  {commitments.lineLevel.length > 0 && (
                                    <div>
                                      <strong>Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø³Ø·Ø±:</strong>
                                      {commitments.lineLevel.map((lineCommitment, idx) => (
                                        <div key={idx} className="mt-1">
                                          <span className="font-medium">Ø§Ù„Ø³Ø·Ø± {lineCommitment.lineNumber}:</span>
                                          <ul className="list-disc pr-5 space-y-1 mt-1">
                                            {(lineCommitment.commitments || []).map((commitment, cidx) => (
                                              <li key={cidx}>{commitment}</li>
                                            ))}
                                          </ul>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                            
                            {/* Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ */}
                            {selectedOffer.lineItems && selectedOffer.lineItems.length > 0 && (
                              <div className="mt-3">
                                <label className="block text-sm font-medium text-gray-700 mb-1">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§:</label>
                                <div className="bg-gray-100 p-2 rounded border text-sm max-h-40 overflow-y-auto">
                                  <table className="w-full text-sm border-collapse border border-gray-300">
                                    <thead>
                                      <tr className="bg-gray-200">
                                        <th className="border border-gray-300 p-1 text-center">Ù…</th>
                                        <th className="border border-gray-300 p-1 text-right">Ø§Ù„ØµÙ†Ù</th>
                                        <th className="border border-gray-300 p-1 text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                        <th className="border border-gray-300 p-1 text-center">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                        <th className="border border-gray-300 p-1 text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                                        <th className="border border-gray-300 p-1 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        <th className="border border-gray-300 p-1 text-right">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø·Ø±</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {selectedOffer.lineItems.map((item: OfferLineItem, idx: number) => {
                                        const commitmentsText = (item.commitments && item.commitments.length > 0) ? item.commitments.join('ØŒ ') : 'â€”';
                                        return (
                                          <tr key={idx}>
                                            <td className="border border-gray-300 p-1 text-center">{idx + 1}</td>
                                            <td className="border border-gray-300 p-1 text-right">{item.name}</td>
                                            <td className="border border-gray-300 p-1 text-center">{item.awardedQty}</td>
                                            <td className="border border-gray-300 p-1 text-center">{item.unit}</td>
                                            <td className="border border-gray-300 p-1 text-center">{formatNumberWithCommas(item.unitPrice)}</td>
                                            <td className="border border-gray-300 p-1 text-center">{formatNumberWithCommas(item.total)}</td>
                                            <td className="border border-gray-300 p-1 text-right">{commitmentsText}</td>
                                          </tr>
                                        );
                                      })}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </label>
                  </div>
                );
              })}
              
              {(recommendation?.selectedOffers ?? []).length > 0 && (
                <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <div className="text-sm font-medium text-blue-800 mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡:</div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs font-medium text-blue-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ</label>
                      <div className="text-lg font-bold text-blue-900">
                        {formatNumberWithCommas(recommendation?.totalAwardedInYR || 0)} Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ
                      </div>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-blue-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©</label>
                      <div className="text-sm text-blue-800 bg-white p-2 rounded border">
                        {recommendation?.totalAwardedInYRWords || ''}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØµÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */}
            <div className="hidden print:block print:space-y-0">
              {printType === 'preliminary' ? (
                // Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                <div className="space-y-4">
                  {Array.from({ length: 3 }, (_, index) => (
                    <div key={index} className="flex gap-3 mb-6">
                      <div className="w-[25%]">
                        <span className="font-medium block">Ø¨Ù…Ø¨Ù„Øº(Ø±Ù‚Ù…Ø§Ù‹):__________________</span>
                      </div>
                      <div className="w-[15%]">
                        <span className="font-medium block">Ø§Ù„Ø¹Ù…Ù„Ø©:_____________</span>
                      </div>
                      <div className="w-[60%]">
                        <span className="font-medium block">Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©:___________________________________________________________</span>
                      </div>
                    </div>
                  ))}
                  
                  <div className="space-y-1 print:pb-4">
                    <p>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:__________________________________________________________________________________________________________________</p>
                    <p>____________________________________________________________________________________________________________________________</p>
                  </div>
                </div>
              ) : (
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                (recommendation?.selectedOffers ?? []).length > 0 ? (
                  (recommendation?.selectedOffers ?? []).map((offer, index: number) => {
                    const originalOffer = priceOffers.find(po => po.vendor === offer.vendor);
                    const commitments = getCategorizedCommitments(offer.vendor);
                    
                    return (
                      <div key={offer.vendor} className="mt-2">
                        <div className="border-b border-gray-300 pb-2 mb-2 last:border-b-0">
                          <div className="flex items-center gap-3 flex-wrap print-tight">
                            <span className="font-medium">
                              {index === 0 ? '' : 'ÙˆÙ…Ù†'} {offer.vendor}
                            </span>
                            <span className="text-gray-700">Ø¨Ù…Ø¨Ù„Øº</span>
                            <span className="font-medium">
                              {formatNumberWithCommas(
                                offer.isManualAmount ? offer.manualAmount || 0 : offer.amount || 0
                              )}
                            </span>
                            <span className="font-medium">{offer.currency}</span>
                            <span className="font-medium">Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©:</span>
                            <span className="flex-1 amount-in-words">{offer.amountInWords}</span>
                            <span className="text-sm text-gray-700">Ø´Ø§Ù…Ù„Ø§Ù‹ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£Ø®Ø±Ù‰</span>
                          </div>
                          
                          {offer.awardedLineNumbers && offer.awardedLineNumbers.length > 0 && (
                            <div className="mt-1 text-sm">
                              <span className="font-medium">Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§: </span>
                              {offer.awardedLineNumbers.join(', ')}
                            </div>
                          )}
                          
                          {/* Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ */}
                          {offer.lineItems && offer.lineItems.length > 0 && (
                            <div className="mt-2 overflow-x-auto">
                              <table className="w-full border border-gray-300 text-sm">
                                <thead className="bg-gray-100">
                                  <tr>
                                    <th className="border border-gray-300 px-2 py-1 text-right">Ø§Ù„ØµÙ†Ù</th>
                                    <th className="border border-gray-300 px-2 py-1 text-center">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§</th>
                                    <th className="border border-gray-300 px-2 py-1 text-center">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th className="border border-gray-300 px-2 py-1 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th className="border border-gray-300 px-2 py-1 text-right">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø·Ø±</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {offer.lineItems.map((li: OfferLineItem, idx: number) => {
                                    const commitmentsText = (li.commitments && li.commitments.length > 0) ? li.commitments.join('ØŒ ') : 'â€”';
                                    return (
                                      <tr key={idx}>
                                        <td className="border border-gray-300 px-2 py-1 text-right">{li.name}</td>
                                        <td className="border border-gray-300 px-2 py-1 text-center">{li.awardedQty} {li.unit}</td>
                                        <td className="border border-gray-300 px-2 py-1 text-center">{formatNumberWithCommas(li.unitPrice)} {offer.currency}</td>
                                        <td className="border border-gray-300 px-2 py-1 text-center">{formatNumberWithCommas(li.total)} {offer.currency}</td>
                                        <td className="border border-gray-300 px-2 py-1 text-right">{commitmentsText}</td>
                                      </tr>
                                    );
                                  })}
                                </tbody>
                              </table>
                            </div>
                          )}
                          
                          {/* Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ±Ø¯ */}
                          {commitments.vendorLevel.length > 0 && (
                            <div className="mt-2">
                              <p className="font-medium">Ù…Ø¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø§ØªÙŠ:</p>
                              <ul className="list-disc pr-5 text-sm">
                                {commitments.vendorLevel.map((commitment, idx) => (
                                  <li key={idx}>{commitment}</li>
                                ))}
                              </ul>
                            </div>
                          )}
                          
                          {/* Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø·Ø± */}
                          {commitments.lineLevel.length > 0 && (
                            <div className="mt-2">
                              <p className="font-medium">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø³Ø·Ø±:</p>
                              {commitments.lineLevel.map((lineCommitment, idx) => (
                                <div key={idx} className="mt-1">
                                  <span className="font-medium">Ø§Ù„Ø³Ø·Ø± {lineCommitment.lineNumber}:</span>
                                  <ul className="list-disc pr-5 text-sm">
                                    {(lineCommitment.commitments || []).map((commitment, cidx) => (
                                      <li key={cidx}>{commitment}</li>
                                    ))}
                                  </ul>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })
                ) : (
                  <div className="flex gap-3 mb-6">
                    <div className="w-[25%]">
                      <span className="font-medium block">Ø¨Ù…Ø¨Ù„Øº(Ø±Ù‚Ù…Ø§Ù‹):__________________</span>
                    </div>
                    <div className="w-[15%]">
                      <span className="font-medium block">Ø§Ù„Ø¹Ù…Ù„Ø©:_____________</span>
                    </div>
                    <div className="w-[60%]">
                      <span className="font-medium block">Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©:___________________________________________________________</span>
                    </div>
                  </div>
                )
              )}
            </div>
          </div>
        </div>
      </div>
      
      {/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
      <div className="mt-6 flex gap-4 print:hidden">
        <button
          onClick={handlePreliminaryPrint}
          disabled={printStatus === 'processing'}
          className="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
        >
          <Printer size={16} />
          <span>Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„ÙŠØ©</span>
        </button>
        <button
          onClick={handleFinalPrint}
          disabled={printStatus === 'processing'}
          className="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
        >
          <Printer size={16} />
          <span>Ø·Ø¨Ø§Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©</span>
        </button>
      </div>
      
      {/* Ù‚Ø³Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */}
      <div className="hidden print:block mt-2 space-y-2 print:mt-0 print:space-y-0">
        <div className="border-t border-gray-300 pt-2 print:my-0">
          <div className="grid gap-0 text-center" style={{ gridTemplateColumns: `repeat(${signatures.length}, minmax(0, 1fr))` }}>
            {signatures.map((signature, index) => (
              <div key={index} className="signature-box">
                <div className="signature-title">{signature.title}</div>
                <div className="signature-name">{signature.name}</div>
                <div className="text-xs text-gray-600">{signature.role}</div>
              </div>
            ))}
          </div>
        </div>
        
        {/* Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ø¨Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙ‚Ø·) */}
        {printType === 'final' && (
          <div className="hidden print:block border border-gray-300 rounded-lg p-2 mt-4 print:mt-2">
            <p className="font-medium pt-2 pb-1">Ø­ÙŠØ§ÙƒÙ… Ø§Ù„Ù„Ù‡..</p>
            <p>Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ¥Ø³ØªÙƒÙ…Ø§Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            <p className="text-center">ÙˆØ´ÙƒØ±Ø§Ù‹...</p>
            <div className="mt-2 font-bold text-left print:mt-0">
              <p className="font-medium">{getRecipient()}</p>
              <p className="font-medium">{getSignatoryForPrint()}</p>
              <p className="text-sm mt-2 print:mt-0">
                {calculateTotalAwardedInYR() > 150000 ? 'Ø§Ù„Ø§Ø³ØªØ§Ø°' : 'Ø§Ù„ØªÙˆÙ‚ÙŠØ¹'}
              </p>
            </div>
          </div>
        )}
        
        <div style={{ border: '1px solid #000', margin: '5px 0' }}></div>
      </div>
      
      {/* Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© */}
      {isPreliminaryPrint && (
        <div className="hidden print:block fixed top-4 left-2 text-red-600 font-bold text-xl transform -rotate-45 border-2 border-red-600 rounded-md p-2">
          Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„ÙŠØ©
        </div>
      )}
      
      {/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */}
      {showMessagesModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold flex items-center">
                  <Mail className="ml-2" size={20} />
                  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                </h3>
                <button
                  onClick={() => setShowMessagesModal(false)}
                  className="text-gray-500 hover:text-gray-700"
                >
                  <X size={24} />
                </button>
              </div>
              
              <div className="mb-6">
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => setMessageType('awarded')}
                    className={`px-4 py-2 rounded-md transition-colors ${
                      messageType === 'awarded' 
                        ? 'bg-green-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ù…
                  </button>
                  <button
                    onClick={() => setMessageType('excluded')}
                    className={`px-4 py-2 rounded-md transition-colors ${
                      messageType === 'excluded' 
                        ? 'bg-red-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†
                  </button>
                  <button
                    onClick={() => setMessageType('financial')}
                    className={`px-4 py-2 rounded-md transition-colors ${
                      messageType === 'financial' 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                  </button>
                </div>
                
                <div className="space-y-4">
                  {messageType === 'awarded' && recommendation?.selectedOffers.map(offer => (
                    <div key={`msg-awarded-${offer.vendor}`} className="border border-green-200 rounded-lg p-4 bg-green-50">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-semibold text-green-800">Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰: {offer.vendor}</h4>
                        <button
                          onClick={() => copyMessageToClipboard(generateVendorMessage(offer.vendor, 'awarded'))}
                          className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700"
                        >
                          Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                        </button>
                      </div>
                      <textarea
                        value={generateVendorMessage(offer.vendor, 'awarded')}
                        readOnly
                        className="w-full h-40 border border-green-300 rounded p-3 text-sm bg-white"
                      />
                    </div>
                  ))}
                  
                  {messageType === 'excluded' && priceOffers
                    .filter(offer => offer.vendor && offer.result !== 'Ù…Ø·Ø§Ø¨Ù‚')
                    .map(offer => (
                    <div key={`msg-excluded-${offer.vendor}`} className="border border-red-200 rounded-lg p-4 bg-red-50">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-semibold text-red-800">Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰: {offer.vendor}</h4>
                        <button
                          onClick={() => copyMessageToClipboard(generateVendorMessage(offer.vendor, 'excluded'))}
                          className="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700"
                        >
                          Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                        </button>
                      </div>
                      <textarea
                        value={generateVendorMessage(offer.vendor, 'excluded')}
                        readOnly
                        className="w-full h-40 border border-red-300 rounded p-3 text-sm bg-white"
                      />
                    </div>
                  ))}
                  
                  {messageType === 'financial' && (
                    <div className="border border-blue-200 rounded-lg p-4 bg-blue-50">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-semibold text-blue-800">Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                        <button
                          onClick={() => copyMessageToClipboard(generateFinancialMessage())}
                          className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                        >
                          Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                        </button>
                      </div>
                      <textarea
                        value={generateFinancialMessage()}
                        readOnly
                        className="w-full h-40 border border-blue-300 rounded p-3 text-sm bg-white"
                      />
                    </div>
                  )}
                </div>
              </div>
              
              <div className="flex justify-end">
                <button
                  onClick={() => setShowMessagesModal(false)}
                  className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                >
                  Ø¥ØºÙ„Ø§Ù‚
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};


; ====================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Ù…Ø³ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
// purchases_alamin7-copy5\src\components\ComparisonPage.tsx
; ======================================================================

import React, { useState, useEffect } from 'react';
import { usePurchaseOrder } from '../context/PurchaseOrderContext';
import { formatNumberWithCommas } from '../utils/numberToWords';

export const ComparisonPage: React.FC = () => {
  const {
    poNumber, // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ù† Ø§Ù„Ù€ context
    priceOffers,
    poItems,
    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    savePurchaseOrder,
    updatePriceOffer,
    // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙˆØ§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©
    estimatedCosts,
    setEstimatedCosts,
    itemSpecifications,
    setItemSpecifications
  } = usePurchaseOrder();

  // Ø­Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
  const [tempEstimatedCosts, setTempEstimatedCosts] = useState<{ [key: number]: number }>({});
  // Ø­Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
  const [tempSpecifications, setTempSpecifications] = useState<{ [key: number]: string }>({});

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†
  useEffect(() => {
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (estimatedCosts && Object.keys(estimatedCosts).length > 0) {
      setTempEstimatedCosts(estimatedCosts);
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ ØªÙƒØ§Ù„ÙŠÙ ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
      const defaultCosts = poItems.reduce((acc, item) => {
        acc[item.lineNumber] = 0;
        return acc;
      }, {} as { [key: number]: number });
      setTempEstimatedCosts(defaultCosts);
    }
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (itemSpecifications && Object.keys(itemSpecifications).length > 0) {
      setTempSpecifications(itemSpecifications);
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ§ØµÙØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
      const defaultSpecs = poItems.reduce((acc, item) => {
        acc[item.lineNumber] = '';
        return acc;
      }, {} as { [key: number]: string });
      setTempSpecifications(defaultSpecs);
    }
  }, [poItems, estimatedCosts, itemSpecifications]);

  // Ø¥Ø¶Ø§ÙØ© useEffect Ø¬Ø¯ÙŠØ¯ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙÙˆØ±Ù‹Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ù‡Ø§
  useEffect(() => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ§ØµÙØ§Øª ÙÙŠ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙˆØ±Ù‹Ø§
    if (priceOffers && priceOffers.length > 0) {
      console.log("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©");
      // Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
      const temp = [...priceOffers];
      // Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
      temp.forEach(offer => {
        if (offer.lineItems) {
          offer.lineItems.forEach(item => {
            if (item.vendorSpecifications) {
              // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø­Ø¯Ø«Ø©
              item.vendorSpecifications = { ...item.vendorSpecifications };
            }
          });
        }
      });
    }
  }, [priceOffers, poItems]);

  // Ø¥Ø¶Ø§ÙØ© useEffect Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
  // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù€ useEffect ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
useEffect(() => {
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
  const updateSpecifications = () => {
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
  };
  
  updateSpecifications();
}, [priceOffers, poItems]);

  // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„ØµÙ†Ù Ù…Ø¹ÙŠÙ† Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø©
  const getEstimatedCostForItem = (lineNumber: number) => {
    const item = poItems.find(item => item.lineNumber === lineNumber);
    if (!item || !item.estimatedCost) {
      return { amount: 0, currency: 'Ø±ÙŠØ§Ù„' };
    }
    return {
      amount: item.estimatedCost.amount || 0,
      currency: item.estimatedCost.currency || 'Ø±ÙŠØ§Ù„'
    };
  };

  // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  const getTotalEstimatedCost = () => {
    // Ø³Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø­Ø¯Ø©
    const totalsByCurrency: { [currency: string]: number } = {};

    poItems.forEach(item => {
      if (item.estimatedCost && item.estimatedCost.amount > 0) {
        const currency = item.estimatedCost.currency || 'Ø±ÙŠØ§Ù„';
        const amount = item.estimatedCost.amount * item.quantity;
        totalsByCurrency[currency] = (totalsByCurrency[currency] || 0) + amount;
      }
    });

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø¹Ù…Ù„Ø©
    const currencies = Object.keys(totalsByCurrency);
    if (currencies.length === 1) {
      return {
        amount: totalsByCurrency[currencies[0]],
        currency: currencies[0]
      };
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ù…Ù„Ø©ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„
    const totalInRiyal = Object.entries(totalsByCurrency).reduce((total, [currency, amount]) => {
      if (currency === 'Ø±ÙŠØ§Ù„') {
        return total + amount;
      }
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
      const offerWithRate = priceOffers.find(offer =>
        offer.currency === currency && offer.exchangeRate && offer.exchangeRate > 0
      );
      const exchangeRate = offerWithRate?.exchangeRate || 1;
      return total + (amount * exchangeRate);
    }, 0);

    return {
      amount: totalInRiyal,
      currency: 'Ø±ÙŠØ§Ù„'
    };
  };

  // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„ÙƒÙ„ ØµÙ†Ù (ØªØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¹Ø± ØµØ±Ù)
  const getEquivalentInRiyalForItem = (lineNumber: number) => {
    const item = poItems.find(item => item.lineNumber === lineNumber);
    if (!item || !item.estimatedCost) {
      return 0;
    }

    const { amount, currency } = item.estimatedCost;
    if (currency === 'Ø±ÙŠØ§Ù„') {
      // return amount * item.quantity;  // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø³Ø·Ø± 
      // ÙŠØ¹Ø¯Ù„ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø¯Ø© ÙÙ‚Ø· ÙƒÙ…Ø§ ÙŠÙ„ÙŠ 
      // =============================
      // ÙÙ‚Ø· Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙƒÙ…ÙŠØ©
      return amount ?? 0;
      // =================================
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
    const offerWithRate = priceOffers.find(offer =>
      offer.currency === currency && offer.exchangeRate && offer.exchangeRate > 0
    );

    if (offerWithRate && offerWithRate.exchangeRate) {
      // return (amount * item.quantity) * offerWithRate.exchangeRate;  // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø³Ø·Ø±
      // ÙŠØ¹Ø¯Ù„ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø¯Ø© ÙÙ‚Ø· ÙƒÙ…Ø§ ÙŠÙ„ÙŠ 
      // ======================================
      // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ã— Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
      return (amount ?? 0) * offerWithRate.exchangeRate;
      // ====================================
    }

    return 0; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¹Ø± ØµØ±ÙØŒ Ù†Ø±Ø¬Ø¹ 0
  };

  // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø£Ù‚Ù„ Ø³Ø¹Ø± Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„ÙƒÙ„ ØµÙ†Ù
  const getMinPriceInRiyal = (lineNumber: number) => {
    const validPrices = priceOffers
      .map(offer => {
        const lineItem = offer.lineItems?.find(li =>
          li.lineNumber === lineNumber || li.name === poItems.find(item => item.lineNumber === lineNumber)?.name
        );
        const unitPriceAfterTax = (lineItem?.unitPriceAfterTax ?? lineItem?.unitPrice) || 0;
        const exchangeRate = offer.currency === 'Ø±ÙŠØ§Ù„' ? 1 : (offer.exchangeRate || 0);
        return unitPriceAfterTax && exchangeRate ? unitPriceAfterTax * exchangeRate : null;
      })
      .filter(price => price !== null) as number[];
    return validPrices.length > 0 ? Math.min(...validPrices) : 0;
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„ØµÙ†Ù Ù…Ø¹ÙŠÙ†
  // const getVendorSpecification = (vendor: string, lineNumber: number) => {
  //   const offer = priceOffers.find(o => o.vendor === vendor);
  //   if (!offer || !offer.lineItems) return '';
  //   const lineItem = offer.lineItems.find(li =>
  //     li.lineNumber === lineNumber || li.name === poItems.find(item => item.lineNumber === lineNumber)?.name
  //   );

  //   // ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª - Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
  //   if (lineItem?.vendorSpecifications) {
  //     const specs = lineItem.vendorSpecifications;
  //     if (typeof specs === 'object' && specs !== null) {
  //       return Object.entries(specs)
  //         .filter(([key, value]) => value !== null && value !== undefined && String(value).trim() !== '')
  //         .map(([key, value]) => `â€¢ ${key}: ${value}`)
  //         .join('<br />');
  //     } else if (typeof specs === 'string' && specs.trim() !== '') {
  //       return specs;
  //     }
  //   }

  //   // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§ØªØŒ Ø¹Ø±Ø¶ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ØªØ§Ø­Ø© Ù…Ù† Ø§Ù„ØµÙ†Ù
  //   if (lineItem && Object.keys(lineItem).length > 0) {
  //     const otherInfo = [];
  //     // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§
  //     if ('description' in lineItem && lineItem.description) otherInfo.push(`Ø§Ù„ÙˆØµÙ: ${lineItem.description}`);
  //     if ('brand' in lineItem && lineItem.brand) otherInfo.push(`Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ${lineItem.brand}`);
  //     if ('model' in lineItem && lineItem.model) otherInfo.push(`Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${lineItem.model}`);
  //     if ('origin' in lineItem && lineItem.origin) otherInfo.push(`Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£: ${lineItem.origin}`);
  //     // Ø¥Ø¶Ø§ÙØ© Ø®ØµØ§Ø¦Øµ Ø¥Ø¶Ø§ÙÙŠØ© Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  //     if ('warranty' in lineItem && lineItem.warranty) otherInfo.push(`Ø§Ù„Ø¶Ù…Ø§Ù†: ${lineItem.warranty}`);
  //     if ('color' in lineItem && lineItem.color) otherInfo.push(`Ø§Ù„Ù„ÙˆÙ†: ${lineItem.color}`);
  //     if ('size' in lineItem && lineItem.size) otherInfo.push(`Ø§Ù„Ø­Ø¬Ù…: ${lineItem.size}`);
  //     if ('material' in lineItem && lineItem.material) otherInfo.push(`Ø§Ù„Ù…Ø§Ø¯Ø©: ${lineItem.material}`);
  //     if ('dimensions' in lineItem && lineItem.dimensions) otherInfo.push(`Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${lineItem.dimensions}`);
  //     if ('weight' in lineItem && lineItem.weight) otherInfo.push(`Ø§Ù„ÙˆØ²Ù†: ${lineItem.weight}`);

  //     if (otherInfo.length > 0) {
  //       return otherInfo.map(info => `â€¢ ${info}`).join('<br />');
  //     }
  //   }

  //   // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø¥Ø±Ø¬Ø§Ø¹ Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
  //   return 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ØµÙØ§Øª Ù…ØªØ§Ø­Ø©';
  // };

  // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
  // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„ØµÙ†Ù Ù…Ø¹ÙŠÙ†
  const getVendorSpecification = (vendor: string, lineNumber: number) => {
    const offer = priceOffers.find(o => o.vendor === vendor);
    if (!offer) return '';

    const lineItem = offer.lineItems?.find(li => li.lineNumber === lineNumber);
    if (!lineItem) return '';

    // ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª - Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
    if (lineItem.vendorSpecifications) {
      const specs = lineItem.vendorSpecifications;

      // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙƒØ§Ø¦Ù† ÙˆÙ„ÙŠØ³Øª ÙØ§Ø±ØºØ©
      if (typeof specs === 'object' && specs !== null && Object.keys(specs).length > 0) {
        return Object.entries(specs)
          .filter(([key, value]) => {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„ÙŠØ³Øª null Ø£Ùˆ undefined Ø£Ùˆ ÙØ§Ø±ØºØ©
            return value !== null && value !== undefined && String(value).trim() !== '';
          })
          .map(([key, value]) => `â€¢ ${key}: ${value}`)
          .join('<br />');
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØªÙ„Ù
    if (lineItem && typeof lineItem === 'object') {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø®ØµØ§Ø¦Øµ Ù‚Ø¯ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§Øª
      for (const key in lineItem) {
        if (key.includes('spec') || key.includes('Specification')) {
          const specValue = (lineItem as any)[key];
          if (specValue && typeof specValue === 'object' && Object.keys(specValue).length > 0) {
            return Object.entries(specValue)
              .filter(([_, value]) => value !== null && value !== undefined && String(value).trim() !== '')
              .map(([key, value]) => `â€¢ ${key}: ${value}`)
              .join('<br />');
          }
        }
      }
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§ØªØŒ Ø¹Ø±Ø¶ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ØªØ§Ø­Ø© Ù…Ù† Ø§Ù„ØµÙ†Ù
    if (lineItem && Object.keys(lineItem).length > 0) {
      const otherInfo = [];

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§
      if ('description' in lineItem && lineItem.description) otherInfo.push(`Ø§Ù„ÙˆØµÙ: ${lineItem.description}`);
      if ('brand' in lineItem && lineItem.brand) otherInfo.push(`Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ${lineItem.brand}`);
      if ('model' in lineItem && lineItem.model) otherInfo.push(`Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${lineItem.model}`);
      if ('origin' in lineItem && lineItem.origin) otherInfo.push(`Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£: ${lineItem.origin}`);
      if ('warranty' in lineItem && lineItem.warranty) otherInfo.push(`Ø§Ù„Ø¶Ù…Ø§Ù†: ${lineItem.warranty}`);
      if ('color' in lineItem && lineItem.color) otherInfo.push(`Ø§Ù„Ù„ÙˆÙ†: ${lineItem.color}`);
      if ('size' in lineItem && lineItem.size) otherInfo.push(`Ø§Ù„Ø­Ø¬Ù…: ${lineItem.size}`);
      if ('material' in lineItem && lineItem.material) otherInfo.push(`Ø§Ù„Ù…Ø§Ø¯Ø©: ${lineItem.material}`);
      if ('dimensions' in lineItem && lineItem.dimensions) otherInfo.push(`Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${lineItem.dimensions}`);
      if ('weight' in lineItem && lineItem.weight) otherInfo.push(`Ø§Ù„ÙˆØ²Ù†: ${lineItem.weight}`);

      if (otherInfo.length > 0) {
        return otherInfo.map(info => `â€¢ ${info}`).join('<br />');
      }
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø¥Ø±Ø¬Ø§Ø¹ Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
    return 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ØµÙØ§Øª Ù…ØªØ§Ø­Ø©';
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØµÙ†Ù Ù…Ø¹ÙŠÙ†
  const getRequiredSpecifications = (lineNumber: number) => {
    const item = poItems.find(item => item.lineNumber === lineNumber);
    if (!item?.specifications) return '';
    return Object.entries(item.specifications)
      .filter(([key, value]) => value && typeof value === 'string' && value.trim() !== '')
      .map(([key, value]) => `â€¢ ${key}: ${value}`)
      .join('<br />');
  };

  // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
  const convertToYemeniRiyal = (amount: number, currency: string) => {
    if (currency === 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ' || currency === 'Ø±ÙŠØ§Ù„') return amount;

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù…Ù† Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    const offerWithRate = priceOffers.find(offer =>
      offer.currency === currency && offer.exchangeRate && offer.exchangeRate > 0
    );

    if (offerWithRate && offerWithRate.exchangeRate) {
      return amount * offerWithRate.exchangeRate;
    }

    return amount; // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¹Ø± ØµØ±Ù
  };

  // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  const getVendorTotalOffer = (vendor: string) => {
    const offer = priceOffers.find(o => o.vendor === vendor);
    if (!offer) return 0;   // ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø±Ø¬Ø§Ø¹ 0 Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… totalAfterTax Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ ÙˆØ¥Ù„Ø§ Ø­Ø³Ø§Ø¨Ù‡ Ù…Ù† lineItems
    if (offer.totalAfterTax) {
      return offer.totalAfterTax;
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… total Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
    if (offer.total) {
      return offer.total;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù†Ø­Ø³Ø¨ Ù…Ù† lineItems
    if (offer.lineItems) {
      return offer.lineItems.reduce((total, lineItem) => {
        const poItem = poItems.find(item =>
          item.lineNumber === lineItem.lineNumber || item.name === lineItem.name
        );
        if (!poItem) return total;
        const unitPriceAfterTax = (lineItem?.unitPriceAfterTax ?? lineItem?.unitPrice) || 0;
        return total + (unitPriceAfterTax * (lineItem.offeredQty || poItem.quantity));
      }, 0);
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ø´ÙŠØ¡ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ
    return offer.amount || 0;
  };

  // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
  const getVendorTotalOfferInRiyal = (vendor: string) => {
    const offer = priceOffers.find(o => o.vendor === vendor);
    if (!offer) return 0;    // ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø±Ø¬Ø§Ø¹ 0 Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… totalInYR Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
    if (offer.totalInYR) {
      return offer.totalInYR;
    }

    // Ø­Ø³Ø§Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
    const total = getVendorTotalOffer(vendor);
    const currency = getVendorCurrency(vendor);

    if (currency === 'Ø±ÙŠØ§Ù„') {
      return total;
    }

    const exchangeRate = offer.exchangeRate || 1;
    return total * exchangeRate;
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù…Ù„Ø© Ø§Ù„Ù…ÙˆØ±Ø¯
  const getVendorCurrency = (vendor: string) => {
    const offer = priceOffers.find(o => o.vendor === vendor);
    return offer?.currency || 'Ø±ÙŠØ§Ù„';
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ§Ù„Ù…Ù‚Ø¯Ù…Ø©
  const getSpecificationDifferences = (vendor: string) => {
    const offer = priceOffers.find(o => o.vendor === vendor);
    if (!offer) return '';
    let differences = '';

    poItems.forEach(item => {
      const requiredSpecs = getRequiredSpecifications(item.lineNumber);
      const vendorSpecs = getVendorSpecification(vendor, item.lineNumber);

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…
      const estimatedCostInfo = getEstimatedCostForItem(item.lineNumber);
      const estimatedCost = estimatedCostInfo.amount;
      const estimatedCurrency = estimatedCostInfo.currency;

      const lineItem = offer.lineItems?.find(li =>
        li.lineNumber === item.lineNumber || li.name === item.name
      );
      const unitPriceAfterTax = (lineItem?.unitPriceAfterTax ?? lineItem?.unitPrice) || 0;
      const exchangeRate = offer.currency === 'Ø±ÙŠØ§Ù„' ? 1 : (offer.exchangeRate || 0);
      const unitPriceInRiyal = unitPriceAfterTax && exchangeRate ? unitPriceAfterTax * exchangeRate : 0;
      const offeredTotal = unitPriceInRiyal * (lineItem?.offeredQty || item.quantity);
      const estimatedTotal = estimatedCost * item.quantity;

      // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ±Ù‚
      let priceDifference = '';
      let priceStatus = '';
      if (estimatedTotal > 0 && offeredTotal > 0) {
        const percentageDiff = ((offeredTotal - estimatedTotal) / estimatedTotal) * 100;
        if (Math.abs(percentageDiff) < 0.01) {
          priceStatus = 'Ù…Ø·Ø§Ø¨Ù‚';
        } else if (percentageDiff > 0) {
          priceStatus = `Ø£Ø¹Ù„Ù‰ Ø¨Ù†Ø³Ø¨Ø© ${percentageDiff.toFixed(2)}%`;
        } else {
          priceStatus = `Ø£Ù‚Ù„ Ø¨Ù†Ø³Ø¨Ø© ${Math.abs(percentageDiff).toFixed(2)}%`;
        }
        priceDifference = `<p><strong>Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±:</strong> ${priceStatus}</p>`;
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
      if (!vendorSpecs || vendorSpecs === 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ØµÙØ§Øª Ù…ØªØ§Ø­Ø©') {
        differences += `<p><strong>Ø§Ù„ØµÙ†Ù ${item.lineNumber} - ${item.name}:</strong> Ù„Ù… ÙŠÙ‚Ø¯Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…ÙˆØ§ØµÙØ§Øª</p>`;
        differences += priceDifference;
      } else if (!requiredSpecs || requiredSpecs === '') {
        differences += `<p><strong>Ø§Ù„ØµÙ†Ù ${item.lineNumber} - ${item.name}:</strong> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</p>`;
        differences += priceDifference;
      } else if (requiredSpecs === vendorSpecs) {
        differences += `<p><strong>Ø§Ù„ØµÙ†Ù ${item.lineNumber} - ${item.name}:</strong> Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>`;
        differences += priceDifference;
      } else {
        differences += `<p><strong>Ø§Ù„ØµÙ†Ù ${item.lineNumber} - ${item.name}:</strong> ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ - ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙ„Ø§Ù Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</p>`;
        differences += `<div class="mr-4">`;
        differences += `<p class="text-sm"><strong>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong></p>`;
        differences += `<p class="text-sm">${requiredSpecs}</p>`;
        differences += `<p class="text-sm mt-2"><strong>Ø§Ù„Ù…Ù‚Ø¯Ù…:</strong></p>`;
        differences += `<p class="text-sm">${vendorSpecs}</p>`;
        differences += `</div>`;
        differences += priceDifference;
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (ÙŠØ³ØªØ®Ø¯Ù… lineItem Ø§Ù„Ù…Ø¹Ø±Ù Ø£Ø¹Ù„Ø§Ù‡)
      
      if (lineItem) {
        const requestedQty = item.quantity;
        const offeredQty = lineItem.offeredQty || 0;
        
        if (offeredQty < requestedQty) {
          const shortage = requestedQty - offeredQty;
          const shortagePercentage = ((shortage / requestedQty) * 100).toFixed(1);
          differences += `<p><strong>Ù†Ù‚Øµ ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ${requestedQty} ÙˆØ§Ù„Ù…Ù‚Ø¯Ù… ${offeredQty} (Ù†Ù‚Øµ ${shortage} ÙˆØ­Ø¯Ø© - ${shortagePercentage}%)</p>`;
        }
      } else {
        differences += `<p><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> Ù„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… ÙƒÙ…ÙŠØ© Ù„Ù„ØµÙ†Ù</p>`;
      }
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (offer.notes && offer.notes.includes('ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙ„Ø§Ù Ø¨ÙŠÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù')) {
      differences += `<p><strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶</p>`;
    }

    return differences;
  };

  return (
    <div className="bg-white rounded-lg shadow-lg p-4 print:shadow-none print:p-2 border border-gray-200 print:landscape">
      <h2 className="text-lg font-semibold mb-4 text-right">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h2>

      {/* Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø¹Ø±ÙˆØ¶ */}
      <div className="overflow-x-auto mb-8">
        <table className="w-full border-collapse border border-gray-300 text-sm">
          <thead>
            {/* Ø¹Ù†ÙˆØ§Ù† Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ */}
            <tr className="bg-gray-100">
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-2/10" colSpan={4}>
                <div className="text-sm font-semibold">Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡</div>
              </th>
              {priceOffers.map((offer, idx) => (
                <th
                  key={`vendor-${offer.id}`}
                  colSpan={3}
                  className={`border-2 border-gray-400 p-2 text-center w-6/10 ${idx % 2 === 0 ? 'bg-blue-100' : 'bg-indigo-100'}`}
                >
                  <div className="text-sm font-semibold">{offer.vendor || `Ø§Ù„Ø¹Ø±Ø¶ ${idx + 1}`}</div>
                </th>
              ))}
            </tr>
            {/* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */}
            <tr className="bg-gray-100">
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-2/10">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-2/10">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</th>
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-2/10">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-2/10">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„</th>
              {priceOffers.map((offer, idx) => (
                <React.Fragment key={`total-h-${offer.id}`}>
                  <th className={`border-2 border-gray-400 p-2 text-center w-2/10 ${idx % 2 === 0 ? 'bg-blue-100' : 'bg-indigo-100'}`}>
                    <div className="text-xs font-medium">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¶</div>
                  </th>
                  <th className={`border-2 border-gray-400 p-2 text-center w-2/10 ${idx % 2 === 0 ? 'bg-blue-100' : 'bg-indigo-100'}`}>
                    <div className="text-xs font-medium">Ø§Ù„Ø¹Ù…Ù„Ø©</div>
                  </th>
                  <th className={`border-2 border-gray-400 p-2 text-center w-2/10 ${idx % 2 === 0 ? 'bg-blue-100' : 'bg-indigo-100'}`}>
                    <div className="text-xs font-medium">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„</div>
                  </th>
                </React.Fragment>
              ))}
            </tr>
          </thead>
          <tbody>
            <tr>
              {/* ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… 1 */}
              <td className="border border-gray-300 p-2 text-center">{poNumber}</td>
              <td className="border border-gray-300 p-2 text-center">
                {formatNumberWithCommas(getTotalEstimatedCost().amount)} {getTotalEstimatedCost().currency}
              </td>
              <td className="border border-gray-300 p-2 text-center">{getTotalEstimatedCost().currency}</td>
              <td className="border border-gray-300 p-2 text-center">
                {formatNumberWithCommas(convertToYemeniRiyal(getTotalEstimatedCost().amount, getTotalEstimatedCost().currency))}
              </td>
              {priceOffers.map((offer, idx) => {
                const vendorTotal = getVendorTotalOffer(offer.vendor);
                const vendorTotalInRiyal = getVendorTotalOfferInRiyal(offer.vendor);
                const currency = getVendorCurrency(offer.vendor);
                return (
                  <React.Fragment key={`total-r-${offer.id}`}>
                    <td className="border border-gray-300 p-2 text-center">{formatNumberWithCommas(vendorTotal)}</td>
                    <td className="border border-gray-300 p-2 text-center">{currency}</td>
                    <td className="border border-gray-300 p-2 text-center">{formatNumberWithCommas(vendorTotalInRiyal)}</td>
                  </React.Fragment>
                );
              })}
            </tr>
          </tbody>
        </table>
      </div>

      {/* Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± */}
      <h2 className="text-lg font-semibold mb-4 text-right">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ØªÙØµÙŠÙ„ÙŠ</h2>
      <div className="overflow-x-auto mb-8">
        <table className="w-full border-collapse border border-gray-300 text-sm">
          <thead>
            {/* Ø¹Ù†ÙˆØ§Ù† Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© */}
            <tr className="bg-gray-100">
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-1/10" colSpan={5}>
                <div className="text-sm font-semibold">Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
              </th>
              {priceOffers.map((offer, idx) => (
                <th
                  key={`vh-${offer.id}`}
                  colSpan={3}
                  className={`border-2 border-gray-400 p-2 text-center w-3/10 ${idx % 2 === 0 ? 'bg-blue-100' : 'bg-indigo-100'}`}
                >
                  <div className="text-xs font-medium">{offer.vendor || `Ø§Ù„Ø¹Ø±Ø¶ ${idx + 1}`}</div>
                </th>
              ))}
            </tr>
            {/* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */}
            <tr className="bg-gray-50">
              <th className="border border-gray-300 p-1 text-center text-xs bg-gray-200 w-1/10">Ø§Ù„Ø³Ø·Ø±</th>
              <th className="border border-gray-300 p-1 text-center text-xs bg-gray-200 w-5/10">Ø§Ù„ØµÙ†Ù</th>
              <th className="border border-gray-300 p-1 text-center text-xs bg-gray-200 w-2/10">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th className="border border-gray-300 p-1 text-center text-xs bg-gray-200 w-2/10">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ÙˆØ­Ø¯Ø©</th>
              <th className="border border-gray-300 p-1 text-center text-xs bg-gray-200 w-2/10">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ù„Ù„ÙˆØ­Ø¯Ø©</th>
              {priceOffers.map((offer, idx) => (
                <React.Fragment key={`cols-${offer.id}`}>
                  <th className={`border border-gray-300 p-1 text-center text-xs w-2/10 ${idx % 2 === 0 ? 'bg-blue-50' : 'bg-indigo-50'}`}>
                    Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
                  </th>
                  <th className={`border border-gray-300 p-1 text-center text-xs w-3/10 ${idx % 2 === 0 ? 'bg-blue-50' : 'bg-indigo-50'}`}>
                    Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ({offer.currency || ''})
                  </th>
                  <th className={`border border-gray-300 p-1 text-center text-xs w-3/10 ${idx % 2 === 0 ? 'bg-blue-50' : 'bg-indigo-50'}`}>
                    Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø±ÙŠØ§Ù„)
                  </th>
                </React.Fragment>
              ))}
            </tr>
          </thead>
          <tbody>
            {poItems.map((item) => {
              const estimatedCost = getEstimatedCostForItem(item.lineNumber);
              const equivalentInRiyal = getEquivalentInRiyalForItem(item.lineNumber);
              const minPriceInRiyal = getMinPriceInRiyal(item.lineNumber);

              return (
                <tr key={`cmp-${item.lineNumber}`} className="hover:bg-gray-50">
                  {/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */}
                  <td className="border border-gray-300 p-2 text-center w-1/10">{item.lineNumber}</td>
                  <td className="border border-gray-300 p-2 w-5/10">{item.name}</td>
                  <td className="border border-gray-300 p-2 text-center w-2/10">{item.quantity}</td>
                  <td className="border border-gray-300 p-2 text-center w-2/10">
                    {formatNumberWithCommas(estimatedCost.amount)} {estimatedCost.currency}
                  </td>
                  <td className="border border-gray-300 p-2 text-center w-2/10">
                    {equivalentInRiyal > 0 ? formatNumberWithCommas(equivalentInRiyal) : '-'}
                  </td>

                  {/* Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ù„Ù„ØµÙ†Ù Ø§Ù„Ø­Ø§Ù„ÙŠ */}
                  {priceOffers.map((offer, idx) => {
                    const lineItem = offer.lineItems?.find(li =>
                      li.lineNumber === item.lineNumber || li.name === item.name
                    );
                    const qty = lineItem?.offeredQty || '';
                    const unitPriceAfterTax = (lineItem?.unitPriceAfterTax ?? lineItem?.unitPrice) || 0;
                    const exchangeRate = offer.currency === 'Ø±ÙŠØ§Ù„' ? 1 : (offer.exchangeRate || 0);
                    const unitPriceInRiyal = unitPriceAfterTax && exchangeRate ? unitPriceAfterTax * exchangeRate : 0;

                    // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø£Ù‚Ù„ Ø³Ø¹Ø±
                    const isMinPrice = unitPriceInRiyal === minPriceInRiyal && unitPriceInRiyal > 0;
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                    const isQuantityShort = lineItem && lineItem.offeredQty < item.quantity;

                    return (
                      <React.Fragment key={`row-${offer.id}-${item.lineNumber}`}>
                        <td className={`border border-gray-300 p-2 text-center w-2/10 ${isQuantityShort ? 'bg-red-100 text-red-700 font-semibold' : ''}`}>
                          {qty}
                          {isQuantityShort && (
                            <div className="text-xs text-red-600 mt-1">
                              Ù†Ù‚Øµ: {item.quantity - (lineItem?.offeredQty || 0)}
                            </div>
                          )}
                        </td>
                        <td className="border border-gray-300 p-2 text-center w-3/10">
                          {unitPriceAfterTax ? formatNumberWithCommas(unitPriceAfterTax) : ''}
                        </td>
                        <td className={`border border-gray-300 p-2 text-center w-3/10 ${isMinPrice ? 'bg-green-100 font-semibold' : ''}`}>
                          {unitPriceInRiyal ? formatNumberWithCommas(unitPriceInRiyal) : ''}
                        </td>
                      </React.Fragment>
                    );
                  })}
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª */}
      <h2 className="text-lg font-semibold mb-4 text-right mt-8">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</h2>
      <div className="overflow-x-auto mb-6">
        <table className="w-full border-collapse border border-gray-300 text-sm">
          <thead>
            <tr className="bg-gray-100">
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-2/10">Ø§Ù„Ø³Ø·Ø±</th>
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-3/10">Ø§Ù„ØµÙ†Ù</th>
              <th className="border-2 border-gray-400 p-2 bg-gray-200 w-3/10">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
              {priceOffers.map((offer, idx) => (
                <th
                  key={`spec-vh-${offer.id}`}
                  className={`border-2 border-gray-400 p-2 text-center w-4/10 ${idx % 2 === 0 ? 'bg-blue-100' : 'bg-indigo-100'}`}
                >
                  <div className="text-xs font-medium">{offer.vendor || `Ø§Ù„Ø¹Ø±Ø¶ ${idx + 1}`}</div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {poItems.map((item) => (
              <tr key={`spec-${item.lineNumber}`} className="hover:bg-gray-50">
                <td className="border border-gray-300 p-2 text-center w-2/10">{item.lineNumber}</td>
                <td className="border border-gray-300 p-2 w-3/10">{item.name}</td>
                {/* <td className="border border-gray-300 p-2 w-3/10"> */}
                  {/* Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù */}
                  {/* <div
                    className="text-sm p-2 bg-gray-50 rounded"
                    dangerouslySetInnerHTML={{ __html: getRequiredSpecifications(item.lineNumber) || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø­Ø¯Ø¯Ø©' }}
                  />
                </td> */}
                {/* ØªØ¹Ø¯ÙŠÙ„ ÙƒÙŠÙÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */}
                 {/* ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ */}
                <td className="border border-gray-300 p-2 w-3/10">
                  <div
                    className="text-sm p-2 bg-gray-50 rounded"
                    dangerouslySetInnerHTML={{ 
                      __html: getRequiredSpecifications(item.lineNumber) || 
                            '<span class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ØµÙØ§Øª Ù…Ø­Ø¯Ø¯Ø©</span>' 
                    }}
                  />
                </td>
                {/* Ø¹Ø±Ø¶ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† */}
                {priceOffers.map((offer, idx) => (
                  <td
                    key={`spec-row-${offer.id}-${item.lineNumber}`}
                    className={`border border-gray-300 p-2 w-4/10 ${idx % 2 === 0 ? 'bg-blue-50' : 'bg-indigo-50'}`}
                  >
                    {/* Ø¹Ø±Ø¶ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ */}
                    <div
                      className="text-sm"
                      dangerouslySetInnerHTML={{
                        __html: getVendorSpecification(offer.vendor, item.lineNumber) || 'Ù„Ù… ÙŠÙ‚Ø¯Ù… Ù…ÙˆØ§ØµÙØ§Øª'
                      }}
                    />
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù„ÙƒÙ„ Ù…ÙˆØ±Ø¯ */}
      <div className="mt-6">
        <h3 className="font-medium mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª:</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {priceOffers.map((offer, idx) => (
            <div key={`notes-${offer.id}`} className="border border-gray-300 rounded p-3">
              <h4 className="font-medium mb-2">{offer.vendor || `Ø§Ù„Ø¹Ø±Ø¶ ${idx + 1}`}</h4>
              <div
                className="text-sm"
                dangerouslySetInnerHTML={{
                  __html: getSpecificationDifferences(offer.vendor) || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªÙ„Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª'
                }}
              />
            </div>
          ))}
        </div>
      </div>

      {/* Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© ØªØ­Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */}
      <div className="mt-6">
        <p className="font-medium">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</p>
        <div className="border-b border-gray-300 border-dashed pb-1 mb-2"></div>
      </div>
    </div>
  );
};

; ====================================================================

Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¯Ø³ ØµÙØ­Ø© Ø§Ù„Ø§ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
// purchases_alamin7-copy5\src\components\PurchaseOrderItems.tsx
; ========================================================================

// Ù…ÙƒÙˆÙ† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§Øª ÙˆØ§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©
import React, { useState, useEffect, useRef } from 'react';
import { Plus, Search, Edit, Save, X, Package, Calculator, FileText } from 'lucide-react';
import { usePurchaseOrder } from '../context/PurchaseOrderContext';
import { PurchaseOrderItem } from '../types';
import { useDebounce } from '../hooks/useDebounce';
import { searchItemsByCodePart, searchItemsByNamePart, getItemNameByCodeExact, toDisplayItem } from '../utils/itemCatalog';

export const PurchaseOrderItems: React.FC = () => {
  const {
    poItems,
    setPoItems,
    savePurchaseOrder,
    priceOffers,
    hasUnsavedChanges
  } = usePurchaseOrder();

  // Ø­Ø§Ù„Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù
  const [editingItem, setEditingItem] = useState<string | null>(null);
  const [searchResults, setSearchResults] = useState<any[]>([]);
  const [showSearchResults, setShowSearchResults] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [isSearching, setIsSearching] = useState(false);

  // Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„ÙƒÙ„ ØµÙ†Ù Ù…Ù†ÙØµÙ„
  const [tempItemData, setTempItemData] = useState<{
    [key: string]: {
      estimatedCost: { amount: number; currency: string; equivalentInYR: number };
      specifications: { [key: string]: string | undefined };
    };
  }>({});

  // Ù…Ø±Ø§Ø¬Ø¹ Ù„Ù„Ø­Ù‚ÙˆÙ„
  const searchInputRef = useRef<HTMLInputElement>(null);

  // ğŸŸ¢ ØªØ¹Ø±ÙŠÙ Ù‚Ø§Ø¦Ù…Ø© ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³
  const unitOptions = [
    'Each', 'Meter', 'Liter', 'Set', 'Kilogram', 'CAN', 'Galons', 'CRT',
    'Kilometer', 'Dabba', 'Packet', 'Kit', 'TON', 'Ù„ÙØ©', 'Ø¨Ø¯Ù„Ø©', 'Ø·Ø¨'
  ];

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… useDebounce Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  const debouncedSearchQuery = useDebounce(searchQuery, 300);

  /**
   * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ† Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„Ø£ØµÙ†Ø§Ù
   * ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ ØµÙ†Ù Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„
   */
  useEffect(() => {
    const initTempData = () => {
      const newTempData: {
        [key: string]: {
          estimatedCost: { amount: number, currency: string, equivalentInYR: number },
          specifications: { [key: string]: string | undefined }
        }
      } = {};
      
      poItems.forEach(item => {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„ÙƒÙ„ ØµÙ†Ù Ù…Ù†ÙØµÙ„
        if (item.estimatedCost) {
          newTempData[item.id] = {
            estimatedCost: {
              amount: item.estimatedCost.amount,
              currency: item.estimatedCost.currency,
              equivalentInYR: item.estimatedCost.equivalentInYR || 0
            },
            specifications: item.specifications ? { ...item.specifications } : {}
          };
        } else {
          newTempData[item.id] = {
            estimatedCost: { amount: 0, currency: 'Ø±ÙŠØ§Ù„', equivalentInYR: 0 },
            specifications: {}
          };
        }
      });
      
      setTempItemData(newTempData);
    };
    
    initTempData();
  }, [poItems]);

  /**
   * Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø­Ø³Ù† - ÙŠØ­ÙØ¸ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
   */
  useEffect(() => {
    const autoSaveTimer = setTimeout(async () => {
      if (poItems.length > 0 && hasUnsavedChanges) {
        try {
          await savePurchaseOrder();
          console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
          console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
        }
      }
    }, 2000);
    
    return () => clearTimeout(autoSaveTimer);
  }, [poItems, hasUnsavedChanges, savePurchaseOrder]);

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø­Ø³Ù†Ø© - ØªØ¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
   * ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
   */
  useEffect(() => {
    const performAutoSearch = async () => {
      if (!debouncedSearchQuery.trim() || debouncedSearchQuery.length < 2) {
        setSearchResults([]);
        setShowSearchResults(false);
        return;
      }
      
      setIsSearching(true);
      
      try {
        let results: any[] = [];
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ø£ÙˆÙ„Ø§Ù‹ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù…)
        if (/\d/.test(debouncedSearchQuery)) {
          results = await searchItemsByCodePart(debouncedSearchQuery);
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø£Ùˆ Ø§Ù„Ù†Øµ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù…ØŒ Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
        if (results.length === 0) {
          results = await searchItemsByNamePart(debouncedSearchQuery);
        }
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¹Ø±Ø¶ Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø£ÙØ¶Ù„ 15 Ù†ØªÙŠØ¬Ø©
        const displayResults = results.slice(0, 15).map(toDisplayItem);
        setSearchResults(displayResults);
        setShowSearchResults(displayResults.length > 0);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
        setSearchResults([]);
        setShowSearchResults(false);
      } finally {
        setIsSearching(false);
      }
    };
    
    performAutoSearch();
  }, [debouncedSearchQuery]);

  /**
   * Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
   */
  const handleAddItem = () => {
    // ØªØ¹Ø¯ÙŠÙ„ ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø³Ø·Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - ÙŠØ¨Ø¯Ø£ Ù…Ù† 1 ÙˆÙŠØ²Ø¯Ø§Ø¯ Ù…Ø¹ ÙƒÙ„ Ø¥Ø¶Ø§ÙØ©
    const newLineNumber = poItems.length > 0
      ? Math.max(...poItems.map(item => item.lineNumber)) + 1
      : 1;
      
    const newItem: PurchaseOrderItem = {
      id: `item-${Date.now()}`,
      code: '',
      name: '',
      quantity: 0, // ØªØ¹Ø¯ÙŠÙ„: Ø¬Ø¹Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙØ§Ø±ØºØ© (0) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 1
      unit: '', // ØªØ¹Ø¯ÙŠÙ„: Ø¬Ø¹Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© ÙØ§Ø±ØºØ©
      selected: true,
      lineNumber: newLineNumber,
      estimatedCost: {
        amount: 0,
        currency: 'Ø±ÙŠØ§Ù„',
        equivalentInYR: 0
      },
      specifications: {},
      poNumber: 0
    };
    
    setPoItems([...poItems, newItem]);
    setEditingItem(newItem.id);
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
    setTempItemData(prev => ({
      ...prev,
      [newItem.id]: {
        estimatedCost: { amount: 0, currency: 'Ø±ÙŠØ§Ù„', equivalentInYR: 0 },
        specifications: {}
      }
    }));
  };

  /**
   * Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ØµÙ†Ù Ù…Ø¹ Ø­ÙØ¸ ÙÙˆØ±ÙŠ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
   */
  const handleUpdateItem = (id: string, updates: Partial<PurchaseOrderItem>) => {
    setPoItems(poItems.map(item =>
      item.id === id ? { ...item, ...updates } : item
    ));
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø°Ù ØµÙ†Ù Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
   */
  const handleRemoveItem = (id: string) => {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')) {
      setPoItems(poItems.filter(item => item.id !== id));
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø­Ø°ÙˆÙ
      const newTempData = { ...tempItemData };
      delete newTempData[id];
      setTempItemData(newTempData);
    }
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   * ØªØ­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ ØµÙ†Ù
   */
  const handleSaveItem = async (id: string) => {
    const item = poItems.find(item => item.id === id);
    if (!item) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    if (!item.name.trim()) {
      alert('âš ï¸ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ù…Ø·Ù„ÙˆØ¨');
      return;
    }
    
    // ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„ÙˆØ­Ø¯Ø©
    if (!item.quantity || item.quantity <= 0) {
      alert('âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
      return;
    }
    
    if (!item.unit || item.unit.trim() === '') {
      alert('âš ï¸ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨Ø©');
      return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„
    const costData = tempItemData[id]?.estimatedCost;
    if (costData) {
      const equivalentInYR = calculateEquivalentInYR(costData.amount, costData.currency);
      handleUpdateItem(id, {
        estimatedCost: {
          amount: costData.amount,
          currency: costData.currency,
          equivalentInYR
        }
      });
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
    const specsData = tempItemData[id]?.specifications;
    if (specsData) {
      handleUpdateItem(id, {
        specifications: { ...specsData }
      });
    }
    
    setEditingItem(null);
    await savePurchaseOrder();
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶
   * ØªØ±Ø¨Ø· Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
   */
  const calculateEquivalentInYR = (amount: number, currency: string): number => {
    if (currency === 'Ø±ÙŠØ§Ù„') return amount;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù…Ù† Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
    const offerWithRate = priceOffers.find(offer =>
      offer.currency === currency && offer.exchangeRate && offer.exchangeRate > 0
    );
    
    if (offerWithRate && offerWithRate.exchangeRate) {
      return amount * offerWithRate.exchangeRate;
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø³Ø¹Ø± ØµØ±ÙØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø¹ ØªØ­Ø°ÙŠØ±
    console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¹Ø± ØµØ±Ù Ù„Ù„Ø¹Ù…Ù„Ø© ${currency}`);
    return amount;
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
   * ØªØ¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ
   */
  const handleItemNameChange = async (id: string, value: string) => {
    handleUpdateItem(id, { name: value });
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù…ØŒ Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ø£ÙˆÙ„Ø§Ù‹
    if (/\d/.test(value) && value.length >= 3) {
      try {
        const foundName = await getItemNameByCodeExact(value);
        if (foundName) {
          handleUpdateItem(id, {
            code: value,
            name: foundName
          });
          return; // ØªÙˆÙ‚Ù Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„
        }
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù:', error);
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø¨Ø­Ø« Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    setSearchQuery(value);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   */
  const handleSelectSearchResult = async (result: any) => {
    if (editingItem) {
      const itemName = result.name || '';
      const itemCode = result.code || '';
      
      handleUpdateItem(editingItem, {
        code: itemCode,
        name: itemName
      });
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    setSearchQuery('');
    setSearchResults([]);
    setShowSearchResults(false);
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØµÙ†Ù Ù…Ø­Ø¯Ø¯
   */
  const handleAddSpecification = (itemId: string, key: string, value: string) => {
    setTempItemData(prev => ({
      ...prev,
      [itemId]: {
        ...prev[itemId],
        specifications: {
          ...prev[itemId]?.specifications,
          [key]: value
        }
      }
    }));
  };

  /**
   * Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù…ÙˆØ§ØµÙØ© Ù…Ù† ØµÙ†Ù Ù…Ø­Ø¯Ø¯
   */
  const handleRemoveSpecification = (itemId: string, key: string) => {
    setTempItemData(prev => {
      const newSpecs = { ...prev[itemId]?.specifications };
      delete newSpecs[key];
      
      return {
        ...prev,
        [itemId]: {
          ...prev[itemId],
          specifications: newSpecs
        }
      };
    });
  };

  /**
   * Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ ÙˆØ­ÙØ¸ ÙÙˆØ±ÙŠ
   */
  const handleUpdateEstimatedCost = (itemId: string, field: 'amount' | 'currency', value: any) => {
    setTempItemData(prev => {
      const currentCost = prev[itemId]?.estimatedCost || { amount: 0, currency: 'Ø±ÙŠØ§Ù„', equivalentInYR: 0 };
      const updatedCost = { ...currentCost, [field]: value };
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„Ø©
      if (field === 'amount' || field === 'currency') {
        updatedCost.equivalentInYR = calculateEquivalentInYR(
          field === 'amount' ? value : updatedCost.amount,
          field === 'currency' ? value : updatedCost.currency
        );
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ
      const item = poItems.find(item => item.id === itemId);
      if (item) {
        handleUpdateItem(itemId, {
          estimatedCost: updatedCost
        });
      }
      
      return {
        ...prev,
        [itemId]: {
          ...prev[itemId],
          estimatedCost: updatedCost
        }
      };
    });
  };

  return (
    <div className="bg-white rounded-lg shadow-lg p-4 mb-4 border border-gray-200 print:mb-0 print-container">
      {/* Ø±Ø£Ø³ Ø§Ù„Ù‚Ø³Ù… Ù…Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */}
      <div className="flex items-center justify-between mb-4 print:mb-2">
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-semibold flex items-center text-gray-800">
            <Package className="ml-2 icon" size={20} />
            Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          </h2>
          
          {/* Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© */}
          <div className="flex items-center gap-4 text-sm text-gray-600 print:hidden">
            <span>Ø§Ù„Ø¹Ø¯Ø¯: {poItems.length}</span>
            <span>Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: {poItems.filter(item => item.name && item.quantity > 0).length}</span>
          </div>
        </div>
        
        <button
          onClick={handleAddItem}
          className="py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center shadow-sm print:hidden"
        >
          <Plus size={18} className="ml-1" />
          Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
        </button>
      </div>
      
      {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */}
      <div className="overflow-x-auto print:overflow-visible">
        <table className="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
          <thead>
            <tr className="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
              <th className="py-3 px-2 text-center font-semibold border border-gray-300" style={{ width: '5%' }}>
                Ø§Ù„Ø³Ø·Ø±
              </th>
              
              {/* Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ù…Ø®ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
              <th className="py-3 px-2 text-center font-semibold border border-gray-300 print:hidden" style={{ width: '5%' }}>
                Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù
              </th>
              
              {/* ØªØ¹Ø¯ÙŠÙ„: Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø¨ÙŠØ§Ù† Ø§Ù„ØµÙ†Ù Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
              <th className="py-3 px-2 text-center font-semibold border border-gray-300 print:py-1 print:border-2" style={{ width: '45%' }}>
                Ø¨ÙŠØ§Ù† Ø§Ù„ØµÙ†Ù
              </th>
              
              {/* ØªØ¹Ø¯ÙŠÙ„: Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
              <th className="py-3 px-2 text-center font-semibold border border-gray-300" style={{ width: '10%' }}>
                Ø§Ù„ÙƒÙ…ÙŠØ©
              </th>
              
              {/* ØªØ¹Ø¯ÙŠÙ„: Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
              <th className="py-3 px-2 text-center font-semibold border border-gray-300" style={{ width: '10%' }}>
                Ø§Ù„ÙˆØ­Ø¯Ø©
              </th>
              
              {/* ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
              <th className="py-3 px-2 text-center font-semibold border border-gray-300 print:hidden" style={{ width: '12%' }}>
                Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©
              </th>
              
              {/* ØªØ¹Ø¯ÙŠÙ„: Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
              <th className="py-3 px-2 text-center font-semibold border border-gray-300" style={{ width: '30%' }}>
                Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
              </th>
              
              <th className="py-3 px-2 text-center font-semibold border border-gray-300 print:hidden" style={{ width: '8%' }}>
                Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
              </th>
            </tr>
          </thead>
          
          <tbody>
            {poItems.map((item) => (
              <tr key={item.id} className="hover:bg-blue-50 transition-colors">
                {/* Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± */}
                <td className="py-3 px-2 border border-gray-300 text-center print:py-1">
                  {/* Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· ÙˆÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ */}
                  <span className="font-medium">{item.lineNumber}</span>
                </td>
                
                {/* Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù - Ù…Ø®ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
                <td className="py-3 px-2 border border-gray-300 print:py-1 print:hidden">
                  {editingItem === item.id ? (
                    <input
                      type="text"
                      value={item.code || ''}
                      onChange={(e) => {
                        handleUpdateItem(item.id, { code: e.target.value });
                        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù
                        setSearchQuery(e.target.value);
                      }}
                      className="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                      placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù"
                      style={{ fontFamily: 'Arial, sans-serif' }}
                    />
                  ) : (
                    <span style={{ fontFamily: 'Arial, sans-serif' }}>{item.code || '-'}</span>
                  )}
                </td>
                
                {/* Ø¨ÙŠØ§Ù† Ø§Ù„ØµÙ†Ù Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† ÙˆÙ…Ø³Ø§Ø­Ø© Ø£ÙƒØ¨Ø± */}
                <td className="py-3 px-2 border border-gray-300 print:py-1 print:border-2 relative">
                  {editingItem === item.id ? (
                    <div className="relative" style={{ minWidth: '300px' }}>
                      <input
                        ref={searchInputRef}
                        type="text"
                        value={item.name}
                        onChange={(e) => handleItemNameChange(item.id, e.target.value)}
                        className="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                        placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù..."
                        style={{ minWidth: '450px' }} // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                      />
                      
                      {/* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ù…Ø³Ø§Ø­Ø© Ø£ÙƒØ¨Ø± */}
                      {showSearchResults && searchResults.length > 0 && (
                        // <div className="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-xl z-50 max-h-60 overflow-y-auto min-w-[300px]">
                        // Ù„Ø²ÙŠØ§Ø¯Ø© Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ø¯Ù„Øª Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø§Ù„Ù‰ 
                        <div className="mt-1 max-h-60 overflow-auto border border-gray-400 rounded-md bg-white shadow-sm text-sm p-2">
                          {isSearching && (
                            <div className="p-3 text-center text-gray-500">
                              <Search className="w-4 h-4 animate-spin mx-auto mb-1" />
                              Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...
                            </div>
                          )}
                          
                          {searchResults.map((result, index) => (
                            <div
                              key={index}
                              onClick={() => handleSelectSearchResult(result)}
                              className="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                            >
                              <div className="font-medium text-sm text-gray-800">
                                {result.name}
                              </div>
                              
                              {result.code && (
                                <div className="text-xs text-gray-500 mt-1">
                                  Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù: {result.code}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ) : (
                    <span className="break-words">{item.name}</span>
                  )}
                </td>
                
                {/* Ø§Ù„ÙƒÙ…ÙŠØ© */}
                <td className="py-3 px-2 border border-gray-300 text-center print:py-1">
                  {editingItem === item.id ? (
                    <input
                      type="number"
                      value={item.quantity || ''}
                      onChange={(e) => handleUpdateItem(item.id, { quantity: parseFloat(e.target.value) || 0 })}
                      className="w-full text-center border border-gray-300 rounded px-2 py-1 text-sm required"
                      min="1"
                      step="1"
                      required
                      style={{ fontFamily: 'Arial, sans-serif' }}
                      placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©"
                    />
                  ) : (
                    <span style={{ fontFamily: 'Arial, sans-serif' }}>{item.quantity || '-'}</span>
                  )}
                </td>
                
                {/* ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ */}
                <td className="py-3 px-2 border border-gray-300 text-center print:py-1">
                  {editingItem === item.id ? (
                    <select
                      value={item.unit || ''}
                      onChange={(e) => handleUpdateItem(item.id, { unit: e.target.value })}
                      className="w-full border border-gray-300 rounded px-2 py-1 text-sm required"
                      required
                    >
                      <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>
                      {/* Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© */}
                      {unitOptions.map(option => (
                        <option key={option} value={option}>{option}</option>
                      ))}
                    </select>
                  ) : (
                    <span>{item.unit || '-'}</span>
                  )}
                </td>
                
                {/* Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© - ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØªØ®ÙÙ‰ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */}
                <td className="py-3 px-2 border border-gray-300 print:py-1 print:hidden">
                  {editingItem === item.id ? (
                    <div className="space-y-2">
                      {/* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø¹Ù…Ù„Ø© */}
                      <div className="flex gap-1">
                        <input
                          type="number"
                          value={tempItemData[item.id]?.estimatedCost?.amount || 0}
                          onChange={(e) => handleUpdateEstimatedCost(item.id, 'amount', parseFloat(e.target.value) || 0)}
                          className="flex-1 border border-gray-300 rounded px-1 py-1 text-xs"
                          placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"
                          min="0"
                          step="0.01"
                          style={{ fontFamily: 'Arial, sans-serif' }}
                        />
                        
                        <select
                          value={tempItemData[item.id]?.estimatedCost?.currency || 'Ø±ÙŠØ§Ù„'}
                          onChange={(e) => handleUpdateEstimatedCost(item.id, 'currency', e.target.value)}
                          className="border border-gray-300 rounded px-1 py-1 text-xs"
                        >
                          <option value="Ø±ÙŠØ§Ù„">Ø±ÙŠØ§Ù„</option>
                          <option value="Ø¯ÙˆÙ„Ø§Ø±">Ø¯ÙˆÙ„Ø§Ø±</option>
                          <option value="Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</option>
                          <option value="ÙŠÙˆØ±Ùˆ">ÙŠÙˆØ±Ùˆ</option>
                        </select>
                      </div>
                      
                      {/* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù…Ù„Ø© Ø£Ø¬Ù†Ø¨ÙŠØ© */}
                      {tempItemData[item.id]?.estimatedCost?.currency !== 'Ø±ÙŠØ§Ù„' && (
                        <div className="text-xs text-blue-600 bg-blue-50 p-1 rounded">
                          Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„: {tempItemData[item.id]?.estimatedCost?.equivalentInYR?.toLocaleString() || 0} Ø±ÙŠØ§Ù„
                          
                          {!priceOffers.some(offer => offer.currency === tempItemData[item.id]?.estimatedCost?.currency && offer.exchangeRate) && (
                            <div className="text-orange-600 mt-1">
                              âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ±Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="text-sm">
                      {item.estimatedCost && item.estimatedCost.amount > 0 ? (
                        <>
                          <div style={{ fontFamily: 'Arial, sans-serif' }}>
                            {item.estimatedCost.amount.toLocaleString()} {item.estimatedCost.currency}
                          </div>
                          
                          {item.estimatedCost.currency !== 'Ø±ÙŠØ§Ù„' && item.estimatedCost.equivalentInYR && (
                            <div className="text-xs text-gray-600 mt-1" style={{ fontFamily: 'Arial, sans-serif' }}>
                              ({item.estimatedCost.equivalentInYR.toLocaleString()} Ø±ÙŠØ§Ù„)
                            </div>
                          )}
                        </>
                      ) : (
                        <span className="text-gray-400">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                      )}
                    </div>
                  )}
                </td>
                
                {/* Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª */}
                <td className="py-3 px-2 border border-gray-300 text-center print:py-1">
                  {editingItem === item.id ? (
                    <div className="space-y-1">
                      <div className="text-xs font-medium mb-1">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª:</div>
                      
                      {Object.entries(tempItemData[item.id]?.specifications || {}).map(([key, value]) => (
                        <div key={key} className="text-xs bg-gray-50 p-1 rounded">
                          {key}: {value}
                        </div>
                      ))}
                      
                      <button
                        onClick={() => {
                          const newKey = prompt('Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§ØµÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
                          if (newKey) {
                            handleAddSpecification(item.id, newKey, '');
                          }
                        }}
                        className="w-full px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                      >
                        Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ©
                      </button>
                    </div>
                  ) : (
                    <div className="text-xs">
                      {item.specifications && Object.keys(item.specifications).length > 0 ? (
                        <div className="space-y-1">
                          {Object.entries(item.specifications).map(([key, value]) => (
                            <div key={key} className="bg-gray-50 p-1 rounded">
                              {key}: {value}
                            </div>
                          ))}
                        </div>
                      ) : (
                        <span className="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯</span>
                      )}
                    </div>
                  )}
                </td>
                
                {/* Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */}
                <td className="py-3 px-2 border border-gray-300 text-center print:hidden">
                  <div className="flex gap-1 justify-center">
                    {editingItem === item.id ? (
                      <>
                        <button
                          onClick={() => handleSaveItem(item.id)}
                          className="text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-50"
                          title="Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"
                        >
                          <Save size={16} />
                        </button>
                        
                        <button
                          onClick={() => setEditingItem(null)}
                          className="text-gray-600 hover:text-gray-800 p-1 rounded hover:bg-gray-50"
                          title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"
                        >
                          <X size={16} />
                        </button>
                      </>
                    ) : (
                      <>
                        <button
                          onClick={() => setEditingItem(item.id)}
                          className="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50"
                          title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù"
                        >
                          <Edit size={16} />
                        </button>
                        
                        <button
                          onClick={() => handleRemoveItem(item.id)}
                          className="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-50"
                          title="Ø­Ø°Ù Ø§Ù„ØµÙ†Ù"
                        >
                          <X size={16} />
                        </button>
                      </>
                    )}
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      
      {/* Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù */}
      <button
        onClick={handleAddItem}
        className="fixed bottom-6 right-6 z-50 w-14 h-14 bg-green-600 text-white rounded-full shadow-lg hover:bg-green-700 transition-all flex items-center justify-center print:hidden"
        title="Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯"
      >
        <Plus size={24} />
      </button>
      
      {/* Ù‚Ø³Ù… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…ÙØµÙ„ (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) */}
      {editingItem && (
        <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 print:hidden">
          <h3 className="font-semibold mb-3 flex items-center">
            <FileText className="ml-2" size={18} />
            ØªÙØ§ØµÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù
          </h3>
          
          {/* Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© */}
          <div className="space-y-3 mb-4">
            {Object.entries(tempItemData[editingItem]?.specifications || {}).map(([key, value]) => (
              <div key={key} className="flex gap-2 items-center bg-white p-2 rounded border">
                <input
                  type="text"
                  value={key}
                  onChange={(e) => {
                    const newKey = e.target.value;
                    const specs = { ...tempItemData[editingItem]?.specifications };
                    delete specs[key];
                    specs[newKey] = value;
                    
                    setTempItemData(prev => ({
                      ...prev,
                      [editingItem]: {
                        ...prev[editingItem],
                        specifications: specs
                      }
                    }));
                  }}
                  className="w-32 border border-gray-300 rounded px-2 py-1 text-sm font-medium"
                  placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§ØµÙØ©"
                />
                
                <span className="text-gray-500">:</span>
                
                <input
                  type="text"
                  value={value}
                  onChange={(e) => handleAddSpecification(editingItem, key, e.target.value)}
                  className="flex-1 border border-gray-300 rounded px-2 py-1 text-sm"
                  placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"
                />
                
                <button
                  onClick={() => handleRemoveSpecification(editingItem, key)}
                  className="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-50"
                  title="Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ§ØµÙØ©"
                >
                  <X size={16} />
                </button>
              </div>
            ))}
          </div>
          
          {/* Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ© Ø¬Ø¯ÙŠØ¯Ø© */}
          <button
            onClick={() => {
              const newKey = prompt('Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§ØµÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ø«Ù„: Ø§Ù„Ù„ÙˆÙ†ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©):');
              if (newKey && newKey.trim()) {
                handleAddSpecification(editingItem, newKey.trim(), '');
              }
            }}
            className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 flex items-center gap-2"
          >
            <Plus size={16} />
            Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ© Ø¬Ø¯ÙŠØ¯Ø©
          </button>
        </div>
      )}
      
      {/* Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£ØµÙ†Ø§Ù */}
      {poItems.length === 0 && (
        <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
          <Package className="w-12 h-12 mx-auto mb-2 text-gray-300" />
          <p className="font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø·Ù„ÙˆØ¨Ø©</p>
          <p className="text-sm mt-1">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù" Ù„Ø¨Ø¯Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
        </div>
      )}
      
      {/* Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… */}
      <div className="mt-2 p-2 bg-blue-50 rounded-lg border border-blue-200 print:hidden">
        <h4 className="font-medium text-blue-800 mb-2">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h4>
        <ul className="text-sm text-blue-700 space-y-1">
          <li>â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</li>
          <li>â€¢ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø­Ø³Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶</li>
          <li>â€¢ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ØµÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„ÙƒÙ„ ØµÙ†Ù (Ø§Ù„Ù„ÙˆÙ†ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø¥Ù„Ø®)</li>
          <li>â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
        </ul>
      </div>
    </div>
  );
};

; ==============================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ø¹ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©

// purchases_alamin7-copy5\src\components\ExcludedOffersSection.tsx
; ====================================================================

import { Ban, FileMinus, AlertTriangle, DollarSign, Palette, Settings, Printer, CheckCircle } from 'lucide-react';
import React, { useEffect, useRef, useState } from 'react';
import { usePurchaseOrder } from '../context/PurchaseOrderContext';
import { ExcludedOffer } from '../types';
// ØªÙˆØ³ÙŠØ¹ ÙˆØ§Ø¬Ù‡Ø© ExcludedOffer Ù„Ø¯Ø¹Ù… Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
interface ExtendedExcludedOffer extends ExcludedOffer {
  priceReason?: string;
  colorReason?: string;
  specReasons?: string[];
}
export const ExcludedOffersSection: React.FC = () => {
  const { priceOffers, excludedOffers, setExcludedOffers, isPreliminaryPrint, poItems } = usePurchaseOrder();
  const [newReason, setNewReason] = useState('');
  const [newNotes, setNewNotes] = useState('');
  // Ø­Ø§Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editData, setEditData] = useState<Partial<ExtendedExcludedOffer>>({});
  const [processedOffers, setProcessedOffers] = useState<Set<string>>(new Set());
  const [printReasons, setPrintReasons] = useState(true); // âœ… Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨
  // Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø­Ø§ÙˆÙŠØ© Ù„Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  const containerRef = useRef<HTMLDivElement | null>(null);
  /**
   * Ø¯Ø§Ù„Ø© Ù„Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ ÙˆÙÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙ‚Ø·)
   */
  const adjustTextareasHeight = () => {
    if (!containerRef.current) return;
    const areas = containerRef.current.querySelectorAll<HTMLTextAreaElement>('textarea.excluded-textarea');
    areas.forEach((ta) => {
      ta.style.height = 'auto';
      ta.style.height = ta.scrollHeight + 'px';
    });
  };
  // Ø§Ø³ØªÙ…Ø¹ Ù„Ø­Ø¯Ø« beforeprint Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¶Ø¨Ø· ÙˆÙ‚Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  useEffect(() => {
    const before = () => {
      if (!isPreliminaryPrint) adjustTextareasHeight();
    };
    window.addEventListener('beforeprint', before);
    return () => window.removeEventListener('beforeprint', before);
  }, [isPreliminaryPrint, excludedOffers]);
  // Ø¹Ù†Ø¯ Ø£ÙŠ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ Ø§Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª
  useEffect(() => {
    if (!isPreliminaryPrint) adjustTextareasHeight();
  }, [excludedOffers, isPreliminaryPrint]);
  /**
   * âœ… Ù†Ù‚Ù„ Ø£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
   */
  useEffect(() => {
    const transferNonMatchingOffers = () => {
      if (!priceOffers || priceOffers.length === 0) return;
      const newExcludedOffers = [...excludedOffers];
      let hasChanges = false;
      priceOffers.forEach(offer => {
        // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹
        if (offer.vendor &&
          offer.result &&
          offer.result !== 'Ù…Ø·Ø§Ø¨Ù‚' &&
          !excludedOffers.some(excluded => excluded.vendor === offer.vendor)) {
          const autoReasons = generateAutoReasons(offer.vendor);
          const newOffer: ExtendedExcludedOffer = {
            id: `excluded-${Date.now()}-${offer.vendor}`,
            vendor: offer.vendor,
            reason: '', // ÙŠÙØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ ÙˆÙŠÙØ¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·
            notes: '',
            priceReason: autoReasons.priceReason,
            colorReason: autoReasons.colorReason,
            specReasons: autoReasons.specReasons
          };
          newExcludedOffers.push(newOffer);
          setProcessedOffers(prev => new Set([...prev, offer.vendor]));
          hasChanges = true;
        }
      });
      if (hasChanges) {
        setExcludedOffers(newExcludedOffers);
      }
    };
    transferNonMatchingOffers();
  }, [priceOffers]);
  /**
   * Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
   */
  const generateAutoReasons = (vendor: string) => {
    const priceOffer = priceOffers.find(offer => offer.vendor === vendor);
    if (!priceOffer) {
      return {
        priceReason: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯',
        colorReason: '',
        specReasons: []
      };
    }
    const reasons: {
      priceReason: string;
      colorReason: string;
      specReasons: string[];
    } = {
      priceReason: '',
      colorReason: '',
      specReasons: []
    };
    
    // âœ… Ø£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ø±Ø¶
    if (priceOffer.result === 'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚') {
      reasons.priceReason = 'Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
    } else if (priceOffer.result === 'Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ') {
      reasons.priceReason = 'Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠØ§Ù‹ Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª';
    }
    
    // âœ… Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„ÙƒÙ„ ØµÙ†Ù - ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (priceOffer.lineItems && poItems) {
      poItems.forEach(poItem => {
        const lineItem = priceOffer.lineItems?.find(li => li.lineNumber === poItem.lineNumber);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù‚Øµ ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
        if (lineItem && poItem.quantity) {
          const requiredQuantity = poItem.quantity;
          const offeredQuantity = lineItem.quantity || 0;

          if (offeredQuantity < requiredQuantity) {
            const shortage = requiredQuantity - offeredQuantity;
            reasons.specReasons.push(`Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (${shortage} ÙˆØ­Ø¯Ø© Ù…Ù† Ø£ØµÙ„ ${requiredQuantity})`);
          } else if (offeredQuantity === 0) {
            reasons.specReasons.push(`Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: Ù„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… ÙƒÙ…ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù`);
          }
        }

        if (lineItem && poItem.estimatedCost) {
          const estimatedCost = poItem.estimatedCost.amount || 0;
          const offeredPrice = lineItem.unitPrice || 0;
          
          if (estimatedCost > 0 && offeredPrice > 0) {
            const difference = offeredPrice - estimatedCost;
            const percentage = (difference / estimatedCost * 100).toFixed(1);
            
            if (Math.abs(difference) > 0.01) { // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø·ÙÙŠÙØ©
              if (difference > 0) {
                reasons.priceReason += `Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© ${percentage}%\n`;
              } else {
                reasons.priceReason += `Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© ${Math.abs(Number(percentage))}%\n`;
              }
            }
          }
        }
      });
    }
    
    // âœ… Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© - ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (priceOffer.lineItems && poItems) {
      poItems.forEach(poItem => {
        const lineItem = priceOffer.lineItems?.find(li => li.lineNumber === poItem.lineNumber);
        
        if (poItem.specifications && lineItem?.vendorSpecifications) {
          const requiredSpecs = poItem.specifications;
          const offeredSpecs = lineItem.vendorSpecifications;
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
          const requiredKeys = Object.keys(requiredSpecs);
          const offeredKeys = Object.keys(offeredSpecs);
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          const missingSpecs = requiredKeys.filter(key => !offeredKeys.includes(key));
          
          if (missingSpecs.length > 0) {
            reasons.specReasons.push(`Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ - ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙ„Ø§Ù Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø­ÙŠØ« Ø£Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${missingSpecs.join(', ')}) ÙˆØ§Ù„Ù…Ù‚Ø¯Ù… (ØºÙŠØ± Ù…Ù‚Ø¯Ù…)`);
          } else {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ù‚ÙŠÙ… Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
            let specsMatch = true;
            const mismatchedSpecs: string[] = [];
            
            requiredKeys.forEach(key => {
              const requiredValue = String(requiredSpecs[key]).trim();
              const offeredValue = String(offeredSpecs[key]).trim();
              
              if (requiredValue !== offeredValue) {
                specsMatch = false;
                mismatchedSpecs.push(`${key}: Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${requiredValue}) ÙˆØ§Ù„Ù…Ù‚Ø¯Ù… (${offeredValue})`);
              }
            });
            
            if (!specsMatch) {
              reasons.specReasons.push(`Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ - ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙ„Ø§Ù Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø­ÙŠØ« Ø£Ù† ${mismatchedSpecs.join(', ')}`);
            } else {
              reasons.specReasons.push(`Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©`);
            }
          }
        } else if (poItem.specifications && (!lineItem?.vendorSpecifications || Object.keys(lineItem.vendorSpecifications || {}).length === 0)) {
          reasons.specReasons.push(`Ø§Ù„ØµÙ†Ù ${poItem.lineNumber}: ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ - Ù„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ù…ÙˆØ§ØµÙØ§Øª`);
        }
      });
    }
    
    // âœ… Ø£Ø³Ø¨Ø§Ø¨ Ø³Ø¹Ø±ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
    if (priceOffer.total && priceOffer.total > 0) {
      const lowestOffer = Math.min(...priceOffers
        .filter(o => o.total && o.total > 0)
        .map(o => o.total as number));
      if (priceOffer.total > lowestOffer * 1.1) {
        const difference = ((priceOffer.total - lowestOffer) / lowestOffer * 100).toFixed(1);
        reasons.specReasons.push(`Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø¹Ù„Ù‰ Ø¨Ù†Ø³Ø¨Ø© ${difference}% Ù…Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶`);
      }
    }
    
    return reasons;
  };
  /**
   * âœ… Ø¯Ø§Ù„Ø© ØªÙØ±ÙŠØº Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
   */
  const handleTransferForPrint = () => {
    let newExcludedOffers = [...excludedOffers];
    let hasChanges = false;
    
    // Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    priceOffers.forEach(offer => {
      if (offer.vendor &&
        offer.result &&
        offer.result !== 'Ù…Ø·Ø§Ø¨Ù‚' &&
        !newExcludedOffers.some(excluded => excluded.vendor === offer.vendor)) {
        const autoReasons = generateAutoReasons(offer.vendor);
        const newOffer: ExtendedExcludedOffer = {
          id: `excluded-${Date.now()}-${offer.vendor}`,
          vendor: offer.vendor,
          reason: '', // ÙŠÙØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ ÙˆÙŠÙØ¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·
          notes: '',
          priceReason: autoReasons.priceReason,
          colorReason: autoReasons.colorReason,
          specReasons: autoReasons.specReasons
        };
        newExcludedOffers.push(newOffer);
        hasChanges = true;
      }
    });
    
    if (hasChanges) {
      setExcludedOffers(newExcludedOffers);
      alert('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ø§Ù‹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
    } else {
      alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©');
    }
  };
  /**
   * âœ… Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ù…Ø®ØµØµØ© Ù…Ø¹ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨
   */
  // const handlePrint = () => {
  //   // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  //   const currentPrintState = printReasons;
  //   // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„ÙŠØ©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø£ÙˆÙ„Ø§Ù‹
  //   if (isPreliminaryPrint) {
  //     handleTransferForPrint();
  //   }
  //   // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  //   setTimeout(() => {
  //     window.print();
  //     // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
  //     setTimeout(() => {
  //       setPrintReasons(currentPrintState);
  //     }, 1000);
  //   }, 500);
  // };

  // purchases_alamin7\src\components\ExcludedOffersSection.tsx
  // ... (Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡ÙŠ)

  /**
   * Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ù…Ø®ØµØµØ© Ù…Ø¹ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨
   * ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
   */
  const handlePrint = () => {
    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const currentPrintState = printReasons;

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„ÙŠØ©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø£ÙˆÙ„Ø§Ù‹
    if (isPreliminaryPrint) {
      handleTransferForPrint();
    }

    // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    setTimeout(() => {
      window.print();
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
      setTimeout(() => {
        setPrintReasons(currentPrintState);
      }, 1000);
    }, 500);
  };


  // handleUpdateExcludedOffer, startEdit, cancelEdit, saveEdit, handleAddExcludedOffer, handleRemoveExcludedOffer
  {/* Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© (ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙƒÙˆÙ†): */ }
  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù…Ø³ØªØ¨Ø¹Ø¯
  const handleUpdateExcludedOffer = (id: string, updates: Partial<ExcludedOffer>) => {
    setExcludedOffers(
      excludedOffers.map(offer =>
        offer.id === id ? { ...offer, ...updates } : offer
      )
    );
  };
  // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ù…Ø³ØªØ¨Ø¹Ø¯
  const startEdit = (offer: ExcludedOffer) => {
    setEditingId(offer.id);
    setEditData({ ...offer });
  };
  // Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  const cancelEdit = () => {
    setEditingId(null);
    setEditData({});
  };
  // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  const saveEdit = () => {
    if (editingId && editData.vendor) {
      const updatedOffers = excludedOffers.map(offer =>
        offer.id === editingId ? { ...offer, ...editData } : offer
      );
      setExcludedOffers(updatedOffers);
      setEditingId(null);
      setEditData({});
    }
  };
  // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ù…Ø³ØªØ¨Ø¹Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹
  const handleAddExcludedOffer = (vendor: string) => {
    // Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ù…ÙƒØ±Ø±
    if (excludedOffers.some(excluded => excluded.vendor === vendor)) {
      alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©');
      return;
    }
    const autoReasons = generateAutoReasons(vendor);
    const newExcludedOffer: ExtendedExcludedOffer = {
      id: `excluded-${Date.now()}`,
      vendor,
      reason: newReason || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ø¡ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯',
      notes: newNotes,
      priceReason: autoReasons.priceReason,
      colorReason: autoReasons.colorReason,
      specReasons: autoReasons.specReasons
    };
    setExcludedOffers([...excludedOffers, newExcludedOffer]);
    setProcessedOffers(prev => new Set([...prev, vendor]));
    setNewReason('');
    setNewNotes('');
  };


  // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¹Ø±Ø¶ Ù…Ø³ØªØ¨Ø¹Ø¯
  const handleRemoveExcludedOffer = (id: string) => {
    const offerToRemove = excludedOffers.find(offer => offer.id === id);
    if (offerToRemove) {
      setProcessedOffers(prev => {
        const newSet = new Set(prev);
        newSet.delete(offerToRemove.vendor);
        return newSet;
      });
    }
    setExcludedOffers(excludedOffers.filter(offer => offer.id !== id));
  };

  return (
    <div ref={containerRef} className="bg-white rounded-lg shadow-lg p-4 mb-4 border border-gray-200 print:mb-0 print-container">
      <div className="flex items-center justify-between mb-4 print:mb-0">
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-semibold flex items-center text-gray-800">
            <Ban className="ml-2 icon" size={20} />
            Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
          </h2>
          {/* âœ… Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ */}
          <label className="flex items-center gap-2 cursor-pointer print:hidden">
            <input
              type="checkbox"
              checked={printReasons}
              onChange={(e) => setPrintReasons(e.target.checked)}
              className="form-checkbox h-4 w-4 text-blue-600 rounded"
            />
            <span className="text-sm text-gray-700">Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</span>
          </label>
        </div>
        <div className="flex items-center gap-2">
          {/* âœ… Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ØµØµ */}
          <button
            onClick={handlePrint}
            className="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors flex items-center shadow-sm print:hidden"
            title="Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©"
          >
            <Printer size={18} className="ml-1" />
            Ø·Ø¨Ø§Ø¹Ø©
          </button>
          <button
            onClick={handleTransferForPrint}
            className="py-2 px-4 bg-amber-500 text-white rounded-md hover:bg-amber-600 transition-colors flex items-center shadow-sm print:hidden"
          >
            <FileMinus size={18} className="ml-1" />
            ØªÙØ±ÙŠØº
          </button>
        </div>
      </div>
      {excludedOffers.length === 0 ? (
        <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
          <Ban className="w-12 h-12 mx-auto mb-2 text-gray-300" />
          <p className="font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø³ØªØ¨Ø¹Ø¯Ø©</p>
          <p className="text-sm mt-1">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙØ±ÙŠØº" Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        </div>
      ) : (
        <div className="overflow-x-auto print:overflow-visible">
          <table className="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden print:w-[100%] print:border-gray-400">
            <thead>
              <tr className="bg-gradient-to-r from-blue-600 to-blue-700 text-white print:bg-blue-600">
                <th className="py-2 px-1 text-center font-semibold border border-gray-300" style={{ width: '13%' }}>
                  Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶
                </th>
                <th className="py-2 px-1 text-center font-semibold border border-gray-300" style={{ width: '40%' }}>
                  Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…
                </th>
                <th className="py-2 px-1 text-center font-semibold border border-gray-300" style={{ width: '40%' }}>
                  Ø£Ø³Ø¨Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                </th>
                <th className="py-2 px-1 text-center font-semibold border border-gray-300 print:hidden" style={{ width: '7%' }}>
                  Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                </th>
              </tr>
            </thead>
            <tbody>
              {excludedOffers
                .filter(ex => {
                  const matched = priceOffers.find(p => p.vendor === ex.vendor);
                  return !(matched && matched.result === 'Ù…Ø·Ø§Ø¨Ù‚');
                })
                .map((offer) => (
                  <tr key={offer.id} className="hover:bg-blue-50 transition-colors print:border-gray-300">
                    {/* Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶ */}
                    <td className="py-2 px-1 border border-gray-300 font-medium text-center print:py-1 print:px-1">
                      {offer.vendor || '\u00A0\n\u00A0'} {/* âœ… Ø³Ø·Ø±ÙŠÙ† ÙØ§Ø±ØºÙŠÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø­ØªÙˆÙ‰ */}
                    </td>
                    {/* Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù… */}
                    <td className="py-2 px-1 border border-gray-300 print:py-1 print:px-1">
                      <textarea
                        value={offer.reason}
                        onChange={(e) => handleUpdateExcludedOffer(offer.id, { reason: e.target.value })}
                        className={`excluded-textarea w-full border border-gray-300 rounded-md py-1 px-1 focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none print:hidden text-xs ${isPreliminaryPrint ? 'h-[2em] leading-tight' : ''}`}
                        placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…"
                        style={{
                          wordWrap: 'break-word',
                          whiteSpace: 'pre-wrap',
                          overflow: 'hidden',
                          minHeight: '2em',
                          lineHeight: '1.2'
                        }}
                        onInput={(e) => {
                          const target = e.target as HTMLTextAreaElement;
                          if (!isPreliminaryPrint) {
                            target.style.height = 'auto';
                            target.style.height = target.scrollHeight + 'px';
                          }
                        }}
                      />
                      <div
                        className={`hidden print:block whitespace-pre-wrap break-words text-[11px] leading-tight ${printReasons ? '' : 'invisible'}`}
                        style={{
                          minHeight: '2em',
                          lineHeight: '1.2'
                        }}
                      >
                        {offer.reason || '\u00A0'}
                      </div>
                    </td>
                    {/* Ø£Ø³Ø¨Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© */}
                    <td className="py-2 px-1 border border-gray-300 print:py-1 print:px-1">
                      <div className={`space-y-1 ${printReasons ? '' : 'print:hidden'}`}>
                        {(offer as ExtendedExcludedOffer).priceReason && (
                          <div className="bg-red-50 border border-red-200 p-1 rounded text-xs">
                            <span className="font-medium text-red-800 text-xs">Ø§Ù„Ø³Ø¹Ø±:</span>
                            <div className="text-red-700 text-xs">{(offer as ExtendedExcludedOffer).priceReason}</div>
                          </div>
                        )}
                        {(offer as ExtendedExcludedOffer).colorReason && (
                          <div className="bg-yellow-50 border border-yellow-200 p-1 rounded text-xs">
                            <span className="font-medium text-yellow-800 text-xs">Ø§Ù„Ù„ÙˆÙ†:</span>
                            <div className="text-yellow-700 text-xs">{(offer as ExtendedExcludedOffer).colorReason}</div>
                          </div>
                        )}
                        {(offer as ExtendedExcludedOffer).specReasons &&
                          Array.isArray((offer as ExtendedExcludedOffer).specReasons) && (
                            <div className={`bg-blue-50 border border-blue-200 p-1 rounded ${printReasons ? 'text-[10px]' : 'print:hidden'} `}>
                              <span className="font-medium text-blue-800 text-xs">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª:</span>
                              <ul className="list-disc list-inside text-blue-700 space-y-0.5 text-xs">
                                {(offer as ExtendedExcludedOffer).specReasons!.length > 0 ? (
                                  (offer as ExtendedExcludedOffer).specReasons!.map((reason: string, idx: number) => (
                                    <li key={idx} className="leading-tight text-xs">{reason}</li>
                                  ))
                                ) : (
                                  <li className="text-gray-400 italic text-xs">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠØ©</li>
                                )}
                              </ul>
                            </div>
                          )}
                        {!(offer as ExtendedExcludedOffer).priceReason &&
                          !(offer as ExtendedExcludedOffer).colorReason &&
                          (!(offer as ExtendedExcludedOffer).specReasons || (offer as ExtendedExcludedOffer).specReasons!.length === 0) && (
                            <div className="text-gray-400 text-xs italic">
                              {printReasons ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠØ©' : '\u00A0'}
                            </div>
                          )}
                      </div>
                      {/* âœ… Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ© Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ */}
                      {!printReasons && (
                        <div className="hidden print:block whitespace-pre-wrap break-words text-[10px] leading-tight"
                          style={{ minHeight: '2em', lineHeight: '1.2' }}>
                          {'\u00A0\n\u00A0'}
                        </div>
                      )}
                    </td>
                    {/* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­Ù‚ÙˆÙ„ Ø¹Ù…ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ© */}
                    {/* <td className="py-2 px-1 border border-gray-300 print:py-1 print:px-1">
                      <textarea
                        value={offer.notes}
                        onChange={(e) => handleUpdateExcludedOffer(offer.id, { notes: e.target.value })}
                        className={`excluded-textarea w-full border border-gray-300 rounded-md py-1 px-1 focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none print:hidden text-xs ${isPreliminaryPrint ? 'h-[2em] leading-tight' : ''}`}
                        placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"
                        style={{
                          wordWrap: 'break-word',
                          whiteSpace: 'pre-wrap',
                          overflow: 'hidden',
                          minHeight: '2em',
                          lineHeight: '1.2'
                        }}
                        onInput={(e) => {
                          const target = e.target as HTMLTextAreaElement;
                          if (!isPreliminaryPrint) {
                            target.style.height = 'auto';
                            target.style.height = target.scrollHeight + 'px';
                          }
                        }}
                      />
                      <div
                        className="hidden print:block whitespace-pre-wrap break-words text-[11px] leading-tight"
                        style={{
                          minHeight: '2em',
                          lineHeight: '1.2'
                        }}
                      >
                        {offer.notes || '\u00A0'}
                      </div>
                    </td> */}
                    {/* Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */}
                    <td className="py-2 px-1 border border-gray-300 text-center print:hidden">
                      <div className="flex gap-1 justify-center">
                        <button
                          onClick={() => startEdit(offer)}
                          className="text-blue-500 hover:text-blue-700 transition-colors px-1 py-0.5 rounded hover:bg-blue-50 text-xs"
                          title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨"
                        >
                          ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button
                          onClick={() => handleRemoveExcludedOffer(offer.id)}
                          className="text-red-500 hover:text-red-700 transition-colors px-1 py-0.5 rounded hover:bg-red-50 text-xs"
                          title="Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©"
                        >
                          Ø­Ø°Ù
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
            </tbody>
          </table>
        </div>
      )}
      {/* âœ… Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */}
      <div className="mt-3 p-2 bg-blue-50 rounded-lg border border-blue-200 print:hidden">
        <h4 className="font-medium text-blue-800 mb-1 text-sm">ğŸ’¡ ØªÙ„Ù…ÙŠØ­Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</h4>
        <ul className="text-xs text-blue-700 space-y-0.5">
          <li>â€¢ Ø§Ø®ØªØ± "Ø·Ø¨Ø§Ø¹Ø© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯" Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</li>
          <li>â€¢ Ø§Ø³ØªØ®Ø¯Ù… "ØªÙØ±ÙŠØº" Ù„Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</li>
          <li>â€¢ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©ØŒ ÙŠØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</li>
        </ul>
      </div>
      {/* ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù†Ù‚Ù„Øª ÙƒÙ…Ø§ Ù‡ÙŠ) */}
      {/* Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ù…Ø³ØªØ¨Ø¹Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ (ÙŠØ¶Ø§Ù Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ÙƒÙˆÙ†): */}
      {/* Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ù…Ø³ØªØ¨Ø¹Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ */}
      <div className="mt-4 print:hidden">
        <details className="bg-gray-50 rounded-md border border-gray-200">
          <summary className="p-3 cursor-pointer font-medium hover:bg-gray-100 transition-colors">
            Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ù…Ø³ØªØ¨Ø¹Ø¯ Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹
          </summary>
          <div className="p-4 border-t border-gray-200">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label className="block text-sm text-gray-600 mb-1 font-medium">Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶:</label>
                <select
                  className="w-full border border-gray-300 rounded-md py-2 px-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onChange={(e) => e.target.value && handleAddExcludedOffer(e.target.value)}
                  value=""
                >
                  <option value="">Ø§Ø®ØªØ± Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶</option>
                  {priceOffers
                    .filter(offer => offer.vendor && !excludedOffers.some(excluded => excluded.vendor === offer.vendor))
                    .map(offer => (
                      <option key={offer.id} value={offer.vendor}>
                        {offer.vendor}
                      </option>
                    ))}
                </select>
              </div>
              <div>
                <label className="block text-sm text-gray-600 mb-1 font-medium">Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯:</label>
                <input
                  type="text"
                  value={newReason}
                  onChange={(e) => setNewReason(e.target.value)}
                  className="w-full border border-gray-300 rounded-md py-2 px-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…"
                />
              </div>
              <div>
                <label className="block text-sm text-gray-600 mb-1 font-medium">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                <input
                  type="text"
                  value={newNotes}
                  onChange={(e) => setNewNotes(e.target.value)}
                  className="w-full border border-gray-300 rounded-md py-2 px-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"
                />
              </div>
            </div>
          </div>
        </details>
      </div>
      {/* 3. Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ (ÙŠØ¶Ø§Ù Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ÙƒÙˆÙ†): */}
      {/* Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø³Ù†Ø© */}
      {editingId && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 print:hidden">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold flex items-center">
                  <Ban className="ml-2" size={20} />
                  ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯
                </h3>
                <button
                  onClick={cancelEdit}
                  className="text-gray-500 hover:text-gray-700"
                >
                  âœ•
                </button>
              </div>
              <div className="space-y-4">
                {/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                  <input
                    type="text"
                    value={editData.vendor || ''}
                    onChange={(e) => setEditData({ ...editData, vendor: e.target.value })}
                    className="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯"
                  />
                </div>
                {/* Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù… */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…:</label>
                  <textarea
                    value={editData.reason || ''}
                    onChange={(e) => setEditData({ ...editData, reason: e.target.value })}
                    className="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…"
                    rows={2}
                  />
                </div>
                {/* Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© */}
                <div className="space-y-3 bg-gray-50 p-4 rounded-lg">
                  <h4 className="text-md font-medium text-gray-700 flex items-center">
                    <AlertTriangle className="ml-2" size={18} />
                    Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
                  </h4>
                  {/* Ø³Ø¨Ø¨ Ø§Ù„Ø³Ø¹Ø± */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <DollarSign className="ml-1" size={16} />
                      Ø§Ù„Ø³Ø¹Ø±:
                    </label>
                    <textarea
                      value={(editData as ExtendedExcludedOffer).priceReason || ''}
                      onChange={(e) => setEditData({ ...editData, priceReason: e.target.value })}
                      className="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø³Ø¹Ø±"
                      rows={2}
                    />
                  </div>
                  {/* Ø³Ø¨Ø¨ Ø§Ù„Ù„ÙˆÙ† */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <Palette className="ml-1" size={16} />
                      Ø§Ù„Ù„ÙˆÙ†:
                    </label>
                    <textarea
                      value={(editData as ExtendedExcludedOffer).colorReason || ''}
                      onChange={(e) => setEditData({ ...editData, colorReason: e.target.value })}
                      className="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ù„ÙˆÙ†"
                      rows={2}
                    />
                  </div>
                  {/* Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <Settings className="ml-1" size={16} />
                      Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª:
                    </label>
                    <textarea
                      value={(editData as ExtendedExcludedOffer).specReasons?.join('\n') || ''}
                      onChange={(e) => setEditData({
                        ...editData,
                        specReasons: e.target.value.split('\n').filter((r: string) => r.trim() !== '')
                      })}
                      className="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª (ÙƒÙ„ Ø³Ø¨Ø¨ ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„)"
                      rows={3}
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      ğŸ’¡ Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø³Ø¨Ø¨ ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„
                    </p>
                  </div>
                </div>
                {/* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
                  <textarea
                    value={editData.notes || ''}
                    onChange={(e) => setEditData({ ...editData, notes: e.target.value })}
                    className="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ùˆ ØªÙØ³ÙŠØ±Ø§Øª"
                    rows={2}
                  />
                </div>
              </div>
              <div className="flex justify-end gap-3 mt-6">
                <button
                  onClick={cancelEdit}
                  className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
                >
                  Ø¥Ù„ØºØ§Ø¡
                </button>
                <button
                  onClick={saveEdit}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                  Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
      {/* 4. Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ÙŠØ¶Ø§Ù Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ÙƒÙˆÙ†): */}
      {/* Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… */}
      <div className="mt-2 p-3 bg-amber-50 rounded-lg border border-amber-200 print:hidden">
        <h4 className="font-medium text-amber-800 mb-2">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©:</h4>
        <ul className="text-sm text-amber-700 space-y-1">
          <li>â€¢ ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„</li>
          <li>â€¢ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨Ø§Ø¨ Ø¥Ø¶Ø§ÙÙŠØ©</li>
          <li>â€¢ Ø§Ø³ØªØ®Ø¯Ù… "ØªÙØ±ÙŠØº" Ù„Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</li>
          <li>â€¢ Ø§Ø®ØªØ± "Ø·Ø¨Ø§Ø¹Ø© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯" Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</li>
        </ul>
      </div>
    </div>
  );
};


; ====================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 

//purchases_alamin5-copy5\src\utils\db.ts
; ========================================================================

// src/utils/db.ts
import Dexie, { Table } from 'dexie';

// ==============================
// ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Interfaces)
// ==============================

/**
 * ÙˆØ§Ø¬Ù‡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
 */
interface PriceOfferData {
  id?: number;               // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
  po_id: string;              // Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø¹Ø±Ø¶
  vendor: string;             // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯
  amount: number;             // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
  currency: string;           // Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¯ÙˆÙ„Ø§Ø±ØŒ Ø¥Ù„Ø®)
  exchangeRate?: number;      // Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©)
  taxIncluded: boolean;       // Ù‡Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ´Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
  total: number;              // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  totalInYR: number;         // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ
  totalInWords: string;       // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØªØ§Ø¨Ø©Ù‹
  result?: string;            // Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ù…Ø·Ø§Ø¨Ù‚ØŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ØŒ Ù…Ø·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ)
  notes?: string;             // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
  items?: PriceOfferItem[];   // ØªÙØ§ØµÙŠÙ„ Ø£ØµÙ†Ø§Ù Ø§Ù„Ø¹Ø±Ø¶
  commitments?: string[];     // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯
}

/**
 * ÙˆØ§Ø¬Ù‡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø£ØµÙ†Ø§Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * ØªÙ…Ø«Ù„ ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ ØµÙ†Ù ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…
 */
interface PriceOfferItem {
  id?: string;                // Ù…Ø¹Ø±Ù Ø§Ù„ØµÙ†Ù ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶
  itemName: string;          // Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
  quantity: number;           // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
  unitPrice: number;         // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©
  totalPrice: number;        // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„ØµÙ†Ù
  specifications?: {           // Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    [key: string]: string;
  };
  vendorSpecifications?: {      // Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯
    [key: string]: string;
  };
  commitments?: string[];      // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØµÙ†Ù
}

/**
 * ÙˆØ§Ø¬Ù‡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ù…
 */
interface ExcludedOfferData {
  id?: number;                // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
  po_id: string;              // Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø¹Ø±Ø¶
  vendor: string;             // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯
  reason: string;             // Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  notes: string;              // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
  priceReason?: string;       // Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø³Ø¹Ø±
  colorReason?: string;       // Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ù„ÙˆÙ†
  specReasons?: string[];      // Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª
}

/**
 * ÙˆØ§Ø¬Ù‡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * ØªÙ…Ø«Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
 */
interface ItemData {
  id?: number;                // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
  po_id: string;              // Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ØµÙ†Ù
  code?: string;              // Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙÙŠ Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  name: string;               // Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
  quantity: number;           // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  unit: string;               // ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³
  estimatedCost?: {           // Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ØµÙ†Ù
    amount: number;           // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ
    currency: string;         // Ø§Ù„Ø¹Ù…Ù„Ø©
    equivalentInYR?: number; // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠ (ÙŠØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
  };
  specifications?: {           // Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    [key: string]: string;
  };
}

/**
 * ÙˆØ§Ø¬Ù‡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * ØªÙ…Ø«Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡
 */
interface PurchaseOrderData {
  id?: number;                // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
  po_number: string;           // Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯)
  transaction_number: string;  // Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
  requesting: string;          // Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©
  beneficiary: string;         // Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©
  purchaseMethod: string;      // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
  items_count: number;         // Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  subject: string;             // Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
  financial_classification: string; // Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø§Ù„ÙŠ
  record_number: string;       // Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„
  record_date: string;         // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¬Ù„
  created_by: string;          // Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£ Ø§Ù„Ø·Ù„Ø¨
  created_at: string;          // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
  updated_at: string;          // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«
  items: ItemData[];           // Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  priceOffers: PriceOfferData[]; // Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
  excludedOffers: ExcludedOfferData[]; // Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
  recommendation?: string;     // Ù†Øµ Ø§Ù„ØªÙˆØµÙŠØ©
}

// ==============================
// ÙØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ==============================

/**
 * ÙØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Dexie (IndexedDB)
 * ØªØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡
 */
class PurchaseOrderDB extends Dexie {
  purchase_orders!: Table<PurchaseOrderData>;
  priceOffers!: Table<PriceOfferData>;
  excludedOffers!: Table<ExcludedOfferData>;
  items!: Table<ItemData>;
  
  constructor() {
    super('PurchaseOrderDB');
    
    // ØªØ¹Ø±ÙŠÙ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø± 310
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ++id ÙƒÙ…ÙØªØ§Ø­ Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    this.version(310).stores({
      purchase_orders: '++id,po_number,transaction_number,requesting,beneficiary,items_count,subject,financial_classification,record_number,record_date,created_by,created_at,updated_at,purchaseMethod',
      priceOffers: '++id,po_id,vendor,amount,currency,exchangeRate,taxIncluded,total,totalInYR,totalInWords,result',
      excludedOffers: '++id,po_id,vendor,reason,notes',
      items: '++id,po_id,name,quantity,unit'
    });
  }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const dexieDb = new PurchaseOrderDB();

// ==============================
// Ø°Ø§ÙƒØ±Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØªØ­Ø³ÙŠÙ† (Cache)
// ==============================

/**
 * Ø°Ø§ÙƒØ±Ø© Ù…Ø¤Ù‚ØªØ© Ù„ØªØ®Ø²ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
 */
class DatabaseCache {
  private cache = new Map<string, { data: any; timestamp: number }>();
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5 Ø¯Ù‚Ø§Ø¦Ù‚

  /**
   * ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
   */
  set(key: string, data: any): void {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }

  /**
   * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
   */
  get(key: string): any | null {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() - item.timestamp > this.CACHE_DURATION) {
      this.cache.delete(key);
      return null;
    }
    
    return item.data;
  }

  /**
   * Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
   */
  clear(): void {
    this.cache.clear();
  }
}

const dbCache = new DatabaseCache();

// ==============================
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ==============================

export const db = {
  /**
   * Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   * @param data Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
   * @returns true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ØŒ false ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
   */
  async savePurchaseOrder(data: PurchaseOrderData): Promise<boolean> {
    try {
      console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', data.po_number);
      await dexieDb.open();
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ø¶Ù…Ø§Ù† ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await dexieDb.transaction('rw', [
        dexieDb.purchase_orders, 
        dexieDb.priceOffers, 
        dexieDb.excludedOffers, 
        dexieDb.items
      ], async () => {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… po_number
        const existingOrder = await dexieDb.purchase_orders
          .where('po_number')
          .equals(data.po_number)
          .first();
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
        if (existingOrder?.id) {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
          await dexieDb.purchase_orders.update(existingOrder.id, {
            ...data,
            updated_at: new Date().toISOString()
          });
        } else {
          // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ created_at
          await dexieDb.purchase_orders.put({
            ...data,
            created_at: data.created_at || new Date().toISOString(),
            updated_at: new Date().toISOString()
          });
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù
        if (Array.isArray(data.items)) {
          // Ø­Ø°Ù Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹
          await dexieDb.items.where('po_id').equals(data.po_number).delete();
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          const itemsToSave = data.items.map((i: ItemData) => ({ ...i, po_id: data.po_number }));
          await dexieDb.items.bulkPut(itemsToSave);
        }
        
        // Ø­ÙØ¸ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
        if (Array.isArray(data.priceOffers)) {
          // Ø­Ø°Ù Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹
          await dexieDb.priceOffers.where('po_id').equals(data.po_number).delete();
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          const offersToSave = data.priceOffers.map((o: PriceOfferData) => ({ ...o, po_id: data.po_number }));
          await dexieDb.priceOffers.bulkPut(offersToSave);
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
        if (Array.isArray(data.excludedOffers)) {
          // Ø­Ø°Ù Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹
          await dexieDb.excludedOffers.where('po_id').equals(data.po_number).delete();
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          const excludedToSave = data.excludedOffers.map((eo: ExcludedOfferData) => ({ ...eo, po_id: data.po_number }));
          await dexieDb.excludedOffers.bulkPut(excludedToSave);
        }
      });
      
      // Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ø§Ø¬Ø­
      dbCache.clear();
      console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      return true;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
      console.error('Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£:', error.message);
      console.error('Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£:', error.name);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙˆØ§Ù„ØªØ±Ù‚ÙŠØ©
      if (error.name === 'VersionError' || error.name === 'DatabaseClosedError' || error.name === 'UpgradeError') {
        try {
          console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§...');
          await dexieDb.delete();
          await dexieDb.open();
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
          return this.savePurchaseOrder(data);
        } catch (retryError: any) {
          console.error('ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', retryError);
          return false;
        }
      }
      
      return false;
    }
  },

  /**
   * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
   * @param poNumber Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
   * @returns Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ null Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡
   */
  async getPurchaseOrder(poNumber: string): Promise<PurchaseOrderData | null> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
      const cached = dbCache.get(`po_${poNumber}`);
      if (cached) return cached;
      
      const data = await dexieDb.purchase_orders
        .where('po_number')
        .equals(poNumber)
        .first();
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      if (data) dbCache.set(`po_${poNumber}`, data);
      
      return data || null;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (error.name === 'UpgradeError' || error.name === 'VersionError') {
        try {
          console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·...');
          await dexieDb.delete();
          await dexieDb.open();
          console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
          return this.getPurchaseOrder(poNumber);
        } catch (retryError: any) {
          console.error('ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', retryError);
          return null;
        }
      }
      
      return null;
    }
  },

  /**
   * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
   * @param transactionNumber Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
   * @returns Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ null Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡
   */
  async getPurchaseOrderByTransaction(transactionNumber: string): Promise<PurchaseOrderData | null> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
      const cached = dbCache.get(`txn_${transactionNumber}`);
      if (cached) return cached;
      
      const data = await dexieDb.purchase_orders
        .where('transaction_number')
        .equals(transactionNumber)
        .first();
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      if (data) dbCache.set(`txn_${transactionNumber}`, data);
      
      return data || null;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (error.name === 'UpgradeError' || error.name === 'VersionError') {
        try {
          console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·...');
          await dexieDb.delete();
          await dexieDb.open();
          console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
          return this.getPurchaseOrderByTransaction(transactionNumber);
        } catch (retryError: any) {
          console.error('ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', retryError);
          return null;
        }
      }
      
      return null;
    }
  },

  /**
   * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­Ø³Ø¨ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
   * @param startPO Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„
   * @param endPO Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£Ø®ÙŠØ±
   * @returns Ù…ØµÙÙˆÙØ© Ù…Ù† Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡
   */
  async getPurchaseOrdersByRange(startPO: string, endPO: string): Promise<PurchaseOrderData[]> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
      const cacheKey = `range_${startPO}_${endPO}`;
      const cached = dbCache.get(cacheKey);
      if (cached) return cached;
      
      const data = await dexieDb.purchase_orders
        .where('po_number')
        .between(startPO, endPO + '\uffff')
        .toArray();
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      dbCache.set(cacheKey, data);
      
      return data;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø·Ø§Ù‚:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (error.name === 'UpgradeError' || error.name === 'VersionError') {
        try {
          console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·...');
          await dexieDb.delete();
          await dexieDb.open();
          console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
          return this.getPurchaseOrdersByRange(startPO, endPO);
        } catch (retryError: any) {
          console.error('ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', retryError);
          return [];
        }
      }
      
      return [];
    }
  },

  /**
   * Ø­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   * @param poNumber Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
   * @returns true Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ØŒ false ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
   */
  async deletePurchaseOrder(poNumber: string): Promise<boolean> {
    try {
      await dexieDb.transaction('rw', [
        dexieDb.purchase_orders, 
        dexieDb.priceOffers, 
        dexieDb.excludedOffers, 
        dexieDb.items
      ], async () => {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ­Ø°ÙÙ‡
        const orderToDelete = await dexieDb.purchase_orders
          .where('po_number')
          .equals(poNumber)
          .first();
        
        if (orderToDelete?.id) {
          await dexieDb.purchase_orders.delete(orderToDelete.id);
        }
        
        // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡
        await dexieDb.items.where('po_id').equals(poNumber).delete();
        await dexieDb.priceOffers.where('po_id').equals(poNumber).delete();
        await dexieDb.excludedOffers.where('po_id').equals(poNumber).delete();
      });
      
      // Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¬Ø­
      dbCache.clear();
      console.log(`ØªÙ… Ø­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ${poNumber} Ø¨Ù†Ø¬Ø§Ø­`);
      return true;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      return false;
    }
  },

  /**
   * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­Ø³Ø¨ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ù„Ø§ØµØ©
   * @param startDate ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (YYYY-MM-DD)
   * @param endDate ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (YYYY-MM-DD)
   * @returns Ù…ØµÙÙˆÙØ© Ù…Ù† Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯
   */
  async getPurchaseOrdersByDateRange(startDate: string, endDate: string): Promise<PurchaseOrderData[]> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
      const cacheKey = `date_${startDate}_${endDate}`;
      const cached = dbCache.get(cacheKey);
      if (cached) return cached;
      
      // Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ… Ø¨ØªÙˆÙ‚ÙŠØª UTC Ù„Ø¶Ù…Ø§Ù† Ø´Ù…ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… ÙƒØ§Ù…Ù„Ø§Ù‹
      const startIso = `${startDate}T00:00:00.000Z`;
      const endIso = `${endDate}T23:59:59.999Z`;
      
      // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
      try {
        // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ created_at Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ù…ÙÙ‡Ø±Ø³)
        const viaCreatedAt = await dexieDb.purchase_orders
          .where('created_at')
          .between(startIso, endIso)
          .toArray();
        
        if (viaCreatedAt.length > 0) {
          dbCache.set(cacheKey, viaCreatedAt);
          return viaCreatedAt;
        }
      } catch (e1) {
        console.log('Ø§Ù„Ø¨Ø­Ø« Ø¹Ø¨Ø± created_at Ù„Ù… ÙŠÙ†Ø¬Ø­:', e1.message);
      }
      
      try {
        // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ record_date Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const viaRecordDate = await dexieDb.purchase_orders
          .where('record_date')
          .between(startDate, endDate)
          .toArray();
        
        if (viaRecordDate.length > 0) {
          dbCache.set(cacheKey, viaRecordDate);
          return viaRecordDate;
        }
      } catch (e2) {
        console.log('Ø§Ù„Ø¨Ø­Ø« Ø¹Ø¨Ø± record_date Ù„Ù… ÙŠÙ†Ø¬Ø­:', e2.message);
      }
      
      // Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„Ø¨Ø­Ø« Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„ØªØµÙÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹
      console.log('Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ...');
      const allOrders = await dexieDb.purchase_orders.toArray();
      const filteredOrders = allOrders.filter((order: any) => {
        const orderDate = order.record_date || order.created_at?.split('T')[0];
        return orderDate && orderDate >= startDate && orderDate <= endDate;
      });
      
      dbCache.set(cacheKey, filteredOrders);
      return filteredOrders;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­Ø³Ø¨ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (error.name === 'UpgradeError' || error.name === 'VersionError') {
        try {
          console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·...');
          await dexieDb.delete();
          await dexieDb.open();
          console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
          return this.getPurchaseOrdersByDateRange(startDate, endDate);
        } catch (retryError: any) {
          console.error('ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', retryError);
          return [];
        }
      }
      
      return [];
    }
  },

  /**
   * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡
   * @returns Ù…ØµÙÙˆÙØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡
   */
  async getAllPurchaseOrders(): Promise<PurchaseOrderData[]> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
      const cached = dbCache.get('all_orders');
      if (cached) return cached;
      
      const data = await dexieDb.purchase_orders.toArray();
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      dbCache.set('all_orders', data);
      
      return data;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (error.name === 'UpgradeError' || error.name === 'VersionError') {
        try {
          console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·...');
          await dexieDb.delete();
          await dexieDb.open();
          console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
          return this.getAllPurchaseOrders();
        } catch (retryError: any) {
          console.error('ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', retryError);
          return [];
        }
      }
      
      return [];
    }
  },

  /**
   * Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡
   * @param poNumber Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
   * @returns ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡
   */
  async getPurchaseOrderWithDetails(poNumber: string): Promise<{
    purchaseOrder: PurchaseOrderData | null;
    items: ItemData[];
    priceOffers: PriceOfferData[];
    excludedOffers: ExcludedOfferData[];
  }> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
      const cacheKey = `details_${poNumber}`;
      const cached = dbCache.get(cacheKey);
      if (cached) return cached;
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ
      const [purchaseOrder, items, priceOffers, excludedOffers] = await Promise.all([
        dexieDb.purchase_orders.where('po_number').equals(poNumber).first(),
        dexieDb.items.where('po_id').equals(poNumber).toArray(),
        dexieDb.priceOffers.where('po_id').equals(poNumber).toArray(),
        dexieDb.excludedOffers.where('po_id').equals(poNumber).toArray()
      ]);
      
      const result = {
        purchaseOrder: purchaseOrder || null,
        items,
        priceOffers,
        excludedOffers
      };
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      dbCache.set(cacheKey, result);
      
      return result;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„Ù‡:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (error.name === 'UpgradeError' || error.name === 'VersionError') {
        try {
          console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·...');
          await dexieDb.delete();
          await dexieDb.open();
          console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
          return this.getPurchaseOrderWithDetails(poNumber);
        } catch (retryError: any) {
          console.error('ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', retryError);
          return {
            purchaseOrder: null,
            items: [],
            priceOffers: [],
            excludedOffers: []
          };
        }
      }
      
      return {
        purchaseOrder: null,
        items: [],
        priceOffers: [],
        excludedOffers: []
      };
    }
  },

  /**
   * Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   * @returns ÙƒØ§Ø¦Ù† JSON ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   */
  async backupDatabase(): Promise<string> {
    try {
      console.log('Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
      const [purchaseOrders, items, priceOffers, excludedOffers] = await Promise.all([
        dexieDb.purchase_orders.toArray(),
        dexieDb.items.toArray(),
        dexieDb.priceOffers.toArray(),
        dexieDb.excludedOffers.toArray()
      ]);
      
      const backup = {
        purchaseOrders,
        items,
        priceOffers,
        excludedOffers,
        timestamp: new Date().toISOString(),
        version: 310,
        metadata: {
          totalPurchaseOrders: purchaseOrders.length,
          totalItems: items.length,
          totalPriceOffers: priceOffers.length,
          totalExcludedOffers: excludedOffers.length
        }
      };
      
      console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
      return JSON.stringify(backup);
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      throw error;
    }
  },

  /**
   * Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
   * @param backupData Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
   * @returns true Ø¥Ø°Ø§ ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ false ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
   */
  async restoreDatabase(backupData: string): Promise<boolean> {
    try {
      console.log('Ø¨Ø¯Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');
      
      const backup = JSON.parse(backupData);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      if (!backup.purchaseOrders || !backup.priceOffers || !backup.excludedOffers || !backup.items) {
        throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©: Ø¨Ø¹Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…ÙÙ‚ÙˆØ¯Ø©');
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø±
      if (backup.version && backup.version > 310) {
        throw new Error(`Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (${backup.version}) ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 310`);
      }
      
      // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      await dexieDb.transaction('rw', [
        dexieDb.purchase_orders, 
        dexieDb.items, 
        dexieDb.priceOffers, 
        dexieDb.excludedOffers
      ], async () => {
        await dexieDb.purchase_orders.clear();
        await dexieDb.items.clear();
        await dexieDb.priceOffers.clear();
        await dexieDb.excludedOffers.clear();
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        await dexieDb.purchase_orders.bulkPut(backup.purchaseOrders);
        await dexieDb.items.bulkPut(backup.items);
        await dexieDb.priceOffers.bulkPut(backup.priceOffers);
        await dexieDb.excludedOffers.bulkPut(backup.excludedOffers);
      });
      
      // Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
      dbCache.clear();
      console.log('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      console.log('Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø©:', backup.metadata);
      
      return true;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      return false;
    }
  },

  /**
   * Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
   * @returns true Ø¥Ø°Ø§ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ØŒ false ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
   */
  async resetDatabase(): Promise<boolean> {
    try {
      console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©...');
      await dexieDb.delete();
      console.log('ØªÙ… Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      
      // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await dexieDb.open();
      console.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      
      // Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      dbCache.clear();
      
      return true;
    } catch (error: any) {
      console.error('ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      return false;
    }
  },

  /**
   * Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù„Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±)
   * Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¶Ø§ÙØ© Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
   * @returns Ù…ØµÙÙˆÙØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡
   */
  async listAllPurchaseOrders(): Promise<PurchaseOrderData[]> {
    return this.getAllPurchaseOrders();
  },

  /**
   * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
   * @param poNumber Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
   * @param transactionNumber Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
   * @returns ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   */
  async checkDuplicatePurchaseOrder(poNumber: string, transactionNumber: string): Promise<{
    dataExists: boolean;
    isDuplicate: boolean;
    message: string;
    details?: {
      existingByPO?: boolean;
      existingByTransaction?: boolean;
    };
  }> {
    try {
      console.log(`Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±: PO=${poNumber}, Transaction=${transactionNumber}`);
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙˆØ§Ø²ÙŠ
      const [existingByPO, existingByTransaction] = await Promise.all([
        this.getPurchaseOrder(poNumber),
        this.getPurchaseOrderByTransaction(transactionNumber)
      ]);
      
      if (existingByPO && existingByTransaction) {
        return {
          dataExists: true,
          isDuplicate: true,
          message: 'ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©',
          details: {
            existingByPO: true,
            existingByTransaction: true
          }
        };
      } else if (existingByPO) {
        return {
          dataExists: true,
          isDuplicate: false,
          message: 'ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ„ÙƒÙ† Ø¨Ø±Ù‚Ù… Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø®ØªÙ„Ù',
          details: {
            existingByPO: true,
            existingByTransaction: false
          }
        };
      } else if (existingByTransaction) {
        return {
          dataExists: true,
          isDuplicate: false,
          message: 'ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆÙ„ÙƒÙ† Ø¨Ø±Ù‚Ù… Ø·Ù„Ø¨ Ù…Ø®ØªÙ„Ù',
          details: {
            existingByPO: false,
            existingByTransaction: true
          }
        };
      }
      
      return {
        dataExists: false,
        isDuplicate: false,
        message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØ±Ø±Ø©'
      };
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      return {
        dataExists: false,
        isDuplicate: false,
        message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±'
      };
    }
  },

  /**
   * ØµÙŠØ§Ù†Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙÙ‡Ø§Ø±Ø³)
   * @returns true Ø¥Ø°Ø§ ØªÙ…Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­
   */
  async maintainDatabase(): Promise<boolean> {
    try {
      console.log('Ø¨Ø¯Ø¡ ØµÙŠØ§Ù†Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ÙÙ‡Ø§Ø±Ø³
      const testCount = await dexieDb.purchase_orders.count();
      console.log(`Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${testCount}`);
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
      await dexieDb.close();
      await dexieDb.open();
      
      console.log('ØªÙ…Øª ØµÙŠØ§Ù†Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      return true;
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØµÙŠØ§Ù†Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error.stack);
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
      try {
        console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†...');
        return this.resetDatabase();
      } catch (resetError) {
        console.error('ÙØ´Ù„ Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', resetError);
        return false;
      }
    }
  },

  /**
   * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   * @returns Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­ÙˆÙ„ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
   */
  async getDatabaseStats(): Promise<{
    purchaseOrders: number;
    items: number;
    priceOffers: number;
    excludedOffers: number;
    lastBackup?: string;
  }> {
    try {
      const [purchaseOrders, items, priceOffers, excludedOffers] = await Promise.all([
        dexieDb.purchase_orders.count(),
        dexieDb.items.count(),
        dexieDb.priceOffers.count(),
        dexieDb.excludedOffers.count()
      ]);
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      let lastBackup: string | undefined;
      try {
        const backupData = await this.backupDatabase();
        const backup = JSON.parse(backupData);
        lastBackup = backup.timestamp;
      } catch {
        // ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
      }
      
      return {
        purchaseOrders,
        items,
        priceOffers,
        excludedOffers,
        lastBackup
      };
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      return {
        purchaseOrders: 0,
        items: 0,
        priceOffers: 0,
        excludedOffers: 0
      };
    }
  }
};

// ==============================
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© (Global Error Handlers)
// ==============================

/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ø£Ø®Ø·Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
 */
window.addEventListener('unhandledrejection', (event) => {
  const error = event.reason as Error;
  
  if (error.name === 'QuotaExceededError') {
    console.error('Ø®Ø·Ø£: Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„ÙŠØ©');
    alert('Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©. ÙŠØ±Ø¬Ù‰ Ù…Ø³Ø­ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø²ÙŠØ§Ø¯Ø© Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†.');
  } else if (error.name === 'InvalidStateError') {
    console.error('Ø®Ø·Ø£: Ø­Ø§Ù„Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
    db.resetDatabase();
  } else {
    console.error('Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
  }
});

// ==============================
// ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù†Ù…Ø·Ø°Ø¬ÙŠØ© (ES Module)
// ==============================

export default db;

; ======================================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ø³Ø¹ ØµÙØ­Ø© numberToWords.ts

// purchases_alamin7\src\utils\numberToWords.ts
; =========================================================================================
// Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ù† 1 Ø¥Ù„Ù‰ 19
const arabicOnes = [
  '', 'ÙˆØ§Ø­Ø¯', 'Ø§Ø«Ù†Ø§Ù†', 'Ø«Ù„Ø§Ø«Ø©', 'Ø£Ø±Ø¨Ø¹Ø©', 'Ø®Ù…Ø³Ø©', 
  'Ø³ØªØ©', 'Ø³Ø¨Ø¹Ø©', 'Ø«Ù…Ø§Ù†ÙŠØ©', 'ØªØ³Ø¹Ø©', 'Ø¹Ø´Ø±Ø©', 
  'Ø£Ø­Ø¯ Ø¹Ø´Ø±', 'Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±', 'Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±', 'Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø®Ù…Ø³Ø© Ø¹Ø´Ø±', 
  'Ø³ØªØ© Ø¹Ø´Ø±', 'Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±', 'ØªØ³Ø¹Ø© Ø¹Ø´Ø±'
];

// Ø§Ù„Ø¹Ø´Ø±Ø§Øª Ù…Ù† 20 Ø¥Ù„Ù‰ 90
const arabicTens = [
  '', '', 'Ø¹Ø´Ø±ÙˆÙ†', 'Ø«Ù„Ø§Ø«ÙˆÙ†', 'Ø£Ø±Ø¨Ø¹ÙˆÙ†', 'Ø®Ù…Ø³ÙˆÙ†', 
  'Ø³ØªÙˆÙ†', 'Ø³Ø¨Ø¹ÙˆÙ†', 'Ø«Ù…Ø§Ù†ÙˆÙ†', 'ØªØ³Ø¹ÙˆÙ†'
];

// Ø§Ù„Ù…Ø¦Ø§Øª Ù…Ù† 100 Ø¥Ù„Ù‰ 900
const arabicHundreds = [
  '', 'Ù…Ø§Ø¦Ø©', 'Ù…Ø§Ø¦ØªØ§Ù†', 'Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©', 'Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø®Ù…Ø³Ù…Ø§Ø¦Ø©', 
  'Ø³ØªÙ…Ø§Ø¦Ø©', 'Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©', 'ØªØ³Ø¹Ù…Ø§Ø¦Ø©'
];

// Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø¢Ù„Ø§ÙØŒ Ù…Ù„Ø§ÙŠÙŠÙ†ØŒ Ø¥Ù„Ø®)
const arabicGroups = [
  '', 'Ø£Ù„Ù', 'Ù…Ù„ÙŠÙˆÙ†', 'Ù…Ù„ÙŠØ§Ø±', 'ØªØ±ÙŠÙ„ÙŠÙˆÙ†'
];

// Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
const subCurrencyNames = {
  'Ø±ÙŠØ§Ù„': 'ÙÙ„Ø³',
  'Ø¯ÙˆÙ„Ø§Ø±': 'Ø³Ù†Øª',
  'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ': 'Ù‡Ù„Ù„Ù‡',
  'ÙŠÙˆØ±Ùˆ': 'Ø³Ù†Øª'
};

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ø¹ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù
 * @param number Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙ†Ø³ÙŠÙ‚Ù‡
 * @returns Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù
 */
export function formatNumberWithCommas(number: number): string {
  if (number === null || number === undefined || isNaN(number as any)) return '';
  const rounded = Math.round((Number(number) + Number.EPSILON) * 100) / 100; // ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„Ù‰ Ù…Ù†Ø²Ù„ØªÙŠÙ†
  return rounded.toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

// ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø®Ø§Ù… Ø¥Ù„Ù‰ Ù…Ù†Ø²Ù„ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ† Ø¨Ø¯ÙˆÙ† ÙÙˆØ§ØµÙ„ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„)
export function toFixed2Raw(value: string | number): string {
  const num = typeof value === 'string' ? Number(value.replace(/,/g, '')) : Number(value);
  if (isNaN(num)) return '';
  return (Math.round((num + Number.EPSILON) * 100) / 100).toFixed(2);
}

/**
 * ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ø¹Ø±Ø¨ÙŠØ©
 * @param number Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡
 * @param currency Ø§Ù„Ø¹Ù…Ù„Ø© (Ø±ÙŠØ§Ù„ØŒ Ø¯ÙˆÙ„Ø§Ø±ØŒ Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠØŒ ÙŠÙˆØ±Ùˆ)
 * @returns Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø±Ù‚Ù…
 */
export function convertNumberToArabicWords(number: number, currency: string = 'Ø±ÙŠØ§Ù„'): string {
  if (number === 0) return `ØµÙØ± ${currency}`;
  
  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ù„ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù†Ø²Ù„ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ† Ø¨Ø§Ù„Ø¶Ø¨Ø·
  const formattedNum = number.toFixed(2);
  const [integerPart, decimalPart] = formattedNum.split('.');
  
  let result = '';
  let groupCount = 0;
  const groups = [];
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù† 3 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
  for (let i = integerPart.length; i > 0; i -= 3) {
    const start = Math.max(0, i - 3);
    const groupValue = parseInt(integerPart.substring(start, i));
    
    if (groupValue > 0) {
      const groupName = arabicGroups[groupCount];
      groups.push(`${convertGroupToArabicWords(groupValue)} ${groupName}`.trim());
    }
    
    groupCount++;
  }
  
  // Ø±Ø¨Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø­Ø±Ù "Ùˆ"
  if (groups.length > 1) {
    result = groups.reverse().join(' Ùˆ ');
  } else if (groups.length === 1) {
    result = groups[0];
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„Ø©
  result = result.trim() + ` ${currency}`;
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ø´Ø±ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ØµÙØ±Ø§Ù‹
  if (parseInt(decimalPart) > 0) {
    const subCurrency = subCurrencyNames[currency as keyof typeof subCurrencyNames] || 'ÙÙ„Ø³';
    result += ` Ùˆ ${convertGroupToArabicWords(parseInt(decimalPart))} ${subCurrency}`;
  }
  
  return result.trim();
}

/**
 * ØªØ­ÙˆÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø£Ù‚Ù„ Ù…Ù† 1000) Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ø¹Ø±Ø¨ÙŠØ©
 * @param number Ø§Ù„Ø±Ù‚Ù… (Ø£Ù‚Ù„ Ù…Ù† 1000)
 * @returns Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø±Ù‚Ù…
 */
function convertGroupToArabicWords(number: number): string {
  if (number === 0) return '';
  if (number < 20) return arabicOnes[number];
  
  if (number < 100) {
    const ones = number % 10;
    const tens = Math.floor(number / 10);
    
    if (ones === 0) {
      return arabicTens[tens];
    } else {
      return `${arabicOnes[ones]} Ùˆ ${arabicTens[tens]}`;
    }
  }
  
  const hundreds = Math.floor(number / 100);
  const remainder = number % 100;
  
  if (remainder === 0) {
    return arabicHundreds[hundreds];
  } else {
    return `${arabicHundreds[hundreds]} Ùˆ ${convertGroupToArabicWords(remainder)}`;
  }
}

; ======================================================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ø´Ø± ØµÙØ­Ø© excel.ts
// purchases_alamin7-copy5\src\utils\excel.ts
; =========================================================================================
import { read, utils } from 'xlsx';

// ÙƒØ§Ø´ Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù…Ù„Ù Ø£ØµÙ†Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… (items.xlsx)
let itemsCatalogCache: { code: string; name: string }[] | null = null;
let itemsCatalogLoading: Promise<{ code: string; name: string }[] | null> | null = null;

export const excelUtils = {
  /**
   * Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ JSON
   * @param file Ù…Ù„Ù Excel
   * @returns Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ØµÙˆØ±Ø© JSON
   */
  async readExcelFile(file: File) {
    try {
      const data = await file.arrayBuffer();
      const workbook = read(data);
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = utils.sheet_to_json(worksheet, { raw: false });

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù…
      if (!jsonData[0] || !('Ø§Ù„Ø±Ù‚Ù…' in jsonData[0])) {
        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù…Ù„Ù');
      }

      return jsonData;
    } catch (error) {
      throw error;
    }
  },

  /**
   * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©
   * @param data Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù…Ù† Excel
   * @param poNumber Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
   * @returns Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
   */
  extractPurchaseOrder(data: any[], poNumber: string) {
    // ØªØ­ÙˆÙŠÙ„ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¥Ù„Ù‰ Ù†Øµ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    const searchNumber = poNumber.toString().trim();
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
    const matchingRows = data.filter(row => {
      const rowNumber = row['Ø§Ù„Ø±Ù‚Ù…']?.toString().trim();
      return rowNumber === searchNumber;
    });

    if (matchingRows.length === 0) {
      throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ù„Ù');
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ù…Ù„Ù
    const items = matchingRows.map((row, index) => ({
      id: `item-${index}`,
      name: row['Ø§Ù„Ø¨ÙŠØ§Ù†'] || '',
      quantity: parseFloat(row['Ø§Ù„ÙƒÙ…ÙŠØ©']) || 0,
      unit: row['ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³'] || '',
      selected: true, // ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
      lineNumber: row['Ø§Ù„Ø³Ø·Ø±'] || row['Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø±'] || (index + 1) // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø£Ùˆ ØªØ±Ù‚ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒØ¨Ø¯ÙŠÙ„
    }));

    return {
      po_number: searchNumber,
      beneficiary: matchingRows[0]['Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©'] || '',
      transaction_number: matchingRows[0]['Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©'] || '',
      purchaseMethod: matchingRows[0]['Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡'] || '',
      items: items
    };
  },

  /**
   * Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø±Øµ (Ù„Ø¨ÙŠØ¦Ø© Electron ÙÙ‚Ø·)
   * @param filePath Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù„Ù
   */
  async readExcelFromPath(filePath: string) {
    try {
      // ÙÙŠ Electron Ù…Ø¹ ØªÙ…ÙƒÙŠÙ† nodeIntegration ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… require Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      const fs = (window as any)?.require ? (window as any).require('fs') : null;
      if (!fs) {
        throw new Error('Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }
      const data: Buffer = fs.readFileSync(filePath);
      const workbook = read(data);
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = utils.sheet_to_json(worksheet, { raw: false });

      return jsonData as any[];
    } catch (error) {
      throw error;
    }
  },

  /**
   * ØªØ­Ù…ÙŠÙ„ ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ù† Ù…Ù„Ù items.xlsx Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ electron Ù…Ø¹ ÙƒØ§Ø´ Ø¯Ø§Ø®Ù„ÙŠ
   * ÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†: Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ (Packaged).
   * ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠÙ†: "Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù" Ùˆ"Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù".
   */
  async loadItemsCatalogFromApp(): Promise<{ code: string; name: string }[] | null> {
    try {
      if (itemsCatalogCache) return itemsCatalogCache;
      if (itemsCatalogLoading) return itemsCatalogLoading;

      const nodeReq = (window as any)?.require;
      if (!nodeReq) {
        console.warn('nodeIntegration ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„. Ù„Ù† ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¨Ø§Ø´Ø±Ø©.');
        return null;
      }
      const path = nodeReq('path');
      const processRef = (window as any).process;

      // Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø±Ø´Ø­Ø©: dev Ùˆ production
      const candidates: string[] = [];
      const cwd = processRef?.cwd?.() || '';
      const resourcesPath = processRef?.resourcesPath || '';

      if (cwd) {
        candidates.push(path.join(cwd, 'electron', 'items.xlsx'));
      }
      if (resourcesPath) {
        candidates.push(path.join(resourcesPath, 'electron', 'items.xlsx'));
      }

      // Ø£ÙˆÙ„ Ù…Ø³Ø§Ø± ØµØ§Ù„Ø­
      let rows: any[] | null = null;
      for (const p of candidates) {
        try {
          const data = await excelUtils.readExcelFromPath(p);
          rows = data;
          break;
        } catch {
          // Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ù…Ø±Ø´Ø­ Ø§Ù„ØªØ§Ù„ÙŠ
        }
      }

      if (!rows || !rows.length) {
        console.warn('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ items.xlsx Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:', candidates);
        return null;
      }

      // ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ø²ÙˆØ§Ø¬ code/name ÙˆÙÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
      const mapped = rows.map(r => ({
        code: (r['Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù'] || '').toString().trim(),
        name: (r['Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù'] || '').toString().trim(),
      })).filter(r => r.code && r.name);

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±
      const seen = new Set<string>();
      const unique: { code: string; name: string }[] = [];
      for (const r of mapped) {
        if (!seen.has(r.code)) {
          seen.add(r.code);
          unique.push(r);
        }
      }

      itemsCatalogCache = unique;
      return unique;
    } catch (e) {
      console.warn('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ø£ØµÙ†Ø§Ù:', e);
      return null;
    }
  },

  /**
   * Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø­Ø³Ø¨ Ø§Ù„Ø±Ù…Ø² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´. ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„ Ù…Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
   */
  // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙ†Ù Ø¨Ø§Ù„Ø±Ù…Ø²
  async getItemNameByCode(code: string): Promise<string | undefined> {
    if (!code || !code.trim()) return undefined;
    if (!itemsCatalogCache) {
      await excelUtils.loadItemsCatalogFromApp();
    }
    const c = code.trim();
    const found = itemsCatalogCache?.find(x => x.code === c);
    return found?.name || undefined;
  }
};

; ==============================================================
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø± ØµÙØ­Ø© validation
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// src/utils/validation.ts
; ==================================================================
/**
 * Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø­Ù‚ÙˆÙ„
 */

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
export const validatePONumber = (poNumber: string): { isValid: boolean; message: string } => {
  if (!poNumber || poNumber.trim() === '') {
    return { isValid: false, message: 'Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø·Ù„ÙˆØ¨' };
  }
  
  if (poNumber.length < 3) {
    return { isValid: false, message: 'Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' };
  }
  
  return { isValid: true, message: '' };
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
export const validateTransactionNumber = (transactionNumber: string): { isValid: boolean; message: string } => {
  if (!transactionNumber || transactionNumber.trim() === '') {
    return { isValid: false, message: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø·Ù„ÙˆØ¨' };
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙˆØ´Ø±Ø·Ø§Øª ÙÙ‚Ø·
  const pattern = /^[0-9-]+$/;
  if (!pattern.test(transactionNumber)) {
    return { isValid: false, message: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙˆØ´Ø±Ø·Ø§Øª ÙÙ‚Ø·' };
  }
  
  return { isValid: true, message: '' };
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº
export const validateAmount = (amount: number): { isValid: boolean; message: string } => {
  if (!amount || amount <= 0) {
    return { isValid: false, message: 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±' };
  }
  
  if (amount > 999999999) {
    return { isValid: false, message: 'Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹' };
  }
  
  return { isValid: true, message: '' };
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯
export const validateVendorName = (vendorName: string): { isValid: boolean; message: string } => {
  if (!vendorName || vendorName.trim() === '') {
    return { isValid: false, message: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…Ø·Ù„ÙˆØ¨' };
  }
  
  if (vendorName.length < 2) {
    return { isValid: false, message: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' };
  }
  
  return { isValid: true, message: '' };
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
export const validateExchangeRate = (rate: number, currency: string): { isValid: boolean; message: string } => {
  if (currency === 'Ø±ÙŠØ§Ù„') {
    return { isValid: true, message: '' };
  }
  
  if (!rate || rate <= 0) {
    return { isValid: false, message: 'Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©' };
  }
  
  if (rate > 10000) {
    return { isValid: false, message: 'Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ø§Ù‹' };
  }
  
  return { isValid: true, message: '' };
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶
export const validatePriceOffer = (offer: any): { isValid: boolean; errors: string[] } => {
  const errors: string[] = [];
  
  const vendorValidation = validateVendorName(offer.vendor);
  if (!vendorValidation.isValid) {
    errors.push(vendorValidation.message);
  }
  
  const amountValidation = validateAmount(offer.amount);
  if (!amountValidation.isValid) {
    errors.push(amountValidation.message);
  }
  
  if (!offer.currency) {
    errors.push('Ø§Ù„Ø¹Ù…Ù„Ø© Ù…Ø·Ù„ÙˆØ¨Ø©');
  }
  
  const exchangeValidation = validateExchangeRate(offer.exchangeRate, offer.currency);
  if (!exchangeValidation.isValid) {
    errors.push(exchangeValidation.message);
  }
  
  if (offer.taxIncluded === undefined || offer.taxIncluded === null) {
    errors.push('Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ Ù…Ø·Ù„ÙˆØ¨Ø©');
  }
  
  return {
    isValid: errors.length === 0,
    errors
  };
};

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù
 */
export const validateOfferAmountConsistency = (
  offerTotal: number, 
  lineItemsTotal: number, 
  tolerance: number = 1
): { isConsistent: boolean; difference: number; message: string } => {
  const difference = Math.abs(offerTotal - lineItemsTotal);
  const isConsistent = difference < tolerance;
  
  return {
    isConsistent,
    difference,
    message: isConsistent 
      ? 'Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…ØªØ·Ø§Ø¨Ù‚Ø©' 
      : `ÙŠÙˆØ¬Ø¯ ÙØ§Ø±Ù‚ Ù‚Ø¯Ø±Ù‡ ${difference.toFixed(2)} Ø¨ÙŠÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù`
  };
};

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø³ÙŠØ©
 */
export const validateAwardedItems = (lineItems: any[]): { isValid: boolean; errors: string[] } => {
  const errors: string[] = [];
  
  const awardedItems = lineItems.filter(item => item.awarded || (item.awardedQty || 0) > 0);
  
  if (awardedItems.length === 0) {
    errors.push('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡Ø§');
  }
  
  awardedItems.forEach(item => {
    if (!item.awardedQty || item.awardedQty <= 0) {
      errors.push(`ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…ÙŠØ© Ø§Ù„ØªØ±Ø³ÙŠØ© Ù„Ù„Ø³Ø·Ø± ${item.lineNumber}`);
    }
    
    if (item.awardedQty > item.requestedQty) {
      errors.push(`ÙƒÙ…ÙŠØ© Ø§Ù„ØªØ±Ø³ÙŠØ© Ù„Ù„Ø³Ø·Ø± ${item.lineNumber} ØªØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©`);
    }
  });
  
  return {
    isValid: errors.length === 0,
    errors
  };
};